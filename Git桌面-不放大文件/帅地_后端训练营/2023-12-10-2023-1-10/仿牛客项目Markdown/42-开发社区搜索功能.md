42-开发社区搜索功能.mp4

这节课我们来开发搜索功能，那么在开发搜索功能的时候，我们正好就要用上我们刚刚所学的 e list的社区，那么在开发这个功能的时候，我们大概要开发三个方面的内容，第一方面写服务层的逻辑，我们需要提供搜索相关的服务，或者说搜索相关的业务。

具体来说是这样的，当我们添加一个帖子的时候，发布一个帖子的时候，我们应该把新的帖子存到es服务器里，所以我们的搜索服务的组件里应该提供这样一个存储的。

方法。

再一个那么如果说我们删帖子，我们也应该从一s服务器把这个帖子删掉。当然了我们现在删帖的功能还没有实现，但是我们在开发搜索服务的时候，先把从es服务器删帖的方法先准备好，然后以后可以直接调用。

然后第三个就是重点就是我们要在组件里提供一个搜索的服务搜帖子好，这是第一方面，那么这个业务层我们处理完以后，接下来我们要处理表现层，首先我们需要解决这些帖子，什么时候增什么时候删，这样一个问题，我们采用事件的方式去处理。

发布帖子的时候，我们采用异步的方式把这个帖子提交到es服务器，然后还有增加评论的时候，那么增加评论以后，帖子的评论数量就会发生变化，这个时候我们也将帖子一步的提交到一s服务器，相当于这是一个修改了帖子。

当然了我们采用异步的方式，主要是为了提高性能。你这样当我们发了一个帖子以后，我只要把这个事件丢到消息队列里，我们就可以继续处理下一个类似的请求，对吧？就不用等待，所以说异步的它可以并行的去处理一些事情，这样比较好。

既然是异步的话，我们把在增发布帖子时，在增加评论时触发了这样的一个事件，我们需要在消费者组件里加一个方法来消费这个事件，这是我们需要基于事件来做的一些处理。

好，那么当我们把这个数据同步到了es服务器以后，剩下的就是查询了查询的时候，我们要想显示出搜索结果，我们需要在CTRL那里处理搜索请求，然后在对应的 Html里显示这个结果，这个就容易了。

好，总之我们整个功能的关键其实集中在前两个部分提供搜索的业务，然后对于事件要做出相应的处理就好了。

好，下面我们就开始写代码来实现搜索的功能。

首先我想先解决一个小的遗留的问题，当然目前这个问题还没有表现出来，但是如果说我们任由它摆在我们这个功能开发完以后就会表现出来，所以我提前把它先解决一下，这是之前没有没有注意到的一个小小的环节，主要是 map的配置文件，discus，post map，然后这里边我们不是写过增加帖子的方法，对吧？

这个方法你看我少了一个东西，少了一个 p图片，那么如果你不声明t party， my business就不知道你这个表你增加的时候哪个是主键，然后就会有一个问题，他增加完以后它不会把生成的主键存到你实体类当中去，所以后面如果你实体类想要用到组件，没有，而我们后面处理这个事件恰恰是要用到 ID，所以说这里需要稍微处理一下，但我需要写上的 k等于ID解决小的问题。

好了。

下面我们开始正式的去开发我们刚才所说的这些内容，首先我们要处理业务层，那么我在 service目录下，我新建一个新建一个service组件，因为那是搜索，而且是基于伊莱斯txt的搜索，所以组件我取名叫伊莱斯特设计。

然后。

 service，那么我需要给它加上一个service注解，另外把我需要的用到的b注入进来，那么因为我们这是要往 es服务器里存，这个帖子相关的数据我就可以用到上我们所写的 disk as post repos的人。

咱们。

不是。

写完了吗？好。

我们就利用组件，然后除此以外，我们在搜索的时候，我们肯定是要将结果当中带上高亮显示的那些个字段的。上节课我们学es也知道，我们要想高亮显示我们还得用到 e list template对吧？所以我把 Template住进来， estate，search，template，

我把这个变量给它起的简短一点，也稍微短一点，不然太长。

好了，那么有了这两个病以后，我就可以去实现我刚才所说的那几个方法。首先我需要提供一个方法，能够向 es服务器里提交新产生的帖子，那么这个方法公有的不需要返回值，方法名我叫save，然后 discuss post。好，那么当你save的时候，很显然你得把帖子的数据把实体传进来，怎么去增加？我们上节课在测试类里演示了非常简单是吧？就discard repository点c只有一个，好这就可以了，非常easy，然后还要提供删除，修改不用，因为你再save一次，就是修改，删除需要提供一下，然后将来好用删除。

我叫delete this。

 cast post需要你传入 ID，那么我还是调discourse，reporter，然后点delete by ID，这就可以了。

好，最后我们需要提供一个搜索方法，public，然后我们上节课学过的就是演示过搜索，那么我们搜索以后它能够给我返回一个配置类型的数据，然后里边封装了多条，这个帖子我就直接返回这个值配置。

但。

这个配置不是我们的配置，是 spring他给我们提供了一个类型配置，然后里边封装的是帖子的实体，然后这个方法我就要search this cast pose，搜索帖子。

好，那么你搜索帖子的时候，你肯定是要传入你搜索的一个关键字，我叫key word。另外因为我们搜索是支持分页的，你要传输分页条件，那么你要传入当前，你要显示第几页？

 Carry的表示的是当前是第几页的意思，我们之前写的分页都是传一个offset，它是offset是左眼不是第几页 discourse reporter或者 time内的在分析查询的时候，它需要这样一个参数，所以说我们就变通一下。传的是carry的，然后还有每页显示多少条数据 Limit。

好，那么这个方法中的查询的逻辑，我们没有必要再从头开始写一遍，咱们直接打开我们上次课的测试方法，把代码拷过来，在此基础上稍微改一改就可以了，因为这个代码太长了，然后写一遍也不白写，那么那个测试类叫做。

 elastic shirt tests。

好，那么就是最后一个方法里的逻辑，当然 system out输出不需要，我只需要把之前的拷过来，拷过来以后还得改一改，咱们从头往后理一理，首先是构造查询的对象，查询条件，这里边就不能把这个条件写死成寒冬了，互联网寒冬了，你应该是写这个参数，key word对吧？

然后我们查询我们搜索的字段依然是开头和counter，因为还是这个帖子数据，那帖子我们搜的就是title content，然后排序依然是优先按照tap排，如果tap一样再按照分数排，如果分数也一样，就按照时间排都是倒序不动。

另外我们要分页，这个分页条件不能写死，第一个条件是当前页carry，注意 carry从零开始，我们传的时候要注意这一点。

第二个是每页显示多少条数据，就是limit变成替换就好了。

最后整个高亮显示之前我也说了，前后加上一个特殊的标签，但这个标签由你来定，那么我们加em就可以，我们在搜索页面上已经其实不是搜索页面了，我们是整个个logo点css里边对 em标签做了定义，em标签显示为红色，所以说你加em它就会显示为红色就可以了。

好，这个条件就这样就行。

然后我们看查询的逻辑，那么返回的最终的数据，最终的数据，其实我们可以直接这样，我可以直接return，我可以直接return，然后瑞特 carry for配置。然后这个是传的条件，分别是e list，take search，然后的话类型以及伪造的map不动。然后再往下看，在这个方法的实现的过程中，我们首先得获取命中的数据对它做了判断，这都没问题。

然后我实例化的一个集合在集合之内我实例化的一个实体，然后根据命中的数据去构造实体，把它放到集合里，最终返回这里，因为我们访的还是帖子，所以说这些字段名字都不用动，整个逻辑就这样就可以了，高亮显示对于title和content也是一模一样的，处理方式也不用动，那么最终return的值也是这样去构造的，没有问题就这样了。

好就这样了，那么这个方法我们经过上次课的代码的改动以后很快就实现完了。好，那么当前我们业务层这个代码就已经搞定了，下面就是要处理。表现层刚才我们也说了，我们主要是要用事件的方式，用一部的方式去向es服务器当中同步数据，这样效率高。

我也说了我们是在两个地方去同步数据，目前来说发布帖子时还有增加评论时，删除帖子目前还没做，先不管，我就在这两个点去触发一个发帖事件就可以了，把这个帖子把这个事件加到队列里就可以了。

那么我们找到了这两个位置，首先发布帖子，我们可以找 Discourse很抽了。好。发个帖子不就是这个方法对吧？在这个方法的后面，当我把帖子发布成功以后，这个时候我应该触发发帖事件，然后把新发布的帖子存到一s服务器里，对吧？应该是做这样的操作，那么我就实例先创建一个事件对象， You want。

等于6in mind。

然后点sat topic。

这个发帖事件我们还没有定义常量，我还得定义一下，好，我在这儿加一个主题发帖，topic tablets。Ok然后回过头来，所以我这个主题就是topic，public之后我们要设置 user，ID是谁触发的事件，那应该是谁呢？当前的登录用户 user点get ID。好，然后还得设置安TT态度，实体类型。那么你这个事件是关于哪个实体的？

我们是关于帖子的安推 Tag post，还有在site int ID，实体的ID，实体ID就是帖子ID，post点 get ID，为什么刚才我要修正小的问题，因为你看郑家湾帖子，这里我不是要用帖子来ID对吧？如果不修正的话，这就会有一个问题，所以说修正一下之后这块就没问题了。当然了其实还有安推优的ID，但是我们发布帖子的事件里其实用不上这个数据，我就不去获取它了。

因为毕竟获取的还是有点麻烦，一还得做一步多一步，我不去取了用不上就算了。然后我要触发这个事件，我就调调 In one to producer，我需要把它注入进来之前还没有注入。

好，那么注入以后，在这个位置in mand producer，然后 fare in慢把你们的对象传入，这个事件就被触发了，完成以后还有一个地方也需要处理。我们发布评论的时候，当我们评论帖子的时候，那么评论帖子以后，我们会修改帖子的评论数量，那帖子就变了对吧？相当于改了帖子这个时候你还要触发一次这个事件，然后的话把帖子的 Es里的数据给它覆盖掉，其实是一个修改的行为。

好，那么发布评论我们去找comment controller第一个方法爱的comment就是当然我们就一个方法，我们在最后触发完评论事件以后，我们再去触发发帖事件，但这里你需要判断一下，因为我们这个评论可以评论给帖子，也可以评论给回复对吧？你只有评论给帖子的时候，我们才做这样的事情。

注意判断一下，如果说 comment点get on TT type，它是等于NTT type post，是帖子的话，我们再去触发发帖事件，好，因为这个变量前面被已经有了，所以我复用一下我就不重新声明了， event等于new event，然后 topic依然是public，然后 uzid看一下uziduzid其实就是一个host，就当前的登录用户，当然你从 comment里取也可以都行，这里我就comment要get有字ID，然后实体类型是post，没问题，然后是帖子ID，那帖子ID呢它参数这些数据设计完以后设置完以后，我们触发这个事件 very much，现在这个事件已经发布了触发了，接下来我们需要做的事情就是去消费这个事件，我需要找到这个事件的消费者，invent can summer，然后我在这里增加一个新的主题，主题的处理的方式和之前有区别，所以说我们就不要继续用这个方法了，我们再新写一个方法，这个方法主要的目的是消费发帖时间写清楚，然后加上注解卡夫卡雷森的topics。等于就是发帖的主题 topic，public这样就可以了。

他只消费这一个事件一个主题，那么方法的声明为public没有返回值，然后憨豆 public method他消费的是发帖的这个消息，然后的话参数是 ok，summa，we calm，好，当然了，我们首先也需要做出类似的判断，这个消息的是不是为空格式有没有问题，也是做出同样的判断，我call一下。

那么如果说我们得到的消息非空格式也没问题，我就要处理这个事件处理非常容易，我们只要怎么说，我们只要从这个事件的消息里得到帖子ID，查到对应的这个帖子，然后的话把它存到es服务器里就可以了。

这很容易，那么首先我要怎么说，我要先查询一下这个帖子，那查询帖子我们需要调用，我们从数据库里查，我们需要调 discourse的service，我看一下我当前有没有注入，还没有补充一下。

好。

然后我们查到这个数据以后是要存到es服务器里对吧？所以说我们需要访问 es你来take service service，所以也把它注入进来。好，那么有了这两个service以后，我们继续在这儿，首先我要查询出这个帖子 discuss，post，调用discuss post service，然后饭的办ID方法。

帖子ID我们从 EMAIL的世界里可以得到很容易 EMAIL点get on，tvid其他的就不用了，其实就用这一个值就可以了。

那么有了这个帖子数据以后，我就要往这个服务器里去存了，那就依赖txt service，然后点CF把pose的传入，好这样就行了。

那么这个事件消费咱们也处理完了，最后就是从展现，当我发一个帖子，这个帖子能够同步到es服务器里，我就能够搜到它下面，我们就是做展现。

因为这是一个新的独立的功能，所以说我给它新建一个CTRL，我在 CTRL的目录下新建一个类，这个类我就叫社区，很丑了，好，那么加上很多的注解，那么我们要做查询的话，肯定是要用到e list，service先把它注入进来。

好，另外我们还要注入另外的两个service，一个是you的service，一个是like service，为啥？因为我们收到了帖子以后，我们还要展现出这个帖子的作者，还要展现出帖子点赞的数量在页面上。

所以说你想我们是不是得用到这两个service去查相关的数据，就需要我就把它注入进来，一个是user service，再来再来一个是like service，这些service都注入以后，下面我就开始实现了搜索的逻辑，我先声明它的访问路径， pass等于search。

好，然后因为是查询数据，所以请求方式我设置为get，那么方法说明一下，返回实现方法名就叫设计好，那么这个方法就是需要传入一些参数，首先你要传入的是就是你搜索的关键字key word要接收一下。

好，另外你还要分页传输分页的条件，分页条件我用我们自己封装的配置对象来接收，最后我们查到的数据需要反馈给模板，我需要用的model。

然后这里我说一下 Key word，因为我们当前不是pose的请求，是get那么get请求 key word，你就不能用请求体来传，那get请求是要么你用路径后面带问号出来，你要么是用路径中的某一级来传，我用带问号的方式来传，这样的方式，我这个路径是叫设置对吧？

然后后面问号

带上 t word等于什么？大概是这个意思，用这种方式传 T word那么算法说明完以后，下面我就来实现了，实现就比较容易，首先我就上来就搜索帖子，那搜索帖子的话，我就调in last exercise service，然后他的设置方法设置的时候我需要传入 key word，另外要传入当前是第几页配置点get carry这就是当前页。

但是我封装的配置当前也是从一开始，是从它自然的一个顺序开始，但是我们这个测试方法里要求是从0开始，所以说你要减一做一个处理，最后每页显示多少条数据是配置的get limit这样。

好，我们搜索的结果也是一个配置对象和类名冲突了，我需要是配置，因为冲突了会所以它自动的会带上包名，以免产生歧义有点长，但是也没关系。

然后这个对象中它的风格的类型是实体类 discourse post，我们得到的就是一个搜索的结果，我叫search without。

好，这个帖子我就搜索完了，搜索完以后别忘了，我这个帖子里得到的只是一个discus poss的实体，它里面包含了优质ID，我们需要我们还需要更多的user的消息，所以我们需要查 user。

另外帖子有多少点赞数量，我们也需要做查询，所以我们需要把这个数据再做一个处理，再聚合一下，我聚合数据我声明一个最终的聚合的结果是一个集合，然后的话里边分成一个map，那么这个变量名我叫discus pose，这是我最终要返回的结果，实例化一下，然后做一个判断，如果说 result。

它非空，

这个时候我们才去做进一步的处理，我需要便利，它便利的话，每次我会得到一个铁子 discuss post，好我遍历的是伪造的，好每次遍历我要实例化一个map封装聚合的数据，然后我先把这个帖子存进去写清楚，map点put post。

好把帖子存进去，其次我要存帖子的作者那就map点put user这个user我需要查 user service，点find user by ID这个u在ID我们从帖子里可以得到 post要get user ID，然后我们还需要得到点赞的数量， map点put，数量我叫like count也是查 let service，然后 find Entity like god那么实体类型是我没有实现接口，实体类型是帖子的类型，然后实体ID就是帖子ID，post点get ID这样就行了。

好，那么我得到了聚合数据map以后，我需要把它装到集合里，它好这个数据就聚合完了，聚合完以后，那么别忘了我们需要把得到的最终数据传给这个模板， model的AD，然后 discuss posts，把聚合后的数据传给页面。

另外当我们返回到这个页面的时候，我希望把刚才我所输入的关键字也把它就是设置进去，也带上这个关键字好，知道我刚才搜索的是啥，所以为了我们在页面上取关键字显示默认值方便，所以说我再把这个关键字也传给这个模板，t word。

好。

最后别忘了，我们还要设置一下分页的信息，好，能够实现分页我就配置点set pass。

那么这个路径是设置后面会带一个条件，t word别忘了，然后等于提问，然后还要设置一下一共有多少条数据，它好计算的总的页数 sat这个多少条数据，我们可以从这个数据里取，我们上课不是演示了吗？它里面封装了一共有多少条数据对吧？可以从里边取，我判断一下。如果说他万一是闹，我就认为是0条数据，如果他不是闹，我就从这里取get total。Alex。然后盖的偷偷爱你们家，他返回的是浪，但是我们赛特肉丝这里要求的是in，我们得强转一下。

好，那么设置完以后，最后那个模板在site目录下名为设置的sml好这样就行了，那么现在我就把 Kantola处理完了，处理完以后，最后就是写这个html， html首先我们需要处理的是搜索框，我们看一下，我打开今天页面看一下先其实每个页面都有搜索框，所以我们可以在 index首页上去对搜索框搜索做处理，那么其他页面都复用 head对吧？那么就都可以复用这个代码了。

所以我打开 index点html我在这里处理搜索好，我找一下搜索的框的位置在这，然后首先我声明一下请求的方式， master等于注意是盖，因为我刚才说明的是get，然后提交的路径等于这个简单就是search，这就可以了。

然后我们这里是一个文本框里的值是要提交给后台的，所以我们需要给它加一个name，取个名字 name。

Key word。

另外当我在某一个页面上输入了这个关键词以后，当我一点搜索又回到了这样一个页面，就打开了一个搜索的结果页面。

那么在搜索结果页面上，我要显示刚才我输入的条件，所以我要在这儿显示一个刚刚输入的 key word，我就用。

value。

给他一个默认值，然后。

 key word。

当然你首次访这个页面没有key word的时候，它显示为空不影响，但是你输入key word以后，那么这个就就会有一个值就可以了。

最后这是一个搜索按钮， type等于submit你一点，触发了提交数据这样就行了。

好，这个是我们搜索的条件的提交，最后还得打开 search的html我们好显示搜索的结果，我再打开这个 search点html，这个页面我们第一次处理，所以我需要从头开始对它做一个设置，先声明弹力，好，那么样式文件这里需要说明它的路径，然后黑的我们需要复用，好，那么复用完以后，中间的内容我们一会再说，这个内容先别一会再说了，这个内容其实就是一个帖子列表，对吧？

搜索结果列表还有多个li我们只要保留一个就可以了，我先把它删掉，不然碍事，好尾部不用处理，折叠起来， GS要处理一下。

好了，接下来我们就处理中间的核心区域的内容，帖子列表，很显然我们需要遍历刚才我们所搜索到的结果在li上加上th each，每次遍历我们会得到一个map，所以这个变量怎么样？我就叫map，我们遍历的集合叫做discus后4次遍历，每次遍历你看首先我们显示的是帖子的作者的头像，这个地方头像我们需要处理一下。

好，我从 map当中取 user，然后取优字的头像拍的you are，这就行了。再往后，那么这个地方这是标题，我们需要做动态的处理。好，那标题就是map，点post，取到 post，然后点开头就可以了。另外这个标题它应该有链接，能够链到帖子上去，这个链接我也处理一下。

好，那么这个链接链到应该是帖子详情页面上应该是路径中包含了一个帖子ID，所以包含一个动态的值，所以我要拼一下加上双出线。这个帖子详情页面的路径是diss pass，然后的话是detail，然后是帖子的ID，你就map点post点ID这样就行了。好，再往后这个地方显示的是帖子的内容，我就th You text map点。Post点，content，内容。

好，然后再往下看，这个地方是显示的是帖子的作者的名字，这也得改，那就是map点、user点，user name，作者的名字，然后发布于后面还得有一个帖子的发布时间太长了，我换个行。那么发布时间 Th冒号text等于。那得格式化一下是吧？这意思？

点format。

然后是map点post点create time。然后给一个时间的格式。好，然后在这儿我们要显示两个数量，一个是赞的数量，一个是回复的数量。为了写这个代码方便，我在这个数量前后加上一个标签I吧，这个是点赞的数量 Th text等于map点。

like。

 com，然后是帖子的回复的数量，帖子实体当中直接就有这个数据。

Th模号text等于是map点post，comment，count。好，然后最后别忘了还有个分页是吧？分页的区域我们可以复用首页的分页的逻辑， Ph冒号，replace等于首页。然后名字叫配置内选。

好，那么到这儿那个页面就处理完了，现在所有的代码都写完了，写完以后咱们可以最终测试一下，那么启动一下服务，当然你在启动服务之前，你要确保你的卡夫卡还有 es是要去启动的，因为我们要访问这些服务器要用到它们对吧？我这里提前已经启动好了。

好，那么我的服务已经启动完了，启动完以后咱们测一下，我先访问一下首页，访问首页以后我先不去发帖，我先去搜索，看一下能不能搜索到目前现有的数据，我们目前的话一s服务器里是有数据的，因为我们上次做测试的时候，已经把大部分数据都搬进去了，对吧？

我们可以测一下，比如说我要搜的是互联网。

寒冬。

这样一个关键词 key word，然后点搜索搜到了一些结果，然后每一页显示的是10条数据，后面的回复数量通常大部分都没有回复，然后你看这个结果这个是标题有互联网，然后内容有寒冬有互联网，这是这一段匹配的文字，他给你列出来了，他不是列出整个所有的文字是第一段匹配内容，然后你看第二这个标题没有匹配的词，但是结果里有就都有，以此类推就这样。

然后我们看下一页，当然我照的数据数据是挺多，但是其实数据大部分都一样，就这样好。一共有多少页？木页一共有12页，咱们上次测试的时候也是这样，对吧？好，我再来一个，比如说我搜的不是互联网寒冬，我搜因特网。

好像我记得这个数据里也有一些是因特网的词好搜索因特网。寒冬。寒冬是吧？带有因特网的可能比较少，带有寒冬的比较多一点，也有一些带因特网比较少，但你看到了我们这个数据是根据我的搜索的关键词会发生相应的变化，而且是匹配的，说明我搜索没有问题可以了。

但是我发一个新的帖子，我能不能立刻收到，我们也测一下，我需要登录一下。

还有问题。

信息能够然后123好我登录了，然后我需要发一个新的帖子，发一个什么就发一个跪求offer，然后就随便写说谁能给我一个offer，我给他张晓丽随便瞎写了，好写完以后发布，发布以后我能够看到我所发布的帖子，这里能看到，没有问题点个赞，然后回复一个 Hello。自己回复自己的，然后好让他有个数量，然后做了一个操作以后，咱们经过了几秒钟应该可以搜到了，因为我们只有这一条一个实践扔到队列里，他立马应该就处理了，很快就能够把数据同步到 es服务器里，我们试一下，我这回搜什么搜offer，还有显示的怎么这么恶心，搜到了是吧？

跪求offer，但头像显得太大了，别的倒是ok的就太大。我们之前的旧数据里也有什么offer，但被搜到了，因为它时间比较早，赞一恢复一，为什么这么大？我们看一下页面头像，其他的标签其实这里边写上了，在这里用内敛样式写成了宽和高都是50，但这个没写的话，所以他有的时候就就会有问题，这里写一下style，你可以参考别的地方的盈利者，就头像他都写了，就这个地方忘了，style等于。

y然后50像素，

宽50高50像素，完了就写这么一句话，样式说明宽高可以了。

好完了以后可能f9我重新编译，然后回到这个界面我再重搜一遍搜，这回就好了。

50 50好，你看我们刚刚发的数据立刻就搜到，这是一个能够实时的搜索到我最新的结果，这样一个工具非常的好用，当然也是十几页数据，因为很多都带 offer好了，那么这次课我们就利用 e list，结合着之前我们所学的消息队列，然后把搜索功能实现了这个功能，它包含了我们之前刚刚学过的两部分新的内容，那么大家做的时候一定要就多去把这两个内容多加练习，把它练熟了。好，这节课我们就演示到这里，咱们下节课再见。