51-将文件上传至云服务器.mp4

这节课我们来学习如何把文件上传到云服务器。

那么上传。

到云服务器有两种方式，一种方式是通过客户端上传，我们在网页上在表达里直接把数据提交给云服务器，而不是提交给我们的应用服务器。要改变提交的目标，我们的项目中有一个功能刚好适用于这种方式，就是用户头像的上传，咱们用户登录以后不是可以在用户设置里改头像对吧？

那么上传的时候我们可以直接将表单提交给云服务器就可以了。

然后第二种方式是服务器直传我们的应用服务器，把这个数据把文件提交给云服务器。

那么。

我们刚刚做过的功能就分享的时候，生成的图片因为是在服务端生成的，所以说如果你想把它传给云服务器，那就得通过这种方式的，所以那么一会儿我们这两种方式都会给你演示，然后我们就把这两个功能重构一下，把这两个功能所提交的文件都传到哪呢？

我们用的是七牛云的服务器。

那么当然了。

主要是从我们学习的角度来选择云服务器的，因为其中云它能免费的试用，比较方便，所以我就选择76云大家都好用。

然后。

七。

牛云它的官网是7牛.com，然后我们要用的话，你需要先对这个网站先对这个产品有所了解，我们来看一下。

好，这就是它的官网，那么如果你想使用的话，你需要先注册，然后注册的时候你需要选择这个账号的类型是个人还是企业，当然你现在需要选择的是个人的类型，然后注册好以后，你还需要进行一个实名认证，如果不进行实名认证，不能用，而实名认证的时候需要这个上传你的身份证的正反面的照片，另外还要绑定一个支付的方式，我绑定的是支付宝，所以说注册以后它有提示你要注意，然后你提交了认证的资料以后，它有一个审核的周期，理论上是三个工作日完成，但实际上是比较快的。

工作日的话也就一两个小时就搞定了，比较快。

好，那么我已经把账号提前注册好了，所以说我就直接登录了。

那么登录完以后我们可以去看一下他的手册，因为7诺云怎么用，它的API怎么调，它是有比较详细的手册，而且是中文的，所以说你自己去看也能学得会那么如果你想看手册的话，我们是在这里点好点管理控制台，然后右上方有一个文档，然后有开发者中心，在开发者中心里，那么我们用的产品它有很多产品一个系列的都有，那么我们用的是对象存储，就是纯图片纯音频视频这个都可以，我们选所以我看一下这个产品怎么用，他这是他详细的手册，这个内容比较多，他的介绍手册比较多，那么你在看的时候，我觉得大家有必要看的一个是关于产品简介里面的基本概念，你要了解这个云服务，就是对象存储它能给你提供什么样的帮助，你要有所了解。

然后你。

要看一下存储区域，它有哪些区域你选一个离你近的，这样的话上传的速度会比较快一点。

再一个你要看编程模型，就编程的时候它的一些基本的原则，或者它底层的一些基本的架构大概是怎么样的，你对它有所了解，对整个机制有一个了解。然后再看一下安全机制，那么就是我们上传资源的时候，我们需要用到两个。

两。

个k两个密钥，然后的话这怎么用的？为什么要用这两个密钥有一个介绍。最后你再看一下上传资源，就上传资源的话，它分为几种形式你要有所了解。

好，以上是对它整个产品做一个了解，那么从编码的级别的话角度来说，你最好再看一下 Sdk， DK里边有一个Java SDK，就是我们用Java语言去怎么去访问它，这里也有比较详细的介绍。

好了，这些内容就是说我们课上不去一点一点看了太长，那么大家课后可以自己。

有选择。

的去看，那么课上我会把主要的内容给你做一个演示，那么你照着我去做，也能把这个功能实现了。

好了。

我们要想使用七牛云，首先我们的选择这个产品服务，选择对象存储，点进来，这手册我得点到点回主页，这还是开发者中心，我回到这个地方就关掉了。

回到就是七牛云控制台，在控制台里你可以我们要用的是对象存储，你可以点这立即添加，立即添加什么？

添加一个对象存储的空间，你创建一个空间，好来存东西，当然你也可以这样在这点对象存储，因为我不是每次都要添加的，比如说我添加过以后下以后我就从这儿进入，所以说我习惯了在这儿进入，进入以后其实我已经创建了两个空间了，一个叫header，一个叫cell， header是用来存用户头像的这么一个空间， cell是用来存分享时生成的长图的这样一个空间。

总之你要存什么类型的数据，我们通常一种类型的资源创建一个空间。好这是我以前创的，我先不用了，我创建新的，你要想创建新的空间就点新建存储空间，然后这里边你要给空间取个名字，然后取名叫 community hide，叫这么个名字。

就是说这个空间的名字就意味着我往这个空间里要存的是用户的头像，然后你这里可以选一个存储的区域，我选华北，因为我的位置处于华北，这样的话传的速度会稍微好一点，再一个访问控制是公开的还是私有的，那么它的区别就是什么？

就是我们上传的时候一定是有限制的，但是我们读取就是传完以后资源是不是公开谁都能读，还是说只有你自己有这个密钥才能读，我希望所有人都能读。

因为我们传的图片之后，其实是每个人的头像是吧？是谁都可以访问的，这个是不做限制的公开的，然后的话点确定好这个空间创建好了，创建好以后你要注意它这里有个提示说，它会给你分配一个测试的域名，我们怎么访问这个空间，就是利用这个域名来访问，但这个域名它不是永久的，它是30天它就回收了，所以我们域名只能用30天，如果到期以后怎么办？

你再创建一个新的空间，再来一个新的域名改一下就可以了。

然后它每个域名我们试用免费使用，然后的话它是每日限总流量10g我们学习用肯定不会超过这个数量，所以说基本上就是免费的挺好的。

好，然后的话，当我们传了内容进来以后，我们可以在内容管理里在这里边有个列表能看到，现在的话我刚创立的什么都没有，所以目前没有任何内容，当然如果说你有自己的独立域名，你可以在这里绑定你的域名。

好，那基本上我们主要是通过空间的概念了解测试域名就可以了。再一个我们通过内容管理，一会能够看到这里面传过来的内容就可以好。这是创建的一个空间，我再创建一个，因为我还要存分享的生成的图片了，对吧？再创建一个我觉得挺牛，那天。虽然然后我还是选择华北公开的空间，创建好了以后，这个空间又有它的一个独立的域名，这俩域名是不一样的。

我之所以强调这个域名，是因为我们一会使用的时候，我们要访问这个空间，你得用上，用这个域名还需要用到它这个空间的名字，这两个地方都要用到好了。我们做了这样一个基本的操作以后就可以用了，我们就可以通过 Java的API来访这个空间往里传东西了，传完以后这边就能看到。当然你也可以通过 URL直接就是远程的访问到它。

好，下面我们就来讲解一下我们在项目中怎么去利用青牛云把资源传到这里来。我们主要是两个功能，咱们一个来做，第一个我们先来处理就是传头像。好当然那么我们在做这两个功能之前，首先还需要做一点准备的工作，你得倒包对吧？青牛的 SDK你要访问的话，你需要把包倒进来，然后我们在配置文件里再做一点点配置，方便后面的程序的开发。

所以我就打开 may every postcard com，然后我搜一下青牛，就搜青牛的拼音就可以了。

然后第一个就是气流，Java，SDK我就选择它选一个版本，然后 copy一下，好，下载完了，有了包以后，接下来我们再做一点配置，这个配置其实不是七牛云，就是硬性要求的配置是我们自定义的配置，是为了让我们这个程序更灵活，配什么呢？

主要配两个内容，一个是配密钥，一共是有两个密钥，我们来看一下这个密钥是什么？我们从七牛云的空间里能看到看哪呢？这就是你的用户的头像，然后这里边有一个密钥管理，然后这里就有两个密钥，一个叫这个叫ak就是aqcess SK，这个叫SK， Secret key你可以显示其中前者密钥是用来标识你的用户的身份的，就是说我们要往这个空间里传东西不是谁都能传的，你只有有密钥就表示说你是当前这个空间的使用者，你才有权限传，如果你没有密钥是不能乱传的，不然这个空间就被挤爆了对吧？

这个是用来标识用户身份的，SK这个是用来我们在上传具体内容的时候为内容加密的，所以需要两个t这两个t我们最好能把它配到配置文件里，万一说你将来换了这个空间的话，或者说这两个key有所变化的时候，你好去改动，而不是把它写死在这个程序里。

好，我把它copy一下，把它配到 application process里，好在这儿七牛，然后因为是我们自己的配置，所以说你 k随便写，这里我就写七牛点k密钥，然后点access，这个是用户身份的标识的密钥，我把 key贴过来。好再来一个7牛点key点，secret这个是用来对文件内容加密的密钥，我把刚才的自拍拷过来，好了，这密钥就配好了，配好密钥以后还要配什么？

我们再配一下我们刚才所创建的空间，我后退一下，我们刚才创建了两个空间，那么我们要访这个空间，一个是要指定空间的名字，第二个是要指定这个空间的域名，每个空间的名字和域名我们最好做成可配的，因为万一将来要变的对吧？

所以把它配置一下，这样我先配黑的，这个名字好记，主要是一个域名copy，然后他说了你这个域名访问的时候，你只能用HTTP协议访问，不支持https，所以这个时候你要注意好，这里我写犀牛1.8k的桶。

其实就是空间的意思就是这个云空间的意思，存储空间的意思，它76云管存储空间叫bucket。

然后点还有点。

这个黑的是我存放头像的空间点，name的是它的名字是什么，空间的名字是什么等于可没有那天还有点，然后再来七牛点儿，8k的点儿，a的点儿，URL就是用来存放头像的，访问路径是什么？是hgdp冒号双切线手敲上，然后把这个路径写出来贴过来。

好，同样的我们另外一个空间也做这样的配置，主要是考一下域名7牛点8k的点，这个空间用来存放分享的文件塞尔 name搞错了这个name。K没有，那天赛70.8。K的点赛点12。好了，主要就是配其实就是两类数据，一类就是密钥，一类就是空间，因为我们有两个空间，所以说配了两份，就这样了。

好，配置完以后，接下来我们就来处理上传头像的逻辑，首先我们找到这上传头像请求是在哪处理的？

是在user controller里，所以我就打开 You there controller，然后我先干什么，我先在这里注入一些刚才的那些个参数，我把这两个key注入进来，另外把跟头像有关的空间的内容注入进来，因为一会儿写代码要用好，我先把道路括号写上省得忘了。

首先我要注入的是第一个key access key copy一下。

第二个我要注入的是secret key，然后再注入的是空间的名字，最后注入的是空间的路径。

好了。

然后这些k我就考点一面写错了。

好了，接下来我们在这里要写什么代码，我们主要是要处理上传的逻辑，而这个上传的逻辑我们之前实现过不漏的，对吧？现在我需要把它作废掉，为啥？刚才不是说了我们上传头像，因为有表单，所以我们可以采用客户端上传，表单直接提交到76云，就不走这个方法了，因此这个方法就要作废，这里我就不把它删了还保留，但是我写上说要废弃，你注意不用不要使用它就好了。

好，另外我们上传完的头像在我们本地的一个路径之下，我们怎么访问，我们是提供了这样的一个方法，可以让人访问。现在你是把这个文件传到了七六云上，这个方法显然也就没用了，对吧？它也是比较废弃不用了。

好，我先把这两个该废弃的废弃掉，我们需要做的事情是什么呢？我们在这个路径是打开用户设置的路径，打开上传头像表单的页面，这个时候我们需要在这里生成上传凭证，把凭证写到那个表单里，当我们打开这个表单的时候，表单里应该有凭证，所以我们需要在这里生成凭证，然后传给你模板，然后表单把凭证配好以后，提交的时候才能提交给齐能源，否则他不认。

好，所以我在这里补充一些内容，主要的内容其实就是主要一步就是生成上传的凭证。

好，让汽车云能够识别你的身份，而上传凭证它主要是它需要一个是需要上传文件的名称你要提供，每次传的文件不一样，凭证它也就不一样，再一个你可以指定，那么当我把资源传给齐能源以后，他给我们一个什么样的响应，你期待他给你一个什么样的响应，你可以把响应做一个规定，他按你的规定给你做出响应，这样我们好知道成功还是失败，所以我们还要设置响应信息，然后我们根据这两个内容再去生成凭证。

所以第一步我是要生成上传文件的名称。

然后第二步我还要设置响应信息，这两个设置弄好以后再去生成凭证。

好上传文件名，我们每次就生成一个随机的就可以了，而且你最好生成随机的。

当然有人可能会想这个好像不需要，因为是用户的头像，比如说我这个文件名就是用户的ID点评级不行吗？用户又在那么点偏激，肯定跟别人不一样对吧？怎么说第一个如果你这样做的话，比如说我一开始传了一个头像，后来我又传了一个头像，后者会覆盖前者，它不是一样的名字对吧？它会覆盖。那覆盖以后，如果说将来有一天我们想说开发一个什么类似于足迹那样的功能，想给你显示出来你这些年都做了哪些关键的操作，你以前传过什么头像，那就没有历史记录了，这是第一个。

第二个如果说你是同名的话，我们把这个文件传到云服务器上，然后我们去访这个云服务器，你注意它传是立刻会传上去，但是我们访问的话你会发现它在一段时间之内不会立刻生效，因为云服务器它都有缓存，所以你名字不便传上去，你去访问它，因为还是同名的它有缓存，你不会立刻刷新，所以我们通常就会生成一个随机的文件名，每次都变，这样保证的话它缓存没有效。

再一个我们历史的数据也可以做一个存留，也不会真正的删掉这样的。有人说这样不是耗费云服务器的空间吗？其实空间如果你交费的话，其实也没多少钱空间是最便宜的，硬盘是很便宜的，没有关系。

好了，那么我就生成了一个随机的文件名，然后生成完以后我还要设置响应信息，怎么生成？这就是新能云它做了一个规定代码，就这么写，我们要生成的响应信息存到一个叫string map的对象里，然后这个我叫 policy，然后你又死去，好，然后的话 Policy往里存东西点，put其实就是一个卖方点，put return高点就是响应的体，你希望响应什么内容你注意。

我们使用汽车云客户端直传的话，通常会采用异步的方式来传，因为异步的话它给你返回一个杰森这个事儿的比较方便，你如果是用这个不是异步的方式同步的方式，他给你响应html对吧？

我们就没法处理，你怎么说我们目前在牛客网的网站上，然后你现在把数据提交给7676云，给你返回一个网页，这就乱套了，所以我们最好是他给我们反馈一个Jason，只要告诉我们成没成功就可以了，后续我们自己来做进一步的处理，所以通常都是异步的。

因此我希望他给我返回一个Jason字符串，告诉我成功与否就可以了。这里我就肯定有 Youtube的get Jason0。

好，这句话最终会生成一个Jason字符串，就是扣的冒号0，就是说我希望成功的时候，他给我返回扣的冒号0就行了，如果失败了，你只要是不是这个值，我就认为是失败就可以了。

好响应信息我们也做了一个声明，最后我们利用刚才这两个内容去生成上传的凭证，上传凭证他这个对象叫 auth然后的话我们给它实例化一下auth点，用create方法来实例化的时候，你要传入两个key，第一个是与身份有关的access key，第二个是与加密对内容加密有关的 secret key。

好了，然后我们上传 aoth对象以后，我们就可以利用这个对象来生成，上传生成的凭证其实就是一个字符串。

我叫阿不露的。

 ok还有。

th点up low的投给，然后第一个参数写的是。

我们上传的空间的名字的8k的内容。

第二个是我们的文件名 file name。第三个你是指定一个过期的时间，就是 key它有效期是多久，多长时间以后过期，好这里我写的是3600秒一个小时。好，最后把响应信息传过来，这样就可以了，你把这4个信息给他，他就会给你生成1个字符串，因为我们的名字每次都不一样，所以这个字符串每次都是有区别的。

好了，生成完凭证以后，我们需要把凭证发给模板上好用，我就model点I的，这里我还没有声明，model声明一下，ID然后 up copy好这是上传凭证，那么另外我们再把这个文件名也传给模板，因为模板要向76云提交数据，这个文件名在模板上也有用的。 h股，然后的话filename内容这就可以了，那么我们页面上总之就利用这些数据模板上就利用这个数据去构造重新构造表单，然后并且我们把表单的提交方式改为异步的，提交给700就可以了。

但是我们先别着急去处理这个表单，我们在这个control当中再加一个方法，再加一个什么方法。当我们在表单里把数据提交给新能源以后，异步的新能源给我们反馈了一个消息，比如说扣的0成功了，成功以后怎么办？我们是不是要把我们优则表里的 Hi的URL做一个更新为青牛云的路径，对不对？如果你不更新的话，我们表里的路径没变，你白传了是吧？

这个需要我们的应用服务器来做，而我们之前的话没有专门搞一个方法去处理这件事，我们之前就是在阿波罗的方法里就顺带做的，但现在我们需要单独提供一个方法给页面去调用，而且这个需要是异步的，我们把这个方法写一下，就更新头像的路径，先声明一下，访问路径pass等于。

结果叫hider。用l。

然后 MR的等于request点post，因为你要图提交数据更新数据进来，所以说post然后一步的

方法名我叫update high的UI好，那么页面它想更新路径，它需要传入什么呢？它需要传入的是文件名family，我这单词写错了，好，他把翻译内容传进来，传进来以后，我们得判断一下它是不是为空的话，不行，你文件名为空我就没办法去更新了，可以先判断一下。

如果说 File name是空值，那我就直接因为是异步请求，我就直接返回一个json，字符串给它做一个提示。Community YouTube点get接生死卷一表示错误，然后的话说文件名不能。

为空，

如果不为空的话，我们需要拼一下 URL。我们访问76元的URL是什么呢？固定的。刚才的空间的域名，因为我们把数据存到了嗨的空间里，而空间是有个域名的对吧？

所以说我们就把这个空间域名斜线加上final name，这个文件的访问路径，好，我先拼一下 Url等于空间的名字房名叫hider，8k的uil对吧？

加上你得加个斜线，然后再加上非常内容，这就是这个文件的从76元上的访问路径，然后的话我就更新 user service update，header， user ID就是当前的user对吧？我就host older get user get idea好，然后 URL传入进来，这就可以了，最终你要给页面一个反馈， community YouTube的get杰森。是这样，0成功就完了。

好，现在我把 user control已经重构好了，主要是我们废弃了两个方法，然后对原有的方法做改进，另外的话还写了一个新的方法。

那么这件事完成以后，接下来我们就可以去处理对应的表单了，我就打开对应的表单setting点太慢。这个表单找一下他，因为现在我们是表单里要多一些内容，因为你传新能源的时候需要加就凭证对吧？要多一些数据，另外这个表单还不是普通的提交，你还要做成异步的。

所以说改动较大怎么办？我就干脆把原有的表单给它注掉，然后我把提前复制好，我们重新写一下，这样的话如果你想找到以前的代码也有一个留存，好，我把之前的 Form注掉，然后接下来我再到后面再把刚才我复制的内容贴过来。

然后这里我写个注释，原有的内容是上传。

到本地。

现在这个表单演示的是上传到七牛云。

好，那么这个表单我需要做一些处理，首先什么my sir等于POS的EMC type等于什么action等于什么，我就把它注删掉了。因为我们现在不是同步上传，我们是异步的，是要通过js去编写上传的逻辑的，为了js写上传逻辑的时候获取 form方便，我给它加一个ID， ID等于up load form。这就行了，一会他提交的提交给谁，用什么样的方式提交，我们都通过GS搞定，这是其一。

其二这里头样式不需要了，我把这个去掉，样式还不能都去掉，就把 th动态的部分去掉。

好，总之恢复成原状，我们之前的逻辑就不需要了，然后 ID该保留是保留 name，注意我们传记录员的时候，这个name需要写成就叫fan，把它改成叫fan。好，然后后面的话，

错误提示这也不需要了。好，就这样把之前的一些处理方式给它清理掉，然后我们重新来过。好。那么这一步我们处理完以后，我们还需要补充两个数据，这两个数据是传给青牛云的时候它需要的，我们就加两个黑的，因为这个数据不需要展现 input，tap等于黑的，然后 name等于固定的叫token，上传的凭证传给青州云的时候，这个名字必须叫token。

这个token的值是谁？就是我们CTRL传过来的阿波罗的token value等于 Upload token还需要另外的一个黑灯，就是我们还有另外的一个值要传给青龙云，那个叫k而 k的值。那个文件名大家好，这两个是700要的，他要求的，我们就这样处理就好了。

好了，那么现在我们这个表单处理完了，处理完以后我不说了，我们需要异步的提交对吧？得写js，所以说我们看一下当前的页面，它所引用的js文件是什么？Aaah是Globo的GS，我们把这个代码写到这里来不太合适，所以我们给这个页面单独创建一个js文件， Copy一下，这个文件我叫citing点GS，然后我在这个时代 GS目录下新建这么一个文件，塞停点减s这个文件的逻辑我们需要从头开始写，首先写什么？

就是我要给刚才的 form不是按钮，因为按钮一点 form就提交了，我是给 form定义一个时间，当我们点 submit的按钮的时候，会触发表单的提交，其实是触发表单的提交事件，我需要对这个事件做一个定义，我定义这个表单具体怎么提交？

好，所以我在GS里面我这样写，到了括号 function，表示说页面加载完以后我要去调 function调匿名函数，页面加载完以后我要干什么，我要给那个方式给 form定义一个事件，就是重写它的事件，提交事件我就写先获取它的ID叫upload放它的时间是提交时间就submit。

然后。

 upload upload是一个方法名，但是我还没写马上就要写，意思是当我点击提交按钮触发表单的提交事件时，这个事件这个由阿波罗的函数来处理。

好了，下面我就来写阿波罗的函数，好。然后但这个最重要，你别忘了要return false，如果你不return false，尽管说你这里能够做一些逻辑处理，但最终它还是会尝试提交这个表单，但你又没有写action，这里就会有问题。我们return force意思是你就不要再往下提交了，我们上面的逻辑已经把这个请求给处理了，已经把这个事件处理了。Return false表示说事件到此为止，不再继续向下就执行你默认底层原有的事件了，这个意思。

然后我们要想一步的提交表单，这个表单它还比较特别，它里边包含的不是普通的数据，是这个文件，那么所以我们还不能写到了点post，因为到了点post是一个简化的方式，有些参数没有办法进行设置，我们需要写一个能够设置更多参数的更强大的就是异步请求的方法，那就是到了点的价值。

其实到了点get，到了点post其实是对这个方法的一个简化，我们现在不简化，用原始的稍微麻烦一点的方法，但是它功能强大，然后这里边写一个大括号，里边可以包含多种ky6，每一种ky6对应的是一个参数，你可以定义帧，就是所有的参数都可以在这里进行定义。

好，首先我定义的是URL，我这个请求要提交给谁，我要提交给秦流云，我这个路径从哪里找呢？那么七牛云的手册里就是文档开发者中心对象存储，然后它不有一个存储区域，存储区域，华北这个区域它的名称叫g一，然后的话如果你是客户端上传，它的路径就是它up6的杠z1.76up.com，我把它copy一下，省得写错了，路径就是它了。

你HTTP或者是加s都行，我就不加了，就这样，当然你前后你得加上引号，因为这是一个字符串，这是一个参数值。

好第一个写上URL，第二个写上message，我请求的方式是什么？是post。然后第三个比较特别了，你看我没见过 process，data false。这句话的意思 False是拒绝不要不要把表单的内容转为字符串。那么默认情况下，我们提交表单浏览器会把表单的内容转换成字符串提交给服务器，但是你想我们现在是上传文件对吧？不应该把它转成字格串，所以写成放肆，然后还要写。

 content tap first。

按理说 contentType应该写什么？你是html还是Jason写写的是你传的数据的类型，但是我写成force什么意思？是不让解carry去设置上传的类型，那么浏览器会自动的去进行设置，为什么这样呢？是因为其实我们在提交文件的时候，那么浏览器就是文件和别的数据不一样，文件它是二进制的对吧？它和系别的数据混编在一起的时候，它的边界怎么确定？其实浏览器会给它加一个随机的边界字符串，好去拆分这个内容。

如果说我们这里指定了content type，那么且夸人就会去自动的去设置类型，那么边界它设置不上，就会导致我们传这个文件反正就有问题，主要是边界的问题，我们通过手动设置的边界 key又不行， key需要用浏览器随机生成，所以说就得设置成force，你要注意。

好，然后再来 data就是我们要传的数据是什么，这个数据需要特殊处理一下，我们叫new form。

 data。

这是一个js对象用来封装表单的数据，当我们传文件的时候需要做这样的特殊处理，然后你把对象form传给传到对象里就可以了，而form是谁？ Form不是他吗？Upload form对吧？

然后你注意这是我们用解块选择器选中的节点，我们得到的是解块对象，但是这里这是GS，它要的是GS对象怎么办？方块0，因为解块为对象其实就是盗墓对象的速度，这是它的本质。当我们从这个数组中取到某一个值的时候，就得到了一个动，所以我取d0的值得到一个down就符合要求了。

好，然后再来success，表示成功的时候我们做怎样的一个处理，我们需要说明一个函数去处理响应的信息，那么函数的参数就是响应的具体的值，这里我做一个判断，如果说 data存在。

并且带头点。

扣的等于0，对它存在，并且对它的扣的等于0就证明成功了，对吧？然后的话否则就是失败，失败怎么办？给个提示，提示说上传失败完了，成功怎么办？成功的时候，我们需要更新头像的访路径对吧？

我们需要还是在这个页面上用eve的方式去访问CTRL更新头像，所以好这里再接着写更新头像访问武将还是异步的，到了点pose，因为提交给我们自己的应用，所以说我就直接用简便的方式来写了。然后路径是context，pass加上user，然后 hide URL，看一下确认一下，hide URL咱们类上有优点对吧？没有问题。好，然后再声明一下我要传的数据的名字，我们这个时候要传给 Controller的是 found in。好，冒号 final name咱们可以从表单里取对吧？

看一眼不就是他吗就黑的，这个黑的它的特点是它有name，name等于t我可以利用这个特征把它取到，当然你加个ID也行，这里我就懒得加ID，我就直接通过内部来取了，到了括号， Input元素选择器选择所有的元素，然后再翻括号，属性选择器选择name等于k的属性只有一个，所以我就得到了对应的黑的，然后点vl得到了它的值传给了服务端，服务端处理完以后会给我响应，我要接着处理。这是我们服务端给的响应，我需要怎么说对它做一个解析，我们服务端返回的是普通字符串，我需要把它解析成Jason。

到了点pass。

接着刚才为什么这个地方我们没有说做一个解析，就这个地方新能源给我们它是返回的杰森格式的数据，而我们的服务器我们统一返回的都是字符串，普通字符串并没有声明为杰森，但是我们知道格式是Jason，所以我们可以把它转型为Jason的对象，好转完以后判断如果带头要扣的等于0就表示成功了，这个时候你刷新一下当前页面，让头像变一下，你一看就知道成功了，就window location点别漏的刷新当前的页面好，否则否则就是失败给个提示 Alright，data点。

 message。

好了，到这儿我这个代码就写完了，关于头像上传的逻辑，接下来我们就可以做一个测试。好，我启动一下服务，启动以后我打开浏览器，然后先访问一下首页，因为目前没登录，所以我也看不到头像，我得登录一下 CC，好我就登录了。目前的话 Cc的头像是一只小猫，我们看一下表里的数据，看一下它当前的路径是什么。好，你看它的路径是我们本地的服务器的访问路径，路过house对吧？我们一会要传的话就是要把它改成齐。

刘云的，好我就传一下，我就点这个账号设置。这里我选一个文件，改成它第一个，然后我要传了立即上传，传完以后页面刷新了，你看头像变了对吧？然后我先检查一下表里的数据，看看有没有变化，这样我倒叙一下倒叙排列方便找到这个数据你看 Url就变成了七牛云的对吧？

七牛云上有没有这个图片应该是有的，不然的话这也看不到，我们看一下空间概览，点 header，然后点内容管理，你看有了一条数据数据上传的时间在这，然后的话你也可以点这对吧？

做一个预览，没有问题。

好了，现在我们上传头像这个事就解决了，这种只是我们上传到云服务器的一种方案，只是通过客户端进行上传。

下面我们再给大家演示一下服务端直传，就是在我们的分享的时候，我们在后台生成了一个图片，我要把生成的图片通过服务器，通过我们的服务器直接传给760的服务器，在后台实现。好，我们就来重构分享相关的功能。再回到我们的程序里，我先打开下肯特勒分享对吧？好。然后首先我也是要传入注入一个参数进来，注入什么？注入分享的空间的URL，因为你看这里面我们没有直接在这个方法里实现分享，没有直接实现，我们只是把它丢给了一个队列对吧？

让队列去实现，但是我们在这需要给浏览器返回一个路径访问路径，因为你要把它底层改为七牛云，所以这个路径得改，那路径改的话，是不是你得知道分享的空间的URL对吧？用它来拼。好，所以我要注入一个东西，这个可以copy uil这个是嗨这不是嗨的赛对吧？然后 Key我也copy，以免写错了。

好，整个方法其他的逻辑不用动，我们文件名还是随机的保持不变，然后我们还是通过异步的方式把它事件提交给队列，让队列去处理，这个还是不变，最终返回给浏览器的路径。

那么我们需要做一个改变，就不是原来的路径了。

我就map点to。

curl现在的路径是76元的空间的URL塞r8k的ul然后加上一个斜线加上一个final，这是新能源空间的路径，就是这样的，你可以去新能源空间看，你看刚才这个图片它不就是这样一个格式，前面是这个空间的u二，后面是图片的名字，好这就可以了，这就改完了。

然后我们之前还有写一个方法，这个方法是从我们本地把图片取到，然后传给客户端，这个方法不需要了，因为我们一旦传给京东云以后，你是通过760去获取图片，所以这个方法也就废弃了，我做一个标记，但不是真正的删除。

好，然后剩下的逻辑就是去写跟萨玛就是去写消费者，因为我们的逻辑是在消费者里进行一个体现的，所以说我打开。

 invent跟summer。

然后我们需要在消费者里头消费这个事件，然后像七牛云传东西，这里面我们也需要传几个参进来，包括那两个key，包括上传空间的名字。

好，我那两key我可以copy，因为刚才这里不是写过了吗，把它copy过来。好，另外再把空间的内容传进来，这口叫下。

打。

k的内容，然后它的key copy一下，好，那么我需要的参数就已经注入完了。

那么除了这几个参数以外，我还要注入一个组件，先写上就是什么 spread pull。task，schedule取名叫task。Schedule为什么需要注入这么一个东西，这是啥呢？这不是一个线程池，一个可以执行定时任务的线程池。

好，你可能记得我以前说过说我们通常新这样的定时任务都是通过class去执行，之所以通过class去执行的原因是因为要考虑分布式部署的问题，为什么我们还要在程序里用这个东西，为什么可以用做一个解释，我去我要写代码的地方做一个解释，消费分享实践。

好，我们之前已经把这个逻辑写好了，这个代码一执行，这个图片是生成了，现在要做的事就是把它传到70云上去，怎么传注意这里可不能直接传，直接传会有问题，有什么问题你记得上次课我写的代码的时候，就是说如果就这句话和命令谁先执行完的这句话，因为命令是生成图片，它是一个比较耗时的过程，它可能需要300毫秒500毫秒甚至一秒都有可能就看你图片的大小，你想这命令假设500毫秒以后才能执行完，那么我们当前的方法的主线程不是等着他，而是继续向下执行。

他从这句话跳到这句话，可能连一毫秒都不用对吧？所以这句话先于他执行，也就是说这句话后面的逻辑比他执行的还早。

所以你在比如说我要把这图片上传到青龙云，你这句话执行的时候，那图片还没生成，你怎么传对吧？不行，好我们怎么去解决这个问题？我们只能等，但是你怎么等你硬把这个程序阻塞在这吗？性能也太差了怎么办呢？

我们可以用这样一个办法，就是我在这人为的我启动一个定时器，我每隔一段时间看一下，比如说我每隔半秒钟我看一眼你生没生成，好，你没生成我在等着，再过半秒我再看一眼，你生没生成，直到有一次我发现你生成了，ok我就去传，如果你一直不生成，我等了很久，比如说我等了30秒，我认为你肯定是有问题了，这个时候我就取消，我不传了，我认为你肯定生产有环境有问题，所以说我们这个地方就是要用到一个定时器，主要是来等命令的执行完成。

那么当然了我们这里可以用 Schedule了，为啥？因为你想我们这个逻辑并不是每一个服务器都会执行的，虽然说我们每一个服务器上都部署了同样的肯萨姆，但是你注意消费者它是有一个抢占的机制，比如说我有5台服务器，5台服务器部署了5个肯萨姆，那么如果说一旦这个消息发出来以后，只有一个可能他们能抢到他去处理，别的可能他们不会去处理的，他是有一个天然的这么排斥的这个作用肯萨姆，所以所有消息队列都有的一个机制好了，所以说这个方法只有某一个服务器上会执行，其他服务器就不执行了。

在这一个服务器上我启动一个定时器和其他的服务器并不产生什么关联，不会产生什么影响。它这个地方和我们之前所说的定时器不一样，我们之前的定时器是服务器一启动，它就自动暂停运行了，对吧？你5个服务器启动就服务器5个服务器都运行，而这里不是这里是谁抢到了这个消息，只有这1个服务器会启动定时器和别的不发生关系。

好这里我要把做的事再写个注释，这里我要启动启用码定时器，然后主要是监视该图片，然后一旦生成了，图片生成了，那么我们就上传至七牛云，如果你不生成我就监视着，就这个意思。

好，既然我要用定时器，我是不是得有一个线程体？当然我可以做匿名的实现，但这个逻辑比较复杂，所以最好我单独写一个类，这个类我单独写个匿名的，因为别的地方也用不到。

好，我写个class，然后的话up load task上传的任务。 Deployments。软的，当然我需要在这个类当中实现软方法，好还没完，这个类我希望给它加几个属性，第一个属性是文件名称，再来一个属性是文件后缀。为啥加这两个属性？因为你想你要调这个任务的时候，让他去传这个文件，你得不得告诉他文件名是什么，文件的后缀是什么，然后它对应到对应的目录下去找到这个文件才能传对吧？

这个任务只管传，文件是谁，他不知道，你要告诉他你要传进来对吧？

好，所以我加两个属性，这是file。

name。

文件后缀。

 Cervix，

那么你在实例化任务的时候是必须要把这两个属性传进来的，所以说我在这给它生成一个有参的构造器，强制它传这个内容，开始抓它，生成一个带有两个参数的构造器。

好，那么当然一会我要实现乱方法，我先不去实现这个地方代码怎么写呢？但这就容易了，就实例化 task对吧？Upload task task等于6。

upload。

 task。然后传入 family之前，我们有 family service对吧？好，这个任务构造完以后我需要调 task， schedule，然后 at fixed rate，然后把任务传进去，然后希望每隔500毫秒半秒钟执行一遍，这样就可以了。这个不需要太特别快，500毫秒也就够了。

然后的话你注意，就是我们这个定时器，你一定要考虑它什么时候停止，你这样搞的话，这么直接写的话它就永远不停止，这是不对的，我们从那以后要停止，定时器停止肯定不是在这停止，你在这只是触发定时器的执行，在哪停止，一定是在入院方法之内，我们当某条件达成的时候我才停止，任务完成了我才停止对吧？好，我怎么停止定时器，其实是我启动定时器的时候，它有一个返回值，叫filter， future里边封装了任务的状态。

除此以外 filter它还能够用来停止定时器，我们就要要用到它。

你看这是他调了这个方法以后才返回 filter，这个filter怎么给这个round包用呢？也好办，我可以在这个类当中再加一个赛的方法，要求你实例化完以后，16画完以后，你把最后再给我传进来，用这样的一个方式来做好。

所以我这里再加一个属性。

首先启 feel就是启动任务的返回值，它可以用来停止定时器，好，那么我在这儿再生成一个赛的方法就可以了。

有了site方法以后，你看这儿我是先实例化了 task，然后我去启用了定时器，然后紧接着我赶紧把这个定时器，因为它500毫秒以后才执行对吧？马上下面这句话是先执行，然后才到500毫秒的。所以下面的话我赶紧就是task点set，标准把这个结果传给他，然后他在这里边在执行的时候过程中就可以根据情况调用它去停止定制器了，就这样。

总之我们在这个任务当中主要来写什么逻辑，就是上传在上传的时候，我们一定要考虑可用性的问题，这是定时器一定要保证它完成任务以后就关闭。那么就像我刚才所说的，有可能有些极端的情况下，他完不成任务永远都完不成。一种情况是什么？命令执行的过程发生了失败，图片就一直没生成，如果你这个任务他一直没生成图片，你肯定没法传对吧？传不了你传不了以后永远都成功不了，那你就无法停止。怎么办？对吧？这是一种情况。

还有一种情况就是有可能他图片生成了，然后我传给70云失败了，因为此时我的网络有问题，或者此时恰恰欺凌云的服务器它就挂了，万一出现这种情况你永远都传不进去，你一直在这传也不行，这样服务器时间久了，这服务器就被你给撑爆了，用这样的无效的行为对吧？

所以我们一定要考虑到这一点，我们一定要考虑一个兜底的方案，就是一旦出现这种极端的情况，我也无论如何要把它停掉这个定时器，所以我们可以做这样的一个处理。

就是我在这里再加一个加两个属性，一个是开始时间，我在实例化 Task的时候记录一下，开始时间任务执行的时候，我在得到当前时间我减掉开始时间算一下我这任务跑了多久了，我一旦发现这个任务跑了超过30秒，我就认为什么这里有了问题，我就不再执行了，我就强制关闭，一般30秒足够了，30秒都没解决，那就是解决不了了，我就把它强制关闭。

这是第一个，所以我加一个开始时间，这个我就直接用浪方便运算，叫start time。

好，我再来一个叫上传次数，因为这个时间比较长，30秒其实往往见分晓到底成功还是失败，不用30秒可能是几秒就够了，但我们这个几秒又不好界定，我们再来个上传次数，比如说我发现上传次数都达到三次了，这个是什么原因？一定是我上传到青旅的时候失败了，因为如果不失败一次就成功了，对吧？上传次数变成三，就表示说有失败的情况，然后再把次数累加了，如果一共上传三次，可能这三次发生在5秒之内，我也强制停止掉。

因为我认为什么我传三次新能源都没传成功，很有可能是网络要不就不行，要不就是新能源服务器挂了，我就不再传了，三次尝试就够了，所以我再加一个上传次数，upload times。

好，总之我们有这两个一个时间一个次数的保障，一定能保证我这个任务最终会停止。当然我们不希望这件事发生，最好是他能成功，但一旦出现意外，这有一个兜底的方案，就这个意思。好了，我这个时间得初始化一下，次数的话默认就是0，这个项目就不用初始化，这个时间你要初始化对吧？时间的话我可以在构造器里初始化，那么这里写this点start time等于system点current，当前的时间，系统当前的时间完了。

好，那么最后我就是要来写乱方法来处理上传的逻辑，这个方法其实是反复调用的，我们处理它的原则和递归差不多，这方反复被调用对吧？每个500毫秒被调用一次，我们最担心它不能停止，所以说和递归的处理原则是类似的，我们先去判断它终止的条件。

好，所以说第一种情况就是生成图片失败。

生成图片失败我们就会执行很久，我们会等很久，可能会等超过30秒，这个看时间超过30秒通常就是生成失败。

好，我判断一下，如果说sister点当前时间减去start time，这是毫秒大于3万，3万毫秒就30秒大于30秒，这个时候我们认为生成图片就有问题，我们强制他停止，我记个日志给他 Logo点l说执行时间过长，然后我就终止任务，并且我把这个file name拼到这个字符串里，我好知道是哪个文件我给它终止了，是哪个文件我终止的这个事儿。

当然了这只是记录日志，你怎么停止定时器调 feel去点看守，这就可以停止，然后树这就可以停止好。既然停止了，后面的逻辑不用执行了， return。

好再来，这是执行时间过程，通常是由于无法生成图片导致的。还有一种情况是上传失败，就说我传7度云失败，由于网络和某种原因，这个时候我看次数 Up，load times如果说它大于等于3，反正最多三次，我就不再传了，这时候再给一个错误提示。 Logo点l说上传次数过多，终止任务也是我把非常内部提上来，也是停止定时器并且未退。如果这两种情况没有发生，那就意味着我就可以继续向下执行下面的逻辑。

好向下执行的时候，首先我要从我本地的目录里找到那个文件对吧？本地的路径是什么，我得把它拼出来。本地的路径是wk，什么image？Story，这是我存放WTO文件的目录对吧？然后加上斜线，加上 file name，加上surface of后缀，这是我本地存放文件的完整的路径和名字，对吧？

然后我要看一下它存不存在那么实例化一个file。好把 Pass传入，然后做一个判断， file。

点儿。

 exist，如果文件存在，那我就开始传，如果文件不存在，我什么也不做，什么也不做，过一会又掉一次，直到它存在，我再执行这个逻辑对吧？就是这样。

好既然存在，我这里要开始传了，我打个日志，因为这件事比较敏感，我们将来出了问题好追溯，所以打个日志音符是吧？我要对增票格式化，我要死定一点。

说。

卖的说开始d百分号第几次，这是一个数字，需要替换第几次上传，然后后面给个分号，百分号s这是需要一个字符串替替换，好，就等于这么一句话，我需要后面需要替换。

第一个百分号d需要用 Upload times替换，而且 upload times还得加一对 upload times字正一好。

然后第二个是用 file name替换，文件名替换，记完日志以后，下面我就要正式传了，传的时候也是你要生成凭证然后才能传，而生成凭证又需要设置响应信息，又需要文件名，但文件名其实已经有了，所以我就不用生成文件名了，我就直接设置响应信息，还需要使劲map，policy等于new使劲，然后的话 put return包。

点。

返回的数据的内容，数据内容也个也是个Jason community YouTube点get杰森死卷零，我希望在成功的时候还是给我返回，扣的0就可以了。

好，然后有了这个信息以后，我要生成上传凭证，生成的方式和我们刚才那里写的是一样的，我再写一遍， create也需要存入两个key对吧？然后分别是access。

 security key。然后。

凭证是一个字符串，upload都肯等于它点upload。

Ok那么第一个参数是上传的空间的名字， sell back的name，第二个是文件名，非常累，第三个是过期时间，凭证的过期时间3600秒一小时，然后是响应信息完了。

好，然后我们要传这个时候我们这里要和表单不一样，表单我们是在GS里设置一个上传的地址对吧？这里我们需要通过Java程序指定上传地址，或者说指定上传的机房，要指定上传的机房。你可以写它的域名也可以，它里边有一个静态的工具可以直接得到华北的机房，我写一下就是阿布露的我们需要用到阿布露的manager，在服务端的时候，manager等于new upload manager。

然后这两项利用一个consideration，新能源的配置配置里存的是机房的信息，它有一个类要用点一用一，我只能华北机房，然后的话我要开始上传了，上传的时候我们需要对上传的代码处理异常 try catch，k是到的是七七牛的XP，我先把异常处理一下，如果说我捕获到了异常怎么办？

我就记个日志，然后的话我们就等着一会还会再调一次，我们再来一次，我们可以就给他一个机会，万一说网络不好或者怎么样的，我们传世之外的对吧？

有这种情况我们就再来一次，但是我们一共三次机会，三次你都传不上去就算了，这个意思，但我这里要记个日志， log点因数。

再一个我们记个日还有一个好处就是6776云它有一个政策，就是说如果说你的上传的成功率低于百分之多少的话，他会给你退钱，低于99%退多少钱，低于95%退多少钱，它有一个可能性的保障。

所以你记个日志，然后的话一旦说你发现这个错误率很高，你去找他退钱，这也是一个有必要的一个手段。好，那么log点infer好，这里我还是要格式化字符串， Spin点format说第多少次上传失败，后面再给一个，再加上 final name。

好了，然后我后面需要替换，用 up low的 Test进行替换，用这个范围内替换那个字符串替换这两个参数，然后对异常处理了，这个地方也得再处理一下，你看如果说我们发现这个文件存在，我们就做这样的处理，它不存在怎么办呢？不存在当然我们进行下一轮的下一次调用到这里我也记个日志，我们把日志记得完善一点，因为这个地方一旦出了问题，我们好通过日志去追踪，这我记得是说等待图片生成，因为你不存在就意味着图片没生成，我就等着我就记个日志对吧？

三个内容。好，这里我也是打了个日志，好，日志记完了以后，接下来我就处理踹里边的内容，我就开始上传图片了。

因为。

凭证已经构建好了，上传图片，它返回一个响应信息叫 response，返回的是response，然后我们调用 Manager，然后点 put方法，那么这个方法它可以帮我们去传图片，但是你需要把这个参数传给他。

首先我传的是pass我本地的文件的路径，然后是file，name，文件名，然后是upload头啃，这是上传的凭证。

然后下一个参数通常是now，然后的话下一个是一内置，然后讲一妹子加上后缀上传的文件的类型，最后一个给个force。

好，它这个参数有这么多参数，最后一个检查什么东西我也没有细看，反正一般都是force。这里是传的时候需要携带什么额外的参数吗？没有，大概就是这个意思。这是我们从它官方手册上找到的，它的一个代码的格式就是这样的。然后这句话执行完以后，我就处理响应结果。

好，那么响应的结果，因为我们之前给的要求是一个Jason对吧？所以我得到的是一个Jason的数据，我就但是我得到的从这个数据得到的直接得到的是一个字符串，我需要把它转成Jason，我就这样处理。

Jason object，然后点pass object，然后从response里获取数据，点get不是点get点到。

点4卷。

我就得到了返回的阶层字符串，把它转为阶层对象，我得到的是一个Jason和Jack。

好，然后我要判断一下 Jason他有没有值，如果说Jason等于没有值，或者说Jason get扣的等于no没有扣的，或者是Jason点get扣的，点two string，点echoes，0，我加一个感叹号表示不是这样的。

好，这是什么意思也很明白了，就是说如果说我返回的数据，要么是空，要么里面扣的没有，要么扣的值不对，我就认为不对，因为我认为正确的时候一定是有扣的有0的对吧？这不对怎么办？记个日志，错误日志这个方式和这个是一样的，就是说第几次上传失败，然后失败的是哪个文件，完了 Else，否则的话怎么样，否则就是成功了对吧了。

第二因为什么？给个记录说有点格式化，死定要说卖的说d几次上传成功，这些后面是s我这写错了，因为第二个是字符串，好，然后 Up load times family。我这儿又记录了第几次传的成功了，在成功的时候这个任务就可以结束了，对吧？我就filter点看守书，任务结束到此为止。

好，总而言之，你看整个的逻辑就是说如果时间过长，强制结束，如果失败超过三次强制结束，那么还有成功的时候结束，那么其他的情况没超时，失败次数没达到，我就再运行一次，争取让它成功了这样的。

好了，这个逻辑我就完成了，总之这个代码其实并不长，逻辑也并不复杂，但是主要就是考虑的比较多，一定要重点考虑说这个任务他不完成的时候我怎么办，主要是解决这么一个问题，有点麻烦。

再一个为了能够追溯这个过程，所以说我们到处记日志记得也比较繁琐，主要是麻烦在这儿了，好了，那么完成以后咱们试一下，我把这个项目重新启动一下好了，启动完以后我打开浏览器，我把缩小一点，这样我能够直接的看到控制台提的提示，这样我扫那些首页，现在刷新一下，好，然后我要分享，因为这个功能是通过分享来触发的，对吧？

是。然后htmul等于然后code.com就它了我就不改了，回车看控制台，等待图片成功，第一次失败，第二次上传成功，完了。

好，这样空间里有没有看一下？内容管理，有了点来看就有这么个图片，那么如果图片越大的话，其实成功率就是失败的概率是越高的。

那么小一点的话成功率会高一点，这可能是跟网络有关系，或者是也可能是跟我们免费的账号有免费的使用有关系，所以说他给我们分的机房可能就是没有那么性能那么好，也有这样的可能，反正是他有经常能看到一些失败。

好，我再来一下再刷新一下，刷新成功了，再来第二次成功了，如果换个网站，baidu.com成功了，再来成功了，你看百度成功率就高，因为百度的首页它内容少，牛客咱们首页的内容多，我们实际在分享的时候，我们分享的页面一般模板都比较简单，所以说成率还是比较高的，这样好。

当然了，如果说你想在商用上让它云服务器更稳定，你可以选择

比如说阿里云选择付费的这种服务性能就会更好一点，更有保障一点。好，这次课我们就把上传到云服务器的这种方式给大家做了演示，这次课我们就进行到这里，咱们下次课再见。