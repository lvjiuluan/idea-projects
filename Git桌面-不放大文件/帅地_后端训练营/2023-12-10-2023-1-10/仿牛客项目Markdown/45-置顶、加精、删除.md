45-置顶、加精、删除.mp4

这次课我们来实现置顶加精和删除的功能，那么虽然说这是三个功能，但是他们在实现的时候非常的相似，所以我们可以一并把它们都开发完，那么我们在开发的时候主要是从三个方面来写这个代码。

第一个是功能层面的实现，也就是说当我们点击置顶的时候，我们要修改帖子的类型，然后把它设置为置顶的类型。

当我们点加精或删除的时候，我们需要修改帖子的状态，把它修改为对应的状态，当然这三个操作是针对帖子而言的，那么基本功能开发完以后当然很简单，主要就是修改，开发完以后，我们需要对这三个功能做权限管理，因为这三个功能显然不是普通的功能，一般的用户是无权访问的。

我的要求是这样，就是说版主这样的拥有版主权限的用户才可以进行置顶和加精的操作。

那么只有管理员才能进行删除的操作。

因为我们之前上次课已经把 security融入到我们这个项目中来了，它已经能够起作用了，所以说要想管理一个新的功能的权限，我们只需要在色块的KFC里进行一个配置，几行代码就可以搞得定，所以也比较容易最后那么这三个按钮我们在页面上显示也需要加以处理，你普通用户操作不了，你就连看也不让他看见对吧？

那么你最好是做这样的设置，版主能够看到置顶，将精管理员才能看到删除，那么其他的人都看不见。

那么这个按钮的显示我们因为是要通过权限去确认它显示与否，怎么去在页面上做这个事，那么这个time leave可以给我们提供支持，因为模板上的事情由来解决。

Time leave它是支持 secret，它里边有一些标签能够支持 security，不过这是他们内部后来在某一个版本升级出来的功能原来是没有的，所以说你要想用这个功能，我们需要单独导这个包。

再一个我们从他们官网的手册里，他默认没有这方面的详细的描述，没有这方面详细的文档，我们在这个地方社区里能够找到一个小节，有一个大概的介绍很笼统，然后他这里建议你去 get up上去找他这个项目，那里边的话有稍微详细一点的介绍。

所以说如果你想去看这方面的文档的话，我们去get up去看好了，那么大概介绍到这，首先我们第一件事，因为我们要引入一个新的技术，所以说我先给大家看一下这个内容，找一找手册的位置，再一个我们把包引进来，然后我们就按照这三个方面去做我们这次课的开发，首先我先打开给他，然后去搜一下 timely色块的相关的内容，我就直接搜 time leave，然后的话是quite收到以后就是这个东西 time leave，exercise，然后 spring security点进去，它这里边有好几个版本，34，那么组件模块的版本，它和色块的版本是对应的，如果你的色块的版本是5，你就用这个5，你是4就用4，我们其实用的是5，我们的 spring boot，它底层的pom声明的版本是5，所以我们用这个当然了，所以我们一会去搜包的时候搜的是第五个版本，然后后面他有一些关于这项技术的一些介绍，你可以去看，后面有一些小的实例，有一些代码可以去看。

好了，那么我们就不在课堂上详细看了，我们要做的事情是把5这个版本的包找到，然后引入到我们项目中来，那么我就打开没本repost到com，然后搜一下我搜time leave，然后是不远 security。好，那么就是它了点进去，然后选择一个版本拷一下，然后把它粘贴到我们项目中来。

好这个版本我可以把它去掉，因为我们的副炮已经声明了，版本他用什么，我们默认就用什么，没有必要追求一个最新的版本。

好了，这个包打完了打完以后，那么接下来我们就按照这三个环节去开发，当然我们在最后一个环节才能够利用上 timeless这块的相关的内容用的时候，我们再看它到底是怎么用的。

首先我们先做基本的功能开发，先实现置顶加精删除的基本操作，那么在实现的时候也是我们先来开发数据访问层，提供几个修改方法，然后开发业务层也是提供这么几个方法，然后 CTRL处理相关的请求，然后页面我们把展现的部分处理好，按照这么一个流程来，这没什么好说的，我们就直接来写这个代码。

好，首先我们先来开发数据访问层，因为是对帖子的操作，那么无论是置顶加精还是删除，你最终是要修改帖子，所以说那么我把我先打开迪斯卡斯pose的map去增加几个修改的方法，那么这三个操作一个是修改类型，帖子类型，一个是修改状态，所以说我需要加两个方法， update态度，然后你需要传入ID，根据ID来改，类型类型也是整数态度。

好再来 update status，根据ID改这个状态，那么声明完以后，我们需要打开对应的配置文件，然后它把 circle写好搜一下。

对。

 discuss postmarital，xml，那么我在最后加两个update语句，第一个是改这个类型 tap，然后是update call一下不对的表site，tap等于参数 tap，然后 when ID等于参数ID，这就完了，非常容易再来一个，第二个可以照 copy。

另外是update status，然后这个是site，status等于参数，status，条件也是yid等于ID好这就行了，完成以后下面我们就在 service里提供这样的修改方法，然后好让表现图去调，然后再打开 discuss post service。

在这里我再加点方法，先是update tap，参数是ID，然后的话另外一个是tat，直接return discard。Post迈克点update。Type把参数传进去就可以了。

好，另外再来一个update，这点事。

 ID。

实在的直接委屈，discuss postmental的update，staters。好，那么业务层写完以后，下面我们开始写表现层，首先处理 controller，那么因为是帖子相关的逻辑，所以说我找到 discus post control了，在这里面我再加不是一个，其实一共要三个置顶加精删除三个请求，我们一个来先处理置顶的请求。

然后先声明一下。

路径，置顶我叫Top，然后 method等于request，request。

Method点，post。

因为你要想置顶，你需要提交数据进来，所以说这是post，然后请求我们用的是异步，请求就是页面上。

点完这个按钮以后不整体刷新就可以了。

然后所以说我需要加上 response包点注解，那么这个方法返回10句方法没有叫site，Top设置置顶，那么页面上需要传入的参数是什么？其实主要就是帖子的ID，你传入帖子ID，我根据ID把类型改成置顶的类型就可以了，就需要传输这么一个值。

那么实现也非常的简单，就是调 Service，迪斯卡斯pose的service，然后的话点不对的 tag，把ID传入置顶的类型是多少，咱们可以从表里看一下。

这个得搞准确了，我们见表的语句里头写得很清楚，解释点一下。 Ddl语句零普通的帖子默认的一就是置顶，所以把它改成一就可以了。你别忘了这里，我们虽然说做的操作比较简单，但毕竟帖子发生了变化，帖子发生变化我们需要做什么事呢？我们需要把最新的帖子的数据进行一个同步，你要把它同步到 Certainly，对吧？因为什么？我们好搜的时候能搜到最新的帖子，最新的数据，所以我们需要再触发一下帖子发布事件，就像我们发布帖子的时候这样再触发一次这个就发帖事件，我可以copy一下，好好。

好，然后粘过来，看一下哪些地方需要改，首先new event，然后 Topic，public没有问题，优质ID这个肯定是当前的用户的，我就house偷的 get ID类型 post没有问题，然后 ittid就是帖子ID就完了，然后触发一下可以了。

好，那么发布完以后，最终我要返回一个数据给一个提示成功就可以。

那么return community又退化，get精神给个0。

成功的状态就完了，这就置顶。

那么加精和删除其实和类似下面，所以我直接copy，然后在这基础上改，这个是加精的路径，我叫做wonderful，然后也是pose的请求，那么这个方法名叫site wonderful。

好。

刚才刚才我写错了是update time对吧？我这怎么写上update status？置顶是update time。好，然后加精的话是update，status倒没有问题。Update status加精的话，这个状态应该是几？再看一下，状态默认是零正常，一是加精，二是拉黑切入删除，所以说这个也是一没有问题。

好，这个逻辑就是这样的，然后也是你加进以后帖子数据发生变化，你也要触发发布事件，那么相当于把数据重新的同步到 Es里去，这段话和刚才是一模一样不用动，然后最终我们返回一个状态就可以了，家丁很快就实现完了，最后还有个删除也copy好删除，那么路径我叫德丽婷，也是POS的请求，那么这个方法我叫set，delete就设置删除的状态，传输参数也是ID，那么删除态可就不是一了，是二刚才我们看了拉黑的状态，然后那么帖子删除以后怎么办？

我们就不是触发发帖事件了，你不应该说把这个帖子在更新到 es里，因为es里存一个删除状态的帖子没有意义，我们应该是从es里把帖子给删掉，这样搜就搜不到，它应该是这样的。所以我们应该触发一个删帖事件，但是我们现在可能还没有删帖事件，我看一下有没有这个类型，你看没有，我们需要再加一个删帖的主题，写一下删帖，delete。

好，再回到刚才的 control里，这个地方改一下改成三体，然后也是当前用户，也是帖子的ID触发这个事件没有问题，然后你别忘了，那么这个删帖事件因为是我们新加的事件之前没处理过，所以说我们在事件的消费者里还要把这个事件也去消费一下，所以我们找到那个事件的消费者in mind12码。

其实删帖时间和发帖时间的实现逻辑非常就差不多，我们可以copy消费，删帖事件 topic。改一下别忘了。Delete，然后憨豆 believe to message。好，然后前面两段先判断这个参数是否为空，得到英曼的判断，英曼的是否为空，这个是可以一样的。

然后后面这个地方就不是safe，而是delete，所以说这句话不要了，我就直接 elastic search service，delete，discourse，post service里得力的方法，我们之前就已经写好了，这里需要传入帖子ID，我们可以从e MAC对象里获得 in one的点get int ID，这就是好，这就完了，那么现在我们就肯抽了处理请求的层面已经完成了，最后是要处理这个模板。

那么我们置顶加精删除的操作是在帖子详情页面上去发起的三个按钮在那个页面上，所以我们需要打开帖子详情页面，discus detail点steam。

好，那么就在这个位置，这三个按钮，首先你看它上面没有直接定义事件，其次上面也没有加什么ID什么的，说很有可能这三个按钮就是这个事件压根现在就没有做任何的处理，我们确认一下，我们看一下当前 html它所依赖的GS里有没有对这个按钮的处理，如果没有的话，我们需要重新来写。

好，我看一下，那显然是迪斯卡斯点GS了，搜一下迪斯卡斯点GS你看这里只有点赞，其他什么都没有，所以我们需要自己把这三个按钮事件定义好，把整个请求的过程处理好。这个代码太多了，我关掉一下。好。首先为了定义事件，引用这个按钮，方便我给它加一个ID，当然你也可以直接在这样讲on clean，或者我们直接通过纯GS的方式，在页面加载完以后，然后动态的给它绑定时间也可以，我采用后者。

 Id这个ID就是置顶，我叫Top置顶的按钮， Id等于加精的按钮，我叫wonderful body，然后删除按钮。

搞错了。

等于。

 delete。

 body。

好，那么不光是要 ID加ID是为了我们一会儿定义事件方便，那么我还要做一件事，我在这三个按钮之前加一个隐藏框里存一下帖子ID，因为你想我们无论是点置顶加精还是删除，我们都要向服务器发一个异步请求，请求传的唯一的数据就是帖子ID，我从哪得到这个帖子ID对吧？我干脆就在这写一个黑的，然后的话里边放上帖子ID就完了是吧？

好写一个太太黑的，然后的话给他一个ID，我方便通过GS获取它，这里存的是帖子ID，所以我叫post ID，然后它得有一个值。

这个值我们可以通过就是帖子详情的这次请求里我们是传过来了这个帖子的数据的，所以我们很容易得到帖子详情请求里我们传过来的帖子数据应该是什么，你看这都是POS的对吧？

所以这个地方就是post点ID就可以了。

好了，下面我就去 js文件里，根据 ID给这三个按钮分别定义事件，然后去发异步请求，通常我们是在我们要写一个逻辑出来，页面加载完以后就说明html标签都已经加载完了，这个时候我用GS得到这个标签给它绑定动态绑定一个时间，一般这么做。

写这句话，到了括号里边写一个匿名函数function，这句话的意思和GS里的window点 on，low的等于function是一样的，就是页面表示页面加载事件的意思，这个函数是这页面加载完以后会调用的，页面加载完以后我要获取安全版权事件，我先获取 Top button。绑定一个单击事件可立刻。然后单击事件绑定一个函数，函数名写上去叫site。对，叫site。Top这个函数一会要写，不然就会报错。好，再来一个，然后不是点赞，是加精 wonderful button。Kelly可立刻单击事件，单击时调用set。

Wonderful。

好，再来删除得力发展，单机的时候sat得力。好，我是声明了说我点3干9的时候分别调这三个方法，但是这三个方法我还没写，于是我就写是吧？一个写先写在这里，好，这个方法非常简单，就直接发出一个一步的post，请求访问服务器传餐就可以了，那就到了了点post。

第一个参数第一个是路径康txt pass加上。

 Discus。

然后是Top置顶的路径是Top对吧？然后第二个是我们要传的参数参数的k就是ID它的值看一下值这个东西。好，我们根据ID很容易就能得到这个框，从而得到它的值。我就到了括号 Post ID，然后得到这个框它的值点vl方法。

可以了，然后处理响应过来的这个结果是一个普通的字符串，但是满足阶层格式，所以说我们可以把它解析成 js对象，到了点。

plus Jason这。

一段传进去，我们就得到了一个对象，然后对它作出判断，如果被它的扣的等于0，假如说成功了没有问题，否则就是失败了。

好，那么失败了怎么办？失败了给个提示，其他的就不用做， alert。Data，点message。好，那么如果成功了，你要注意我们要改一下按钮的可用性，因为如果我点过了置顶就不用再点第二次，那么我点过置顶以后，我就要把置顶按钮设置为disabled，不可用这样你就不能再点第二次，这样比较合理。

好，所以这个时候我要把置顶按钮设置为disa保函，怎么设置先选中它，是Top8天选中这个按钮点at1t2。那么主要是改这个按钮的属性AD，第二是改属性，改哪个属性呢？

Dc保的属性，然后把属性设置为DC保的就可以了， DC保的等于DC保的他就不可用了，这是置顶的逻辑，那么置顶你会了，其他另外两个方法其实非常的相似，我再拷贝一下再来一个加精方法名叫sat wonderful copy一下，然后提交的路径要改成wonderful，然后参数也是这么传，返回的结果也是这样去解析，如果是正确的时候，我们需要把加精按钮设置为不可用，所以说这个是加氢按钮，而嘉靖二者是他不可用，否则错误给个提示这就没问题了。

好再来最后是删除 site得力，然后路径是得力的，参数依然是这样的，处理的结果依然是这样处理，然后你注意删除完以后，我就不把删除按钮设置为这个不可用了，如果这个帖子删除以后，那么说明这个帖子已经没有什么存在的意义了，也不用去看它了，这个时候怎么办？我就直接跳转到首页就完了，怎么跳转？我们通过GS是这样写，location，点href等于 contact加上index。

好，这就可以了。

好了，那么现在我就把置顶加精删除，它的基本的功能已经实现了，实现以后咱们先测一下，如果没有问题，我们再对权限进行一个管理，那么我就启动一下服务，好启动以后打开浏览器，访问一下首页，然后我得先登录一下，我先用一个普通用户登录，因为现在没做权限管理，其实你用谁登录都可以，我们先不纠结这个事，一会再去做权限的处理。

登录以后比如说我要把做处理，置顶点一下，置顶以后它变灰了，但数据对不对？我们就要查一下表，看一看这个帖子是谁呢？叫QQ的帖子，我倒叙一下，因为他的时间比较新，倒叙，

最后一个。

QQ你看态度变成了一没有问题是吧？好再来我再加精一下，也变灰了，说明页面的逻辑没有问题，我们再看一下这个表。

状态变成一没问题，好再来我给它删了，以后它没有刷新，而是跳到首页，然后你看没了以后我们看一下这个状态。变成二是吧？可以的。好，但是现在其实有一个小的这个小小问题，我们看一下什么问题，我再来比如我点它置顶，置顶完以后，比如说我刷新一下当前页面，你看这个状态就不对了，为什么不对？是我点置顶以后，那么根据反馈值我对这个按钮做了处理。

但是你注意如果说我们刷新这个页面，或者说我通过列表进入到这个页面的时候，你是不是应该在页面初始化的时候也把这个状态改一下，如果当前已经是置顶了，你就把它设置为disabled，对吧？

所以这块得处理一下，不然的话就会出现刚才那样的尴尬。好。我先把它处理跟权限没有关系，只是可用不可用的一个一一个小的插曲。好首先置顶我这样写th冒号主要是要设置它的 Disable的属性对吧？那就th冒号，disable的等于我要判断一下post点PAD当前的类型它是不是一，如果说post点tap已经是一了，我就这个返回处意味着它就不可用，因为它已经是置顶的状态了，已经是置顶的类型了是吧？就这样处理。

同理加精也是类似的， th冒号对c波动这个得看是得到啥。 Status等于一等于一意味着你已经是加氢的状态了，这个时候你就不可用，不能再次加氢了对吧？那么再来对删除也做一个处理。

Disabled等于然后boost点status等于2，那么如果你已经是删除态了，我们就让它不可用不能再点了，那么做完处理以后可能还不久重新编译，因为改动比较小，而且改的是模板，他有的时候感知不到，我强制重启，重启完以后重启完以后打开浏览器我再访问首页，然后你看这个帖子我点进来，置顶就是不可用点不了对吧？我点一下加精刷新一下还是对的，首页重新进来没有问题，好了，现在就是说我们先不考虑权限的情况下，功能的操作是ok的，接下来就是处理权限的问题，这个就比较容易了。

那么首先我要配一下权限，我需要找到 So quiet can figure， so quiet can think，那么配置权限的方式和之前这段代码是类似的，只不过我们再加一点就可以了是吧？我就在点at卖特斯，然后再点has any hospital，那么这里边我先设置置顶和加精，置顶的路径是discus Top，然后加精。

 Discourse wonderful。

那么对于这两个路径，谁能访问是版主，而版主是这个moderate，你具有这个权限就可以访问这两个路径，好。

同理再来 And matters，然后点还是安利是瑞典。再来除了那两个路径之外，不是还有一个删除吗？

那就是disk us delete，

然后谁有权限去删除，好的妹。

好，这样的话就是这两个功能只有版主能用这个功能，只有管理员能用。

这样。

我们权限就丰富起来了，如果说我们的系统中占有更多的权限，那就好办了，比如说有运营的人员，有这个产品的人员等等，有测试人员等等，他们能做的事可能都不一样，其实都是类似的配置方式。

这是我们从这个功能上来说做的一个配置，这样配完以后，我们先不管能不能看到那个按钮，我们先试一下。

那么再重新重启一下，好，启动以后打开浏览器刷一下，然后我先退出一下，推出以后首页，然后比如说我随便再找一个我点置顶，没登录点置顶，你看因为我们是一个异步请求，它没有重定项，但是它给我一个提示说你还没有登录加精删除是吧？没问题，好我登录我用一个普通用户登录，这用户应该是没有权限的对吧？

好再来置顶。没有权限加精删除对吧？没有权限然后再来退出，然后扣的21，闹扣的21，它是他看一下我们表里原有的数据，测试数据不用倒序，它稍微比较靠前。

111213他们的眼影一样密码一样，其实都是123456，这三个是管理员。

2122232425这三密码也是123，这5个人密码也是123456，然后的话他们是版主，好，我就用21登录，版主登录123456，登录以后跪求offer，我能置顶吗？

可以加精可以删除，没有权限好再来退出，我用 now colder11这是个管理员，123456，为什么说他是管理员，我们可以看这，你看这5个人是二，那3个人是一是吧？

好继续，然后我用 Code11管理员登录，三KH二跪求阿尔法，你看我置顶将近已经点不了了，我先把删除点了，可以点对吧？

然后我再换一个，看我点置顶，没有权限加精没有权限，所以你看无论是我没有登录，还是我登录的时候用的是普通用户，或者是有一些特殊权限的用户挨个去测，他都能够准确的判断出我能不能访问这个功能。

好，所以说我们从服务端权限安全的角度已经到位了，但是页面上还没到位，就是说既然说你不让我点置顶和加精，你干脆别让我看见对吧？我们直接对于不能访问的那些用户，我就干脆让他看不见就完了，怎么处理？我们一开始所说的，我们需要用到他们对于此不认可的一个支持，需要用到它的一个特殊的标记，那么在模板上获得当前用户的权限，从而对按钮是否显示作出判断。

那么组件我们刚才已经包已经导进来了，那么我们在页面上怎么用？

首先因为它是一个新的组件，我们需要在模板上在顶端顶部也写一个类似于这样一句话，就说明一个name，space命名空间，那么组建的面空间其实就有点不一样，怎么写还不好记，我们去搜一下。

在get up里头，这里有这其实就是一个手册，简单的手册，我往后找他，在最后的位置告诉你说你在这个html里边你需要写这个秘密空间是这样写的，所以你没有必要手写直接 Copy，然后把它粘贴到这里来。

然后你看我们这样声明表示说我 time leave的语法它是以th为前缀，这块是SEC比方说命名空间里的语法是 SEC为前缀，表示secret安全的意思。

好，具体来说我们在按钮上在这个模板里头，在标签上怎么用，我们再找到那三个按钮。

首先我先处理置顶，置顶我是希望只有只有这个版主才能够看到这个按钮，你就这样 SEC以SEC开头冒号，然后 authorize表示这个权限等于里边。

has any。

奥斯瑞铁然后写上一个权限，我们的权限就是moderate。

说白了这句话和 can figure里逻辑是一样的， can figure的逻辑不就是你看has什么has any also reading，然后里边写一个字符串，对吧？当然我们在页面上如果你有多个值也是逗号，写多个值就可以了， has any else ready？这里就一个就是版主有权限。好同理加精也是类似加精的话也是版主可以操作，所以一样的。然后删除类似删除的权限是管理员在那里，这就可以了，所以我们通过这种方式也能够起到像服务端配置这样的效果，但是它影响的是元素是否显示，只有你有这个权限它才能显示。

没有就不显示，好，我们试一下，我再重启一下。好，启动以后打开浏览器，然后刷新一下，这样我先退出登录，没有任何身份，我去看任何一个帖子，一个案子都没有，对吧？我都没登录登一下。 Cc就是普通用户ayj8什么也看不见，因为他是普通用户。

好再来，然后q211这是管理员8，guq还是只能看删除对吧？那俩看不到能不能点可以点，帖子删掉了，好再来，然后扣的21这是版主再找一个可以看到，但删除看不到能不能点可以的。

好了，那么这样的话我们置顶加精和删除这三个功能我们就完整的开发完了。

总之它的功能实现非常简单，重点其实我是想给大家演示的是权限管理相关的内容，那么权限管理一定要注意，其实它包括两个层面，一个是我们在服务端真正能够过滤掉，就是没有权限的那些用户不让你访问这个功能。

第二个我们在页面上要友好一点，既然你不应该访问，你最好也别看见眼不见心不烦，这两个层面都达到了我们你对 Spring security，那么它的运用和理解就比较到位了。好了，这次课我们就演示到这里，咱们下次课再见。