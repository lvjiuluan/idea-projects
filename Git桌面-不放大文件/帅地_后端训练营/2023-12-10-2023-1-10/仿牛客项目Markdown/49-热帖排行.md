49-热帖排行.mp4

这次课我们来实现热帖排行的功能。在首页上我们显示帖子列表的时候，可以以这个帖子的热度进行一个排名，什么叫帖子的热度？其实就是一个分数，只不过这个分数是通过很多指标计算出来的。

那么不同的网站，其实这个帖子也好，还是新闻还是一些内容也好，那么他们都有排名，这个排名其实都是算一个分，而这个分它背后的指标各个网站是不一样的，不过虽然说不一样，但是它是有规律可循的，所以说我们来看两个网站他们的计算分数的公式是怎么样的，我们做一个了解，然后的话从中我们得出一些它背后的通用的这些逻辑，然后我们在设计我们自己的公式的时候，好有一个参考。

首先我们看 Hiker news是国外的一个新闻的网站，那么它排行的内容就是新闻了，那么他这个新闻的分数是这样算的，t减1除以t+2的d次方，其中 p指的是投票数，然后 t指的是从文章发布，从新闻发布到现在的一个时间间隔单位是小时，然后 g是一个系数，通常是1.51.8这样的一个数。

当然了我们不用去关注就是说一些特别细的细节，说它为什么减1，它为什么是加2，这个数为什么是1.51.8，其实都是他通过一些实际的运营得出来这个数据它比较合适，我们加减乘除乘方 log用这样的一些手段去调整数据，是为了让最终排行这个曲线变得平滑一点，它是这么一个目的。

那么我们从这个公式中可以知道这样一个大致的原则就是说。

我们这个分数是和这个内容受关注的程度，受喜欢的程度有关系的。

那么你越关注这个新闻看的人越多，那么他分就越高。另外这个内容它通常是和时间成反比的，你这个时间就是越往后推移，内容又变得旧了。

它。

很快就过气了，就排不上名次了，而且你看它这个时间外面还加了一个g次方，这样的话时间增大一点，就被它给放大了对吧？所以说随着时间的推移，它很快就会下沉。

所以总之通过它也能够大概了解内容的排行和大家喜好程度成正比了，和时间成反比，通常都是这样。

我们再看第二个网站，就是stack overflow是国外的技术人员程序员交流问题交流心得的一个网站，或者你可以叫他程序员之家，其实我们都应该了解这个网站，然后它这个公式就特别的复杂， log，然后这里边有q vos然后还乘了4 qvos什么意思？

它是这个问题的浏览数量，因为交流这个问题，他是发问题回答这个问题的一个网站，所以这是问题的浏览的数量和它成正比，然后 q answers这个是问题的回答的数量，所以说分数和回答数量也成正比。

还有 q sky这是回答的，这是问题问题的。

赞采的差就是你点赞的数量减去点踩的数量差值，然后后面这个是a scarce， a scarce是回答的站起来的叉，回答问题回答的站减去回答的叉的一个总和，这些内容都是能够提分的和分数成正比的。

然后底下这是除以下面成反比的是 q edge in ours，但是这个也是in ours，这是题目发布的时间差，就是题目发布到现在的一个时间，总之它和时间是成反比。

再一个 q update是最新的回答时间，但这里它也是通过一些加减乘除一些系数来调整曲线的平滑程度，所以你看尽管它这么复杂，其实还是这个原则。

我。

看问题的浏览量，还有一些点赞的数量，这些是成正比，其他的时间成反比，大概是这么一个意思。

好，第三个就是我们牛客我们的这个帖子分数的计算的公式是我们也是通过长时间运营总结提炼出来的一个公式，当然这个公式像这些也是它不是一成不变的，可能随着网站的规模的变大，随着业务的变化会有一些调整系数可能也不断的去调，当前我们是是这个样子。

然后是这样的是精华分我们这个帖子是不是有加精了，它会核算成一个分，然后加上评论的数量乘以10，加上点赞的数量乘以2，加上收藏的数量乘以2。

当然这里我强调一下，就是我们的这个项目，咱们没有做这个帖子的收藏，所以说这个我们就把它忽略掉，然后要对这个值求一个log，为什么求一个log的圈？

他这块也是求了一个log么，log它这算是一个技巧，它的好处是它的 log它的曲线是一开始前期上升趋势或下降趋势，它的变化趋势非常明显，到后期就趋于平缓了。

这样做的目的就是说你一开始前期做评论，前期点赞，前期去收藏，那么这个权重会高，他很能够把这个帖子顶起来，但后期的话可能你是点了100个赞，可能对得到的效果和前期点10个赞是一样的，所以说我们用log其实是给前期的这些个活动增加了权重，是这样的。

然后后面我们加上了帖子的发布时间，减去牛科技园，牛客成立的时间，你看是不是帖子发的越晚，这个差肯定就越大是吧？

那么就是帖子发布的越新，这个数就越大，它就越容易排到前面去，所以说其实也是让最新的帖子尽可能排到前面去，这么一个原则，用的是一个加法，这也是可以的。

好了，总之这是我们的公式，我们一会会用到，那么不管是哪个网站，其实它背后的逻辑刚才我也说了，我们内容的分数它基本上是和时间成一个反比，随着时间的推移，这个分数是不断的变化不断的降低，到达一定程度的时候，这个分数几乎接近于0了，根本就排不上去了，因为热度已经过了，这都是基本的原则。

当然了那分数和什么成正比，就和点赞关注你的喜好成正比。

当然每个网站它这个曲线不可能是这么的平滑，它肯定是有一些波动的，可能前期分数较低，然后有一个上升，然后又有下降，波动波动之后随着时间推移再往下下来，总之不是这么平缓，这我们可能是画的比较理想的一个状态。

但是这个也不绝对，像有些内容可能就未必一定和时间成反比。你比如说就电影电影评价的网站，那么有的电影很经典，10年20年，它的分数还是特别的高，你像什么肖申克的救赎之类的对吧？然后有些电影你哪怕是你出的很早，不是很新，刚出来的可能分数一下也是非常的低，才六点几七点几甚至五点几这样的程度都有可能。

所以说这个不绝对，但是大部分像文章问答，还有发帖这种基本上都反符合这个规律。

好了，那么大概了解这个公式以后，我们就知道了我们如何去给帖子算一个分，我们应该是以哪些指标，我们要参考哪些指标，哪些指标影响这个分数上升，哪些影响分数下降，这个原则我们了解了，然后公式也给出来，就是能算了具体我们怎么去做，我们什么时候去算这个分。

当然有两种做法，一种做法就是那当我当我做了一个操作，这个操作会影响到帖子的分数的时候，我立刻去算一下，比如说我做了一个评论，我就立刻算一下，点了个赞，我就立刻算一下对吧？我加了个钉立刻算一下就这样，但是怎么说这样的话会效率会很低的，因为比如说你发了一个大号发了个帖子对吧？

可能短时间内它是这个点赞是非常的高频的，点赞转发收藏非常高频，那可能是你他点了有人点了个赞，我们这个服务器正在算，都还没算完，又有好几个人点赞对吧？这个就很不合理，效率就很低。

再一个你算的时候你他点赞，他收藏你触发了算，我时间是在不断的推移，你这个分数还有和时间有关系，是不是？

你总不能说我过一秒我就算一下，过一秒我就算一下，这也受不了，因此这种方式效率低，然后也怎么说就是不合时宜，所以说通常我们是定时启动一个定时任务来算，比如说我半个一一个小时算一算完一回以后，热门的比如说前几页的帖子热门，那么它是保持一定的时间的稳定，然后过了一段时间再刷一下，这个也合理，不然的话你时时刻刻的算，比如说我刷新网页，刷一下变一下，这个都给人感觉也非常的奇怪，对吧？

也不太合适。

所以总而言之我们采用性能高的方式，采用定时任务的方式来算分数，实际牛客网是每两个小时算一回，但是我们在开发的时候，没有办法把这个时间设成两个小时，太久了，我们测试的话没法测，我把它搞的。

时间短一点。

我们5分钟算一回就好了。

好，然后这是基本的原则，正好我们能把上次课我们所学的定时任务能够用起来，好，我们用定时任务算完以后，有了这个分，当用户去首页上去查这个帖子，当他点按热度排行的时候，我们就给他展现一个结果，至于结果的展现就比较容易了，以另外一种形式排序，在排序里加上死杠不就可以了，对吧？

好了，了解这些原则和大概的思路以后，接下来我们就来写这个代码。好，我打开我的开发工具，当然我刚才说了我要定时的算，但是定时的算的时候，我是把所有的帖子都算一遍吗？比如说5分钟到了，我把所有帖子算一遍也效率很低，随着时间的推移，可能网站有几十万个帖子，你每次都算这么多，没必要，因为有些帖子都没有变化，是这样的，我们可以比如说我点赞加精评论的时候，我们不去立刻算分，而是把分数变化的帖子先丢掉一个缓存里，等定时的时间到了，我就把缓存里这些产生变化的帖子算一下，其他没变的底子我就不算，每次算的数据量比较小，咱们效率也比较高，所以说这样是更合理一点。

好我加到把它丢到一个内存里，丢到一个缓存里，丢到哪里去呢？最好是丢到 radius里比较合适，既然我们想往radius里存一个数据，所以说我需要先定义 P我打开 ready QQ再定义一个前缀，这里我要存的是帖子，所以我就要post。

好，然后下面加一个方法，这个方法主要是返回。

统计。

帖子分数的 t这个方法不需要传条件了，因为我们这个区域这个空间存的是产生变化的帖子是多个，它不是某一个，所以你不要传帖子ID进来这里我就直接return，然后 prefix post加上 split加上一个固定的单词是杠就行了，post冒号是杠，表示帖子的分数好。

可以了。

可以以后下面要做的事情就是在那些个能够影响帖子分数的操作，发生的时候，我们去把帖子ID扔到空间里去，比如说我加精的时候，我评论的时候，我点赞的时候没有收藏，我都要去做这样的事情。

好这样我首先打开 list，post server的controller，因为这里有加精的操作，其实除了那三个操作以外，我想新增帖子我们也给他算一个分，给他一个初始的分，不然的话他一开始你加了一个帖子，这个帖子没有初始分对吧？

他就排不上去，就上不了榜，这也不太合适，所以说当我新增一个帖子的时候，我在这就做这样一个处理，就计算帖子的分数，因为我要往 rise里存值，所以说我需要注入 ready stop。

好，然后我就在这儿计算帖子的分数，当然不是立刻算，而是把这个帖子弄到 readiness，首先我先获取 readiness，key YouTube get更爱去pose高k好，接下来我就要把帖子ID，帖子ID是谁呢？Post点ID对吧？把 post点ID放到 radios里，那么radios有那么多数据类型，我放到哪个类型里呢？可能有的同学会想，我这个放到队列里比较合适，先后发生的顺序放到队列里比较好，但其实放到队列里不是很好，为什么？你想一想，比如说我有人给a帖子点了个赞，我把a放到对这里没有问题对吧？

然后这个时候有人就对b点了个赞，我再把b放在队列里没有问题，这个时候有人可能还对a点赞，然后又对c点赞，又对a点赞。

所以说队列中会存这样的数据，你算的时候比如说你按照这个顺序算，你先算a你后来中间一 A又算了一遍a而每次我们都是把a的所有的指标都统计一遍，你相当于这三次算的是重复的对吧？而且我这只是举了一个简单的例子点三次赞没准在几分钟的时间之内，他点了几十个赞甚至更多个赞，你重复算了那么多次，效率反而更差了，对吧？这是其一。

再一个我们用队列来存这个数据，更多的是为了保证一个顺序，但是你看 a它有顺序吗？他在最开始也点赞了，最后也点赞了，中间也点赞了，你说他到底应该是先处理还是后处理，这就说不清楚了。

因此他有这种重复的操作的情况出现，但我没有只需要算一次，我们要去个重，而且我们又不关注顺序，你说把它存到什么里好，显然不是队列，而是因为site这个数据结构你应该知道它是不能允许重复数据存在的，重复数据会被剔除掉的是吧？

好，所以我把它存到 site里， read this template。Ops for value above formula for set，然后 add read this key。好，我要存的是post ID。可以了，这是一个地方我处理了。另外我们 controller还有一个请求，就是加精的时候分数也会变，也会影响分数，所以我也需要做类似的处理。置顶不用因为什么置顶的话，它默认就会排到最顶上，它不算分的，所以说置顶不是去加分的，只要你置顶排到顶上，它不算到分里来，加丁是要加分算分的。

好，我就在这儿做一个处理，我就另起一行把刚才代码贴过来，也是取 Key，然后的话这里边存的是帖子ID，帖子ID是谁？就这个ID删除不需要了，因为这个帖子都删了，你算的分也没有必要，他都不展现了对吧？

不用算了，就是discuss post control了，那么评论的时候点赞的时候也会要做这样的事情，所以说我再去处理评论，他们肯抽了，当然我也需要用到readiness注入，那么当我添加评论的时候，这个帖子分数就变了就应该变，所以我就需要做刚才类似的事情。

然后我是对帖子进行评论，我才去给他核算一个分，所以说这里要做个判断，如果说我评论的类型帖子这个时候我要去计算帖子分数，把刚才代码拷过来，拷在这儿同样的方式获得 Key，然后这里存的是帖子ID是谁就这个好，这是评论的时候的一个处理。

然后还有点赞，我再打开like controller也是注入ready template好，然后点赞的时候也是做加分的处理，我就在就这一个点赞的方法对吧？就在这最后的位置加分。

当然这个时候你也需要做一个判断，如果我去我是对帖子点个赞，我才去算这个帖子的分数，如果是你对其他的内容点的赞我不管。

好，我这样我判断一下，如果 Entity tap，如果Entity type等于Entity type，post，这个时候我就要计算帖子分数，我刚才代码拷一下。好，这个时候帖子的ID是是谁找一下，是他POS的ID我都传进来了。

好可以了，现在就是我们的项目中，但凡能够影响帖子分数的地方，我都做了这样的处理，我都把贴在地放到了集合里，下面要做的事情就是我每隔一段时间就要算一下，对吧？

我就这要用到定时任务，我们就可以利用我们上次课所学的筷子，而筷子我们在使用的时候怎么用第一步不是得写 job对吧？我们先写一个job，我在科尔包下新建一个类叫做post god risk drop好。那么这个类它的作用其实很直接了，就是帖子分数刷新的一个任务。好我要实现这个重要的接口，另外我再实现一下常量接口，一会也是有用处的。 Community constant我需要添加 Shop未实现的方法，然后对它进行一个实现。

那么在实现的时候，我们定是任务启动的时候，你最好在关键的节点记个日志，这样的话将来万一他出现了什么问题，意外中断了，我们还有一个追查的根源依据，所以我先实例化 logo，当前类点class好，logo有了，然后我需要注入一些电，我们计算的数据来源来源于rides，所以我需要把rides他们注入进来。

好，另外我们在计算的过程中可能还要查帖子，查这个点赞的数量，然后计算完以后，我们还要把最终的最新的数据同步到搜索引擎里，因为你帖子数据变了，搜索引擎也要跟着变，所以我们还需要注另外的这些病有关的这些病我注入一下，先注入 discus，post service。

好，然后再注入like service，然后再注入 you last take search service。好，先注入这么几个病，注入完以后先不用着急去实现这个方法，我还要初始化一个常量数据初始化什么。你看刚才我说了，我们要计算留客的分，最终的话你要由发布时间减去留客纪元，纽克纪元就是纽克成立的日子，这是一个常量固定的值，但它又比较特别，因为它是一个日期，所以我们需要对它初始化一下。

好，我在顶部说明一个静态的常量，final，然后日期类型date接口叫它报错的意思这是一个常量，但是你没有初始化，所以它有个提示，我需要初始化，我在静态块里初始化一下，因为常量它只需要初始化一次，好那么我就写了它等于 New simple date。Format我要先给一个格式，然后点plus传入一个字符串。

那么 simple day的format，它能把这个日期转为字符串，它也能把这个字符串解析为日期，但前提是你要指定格式匹配的格式，然后得到这个日期以后复制给常亮就ok了。当然这句话它需要我们对异常进行处理，所以我先再开始一下。

好这个past里面的需要写上的满足这个格式的日期，那么牛客成立于2014年-08-01，然后这个时间就000其实我们主要是关注这个年月日不用精确，到时分秒就00代替了，然后如果说我捕获到异常的时候，那怎么办？

我就抛我就抛出去了，说初始化游客既然失败，再把原始的议程带上，好这就行了，那么当你正常的初始化完产量以后，他这就不报错了，这里我写了注释就是旅游科技园，一会运算的时候好用它，好有了牛科技园以后，下面我就可以来实现定时任务了。

要实现定时任务，首先我得从reds里取那些值，对吧？然后我才能一个去算，我得先有 key。

Already is key YouTube get post scar k然后因为我们是每一个k都要算一下，我们要反复的去做这样的操作，所以我用棒的operations来处理，因为它不是一下就能处理完。的棒的 site operations。变量名称叫operations。等于read this template。棒的site和ps好，然后把 reads k的传进去。 Ok了。好，接下来我先判断一下，我们 Redsk对应的空间里它有没有值，万一最近没有，比如说半夜的时候对吧？都没有人访问这个社区，没有任何人做任何操作对吧？你就不用算了，所以看一下有没有数据线。

 Operations、点size，如果说 size等于0表示说没有任何变化，这个时候我们记个日志把任务取消掉就直接入退，不做任何处理了，但这里面要给一个日志 log点Info就常规日志说这样写任务取消，然后没有需要刷新的帖子，否则那就是需要刷新了，这个时候我在开始刷新之前和刷新结束之后，我都记一个日志，这样将来如果说我们发现好像任务执行的速度挺慢，我们可以具体看一下前后它到底支撑了多少时间，通过日志能看出来，但你前提得有个日志，拉个点因素，然后说任务开始正在刷新帖子分数，然后后面我加上 operations点size。好知道我现在要刷新的一共有多少个帖子，当我刷新完以后也是就在logo一下，这儿我继续说任务结束，然后说帖子分数刷新完毕，完了我们在这两个劳务之间去处理，当然一个处理你得循环了，我就why operations点size大于0，只要你这个rise里有数据，那我就算每次算我调一个刷新方法去刷这个分数，我就list点reference，但这个request方法是我一会要写的，我先在这里先调一下，一会再补充，然后需要传一个参，就是把帖子ID传给他怎么办？

就operations pop。因为 Operations它是集合有个方法叫pop就弹出一个值，每次弹出一个值就少一个值，直到弹光了，循即这个循环也就结束了，对吧？就是这样。当然了我们这个risk要的是一个涨数，所以这里我们转型一下，因为它默认的话它以为是个object，我把它转成影推者。

好了基本的任务的代码逻辑结构就是这样的，剩下的事就是我们写一个rest方法来刷新一个帖子的分数就ok了。那公式有比较简单，再写个方法。Private wide at home reference。好，这里面需要你传输帖子的ID Cos I好，然后我首先先把帖子查出来，discuss post，调 CS，然后办的discourse d白d传入。

好，然后做一个判断，如果说post等于no，万一说这个帖子有人点了赞，他是要算分的，但后来被管理员给删了对吧？这个时候没查到有这样的情况存在怎么办？我们要给一个提示，然后就不记就算了。终止退，每天之前给个日志我们好追溯，就l说该帖子不存在，然后我这里写上不存在ID等于加上post get ID。当然直接POS代替就完了，这样给个明确的提示，然后接下来我就要开始正式算分了，而这个分和什么有关？

它和你是否加精有关，和评论的数量有关和点赞的数量有关，我需要先把这些值先取到，然后我再去用这个公式来统一来串。首先我要得到一个结果它是否精华是否加精，这是一个布尔值，是否加精是个布尔值。 Wonderful等于就看 Pose的叫get status。

如果它等于一就是假精的，否则就不是，我就判断它是不是等于一，然后还要取评论数量，这是一个整数，我们从帖子对象中就能得到，他说这就带了，不用查了，然后还要获取点赞的数量，这是一个long类型 like come等于我们第二like service去查，然后它里边有个方法叫find，Entity like count。

那么我们需要传第一个是Entity type，那就是Entity type，post帖子类型，第二个是对应的实体的ID，就是帖子ID，就得到了点赞的数量，那么这三个值有了以后，我们就要把它运用到这个公式里 log，然后这些值相加乘以相应的系数，然后最后再加上这个时间的一个间隔，好，这样我先把 log之内的那几个相加的值先算一下，其实我们通常习惯于称其为权重，我们习惯于称括号里这部分值是一个权重，然后的话再加一个时间，所以我先求权重的值，注释计算权重，这是一个小数。

 W等于。

首先我看一下它是不是精华，如果是精华，我们固定给加75分，给加75的权重值，否则简单粗暴那就是wonderful。然后如果是加就加75，否则就加零。好，这是精华的部分，然后 Comment com是评论的部分，评论要×10，再加上点赞 like com要×2，这个权重值有了以后，我们就要去详细的计算了，计算什么总的分数，你要等于帖子的权重加上一个什么距离的天数？

时间间隔，但这个时间间隔我们是以什么为单位？是小时秒，还有什么为单位？其实是天以天为单位，要不然数太大，好我就算 double死杠等于。

然后你算的时候是权重值要求一个对数，然后的话再加上时间间隔求对数，我们调用 max，然后的话是log10是以10为底的对数，然后你还不能直接求 w这样不好，为什么？如果万一说 W得到的值是小于一的，你求求对数以后这块能得到一个负数，对吧？你没有分就没有分，大不了为0，你不能给他整整出一个负分对吧？这个不太合适。

求对数以后最小值应该就是0，不能出负的怎么办？我们可以这样，不要直接写w而是写成什么？写成 max点，max，然后w一。好，我们先看里边这部分，max点max，w一就是返回这w和一之中较大的数万如果说w大于一分肯定就是返回w算w的对数没问题，对吧？如果w小于10~1之间，那就返回一算一的对数，一的对数其实就是0，对吧？那就是最小的值，我们最终就能得到一个0就完了。

好，然后这是求对数求权重的对数，然后的话加上时间间隔和定期太长了，那么我需要获取帖子发布时间，再减去牛科技园，帖子发布时间是post点，get create time这是date，然后我点get time。

得到一个浪字，得到一个毫秒这样好减，然后减去云科技园，然后点它也是对的点，get time两个毫秒相减得到的是毫秒值，但我要的是天怎么办？换算。除以我1000×60不是60就是3600×241000这表示换算成一秒对吧？然后一小时是3600秒，乘以它是3600秒对应的毫秒，然后乘以24就是24天。

所以我这样一除的话，其实就是换算成了一共是多少天了，这就可以有了这个公式就可以了。有了以后我们需要把帖子的分数更新一下，然后更新帖子的分数，那么我就调用 Service，然后 update scar，但是我现在还没有 up的死高这个方法怎么办？

我们还得去补充一个方法。

好，那么我就打开迪斯卡斯boss的map，好，那么在这里就模仿了 update，补充一个方法改分数，这是update score，参数是ID更改的值是提高，好，然后我们再打开麦克，然后把这个方法实现一下。好，update，scar。Update the distance post said scar等于scar where I didn't ID完了。

好，然后当然了你麦克里有了，对应的service里也补充一下，我再加一个方法，这个方法之内很简单，就是return discus boss的map点，update，sky，把ID传进去，把sky传进去，好，我把这个方法都补充完了，然后我们再回去接着写这个任务。那就是discuss post service点，update，score。

然后把帖子ID post ID传入进去，最新的分数传进去可以了。

然后别忘了我们还要同步搜索的数据，不然的话搜索的时候就出来一个特别陈旧的纸，这就不合适了，我们就同步把搜索的数据好，我就调用 elastic search service要点，它里边有个CF方法对吧？你需要把实体传进去，但是这还不行，因为实体是我们早先查到的，它里边的分还是旧的分，你怎么办？我把实体 Site score把这个指标更新一下，从最新的然后再去保存，那就更新过去了。

好了，这个任务到这我们就写完了，就符合我们的最终的公司的要求，写完以后这个任务要想能够正常运行，我们还得去做配置对吧？我再打开 Class can figure配置的方式和上次课我们写的这两个事例是类似的，我就copy一下，然后在这基础上去改。先写个注释，这个是刷新帖子分数的一个任务，当然这个并注解得让它有效，然后这个方法名得改一下，不然重复了不行，我叫扣死他。

Score，然后with rest drop detail。这个方法它的表达的含义要直观一点，然后这里边我new一个fact been然后这个地方类型要写成刚才的类型 Post，scar，refrax job的Klus，给他job起个名字，我就叫poste。Scar。Reference。Drop然后分组，我希望我们整个应用正式的任务都是统一的一组就可以了，这块我就叫community drop growth。

然后这两个参数是出没有问题就这样。好第二个还要配一下崔哥， B也需要注释去掉，那么崔哥也得改名字改成还是跟刚才类似。 Post Scott reference，trigger。然后他所需要的照片的q是前者，我把拷过来poss的词杠，refresh drop detail。这传的就是他，然后当然崔哥也取名字， Pose的是高瑞福s崔哥。

然后这个组我也希望整个项目正式的处罚器都是同一组，肯定那天催着group好了，这样的话对于刚才这个任务，我这两个地方都配好了，配好以后这个时间间隔再配一下，刚才我说了我希望它是5分钟执行一遍，这里面我们需要传的是毫秒，我这样写1000×60×5，那是60秒，然后乘以55分钟没有问题。

好了，现在这个任务也就完成了，完成以后我们来先不去写展现的部分，我们先跑一下，我先点几个帖子什么加精，然后这个点赞试一下，看这个分他能不能给我算出来。如果说没有问题，那么我们再再继续。

好，那么我就启动一下这个服务，没有需要刷新的帖子，这里面写错了。然后这怎么还有 sq二，我把再重来一遍，太太乱了，太烦了。应该是测试类当中有的注解我没有去掉，应该是 service阿尔法service我没有注掉，这样我一启动它就在运行了，这不需要了把它注掉，要不然太烦了，这样我就把注解注掉就好了。倒无所谓，我不主动掉它是不会触发的，但这个是定时任务，它会自动的去跑，就是烦人把它去掉。

好，然后我再看一下这个表，因为我们刚才启动一下这个服务是吧？他提示有问题，我写错字了，没有需要写错字刷新的帖子，然后我们刚才启动了服务以后，它根据配置应该会创建插入数据到表里，我们看一下表里有没有这个数据确认一下，看这个照片。Post scar reference job没有问题。看崔哥reference崔哥没问题，ok这两个有就可以，他就能跑起来，好我们再来。

好了，我这个服务就已经启动起来以后，我得打开浏览器，我去对某些帖子做一些操作，这样我登录一下，登录以后，jue的帖子我不管，我先发几个帖子，第一个比如说AA a简单点发布，一个再来一个BBB再来一个 CCC好了，然后我一共新发了三个帖子，下面我要对三个帖子做一些操作，你比如说怎么说 Cca我不管了，我要操作 BBB我给他做一个评论，你好，完了只做一个评论，好，再回到首页，然后对于 AAA我要对它做一些处理一些评论， hello，然后再来一个how are you再来一个做了三个评论，所以他的分应该比刚才要多一点，再一个我还给他点赞，除了点赞以外，我还要给他加个精，加精的话我得换个人换一个。

版主21我。

给 AAA加个经验，然后我用用户也给他点个赞，也给他做个回复，欢迎。

所以如果算的话应该是AAA帖子的分，就在这三个帖子之内它应该是最高的，其次是BBB然后是CCC因为他们的时间几乎是一样的，在一天之内，其实这个时间的权重是一样的，因为我们那个时间相减是按天来算他们天数一样的，那么其他的地方就是ab分比c高，最终排的话，如果按热度排的话，应该是a在前，b在后，现在是b然后现在是c应该是这样的。

当然了我们得看一下，现在他可能还没有更新，我们查一下差异他们的反叙一下，倒叙这三个帖子，那么他的分数有了，已经有了，可能刚才就触发了是吧？

我们看一下，真的触发了到了5分钟了，你看这刷新完毕，刚才计算了3个，刚刚好就刚刚，然后你看这个分数，AAA1823 BBB18221821是有差距的，但这个差距不大，因为我们并不是直接把这个数量乘以一个几一加让它差距很大，因为我们对它做了一个对数运算，所以让这个数其实差别不是那么大，你得做好多评论好多赞，他的分数才能够遥遥领先，而不让他这个分数突然一下几个赞就特别爆发的那种感觉，这是ok的，现在我们看定制任务没问题，我们做的操作没问题，最后就是剩一个展现了，展现的话我们要做的我们在访问首页的时候，我能当默认是按照这个时间倒序来排，如果我点最热的话就得按照这个分数来排。

当然了页面还是利用这个页面就可以了，只不过我点这的时候需要给服务端再传一个新的参数，让它做就有一个新的排序的模式，所以我们需要对之前的代码做一些重构，让它能够支持这种排序，而这个重构我们需要从这个数据访问层就开始改起。好，你看我们之前查询帖子不是用这个方法查的吗？对吧？

然后这两个是分页的参数，这个是优质ID，它的排序没什么关系，然后之前我们在这里头实现的时候，我们排序的方式是写成固定的方式的，首先根据类型来排，那么置顶的会排到前面去，无疑，然后其次是按照时间来排，现在我们得能支持两种模式，我这样处理，我再加一个要给它加一个参数，叫order，mood就是排序模式，然后先加上 order，mood默认值是0，我就还是按照原先的排，如果你传入一，我就希望按照热度来排，我就按照热度给你熬着办一下我实现的时候怎么办？

也很方便就判断一下你传的条件，然后的话动态的去拼这个奥特曼就可以了，我就得加一个if你的判断，然后这里有写test等于我们得看 order more的，如果说0它=0，我们按照原来的方式来排，不用改。

我再copy一下，如果说这个奥特曼的等于1，比方说我希望按照热度来排，我就order by还是优先按照态度把置顶的排到前面去，其次才按照style，然后倒叙，然后万一说两个帖子分一样怎么办？你再按照时间的倒叙，所以这个时间还保留，就这样一个结果。

当然你这么一改以后，它调用的地方你就得就都得改了是吧？我们搜一下 Find uses看看哪个地方掉下来了。你看我们之前做了一些测试，那么在测试的代码里我们调了这地方得改，不然的话他就报错了，没有办法。加上一个0，原来是默认是0对吧？加上个0，或者你把它注掉其实也可以，因为这个方法我们都已经测过了是吧？其实不再不是那么需要了，然后这里头也是加个0，除此以外还有 Service， discourse，post service这里也掉了，好，我们 service的话也得重构一下奥德姆的，然后把奥德姆的传给迈克就好了。

好到现在我们就把数据访问层还有业务层就成功好了。

然后你还得看一下这个业务方法都被谁调了，掉的地方我们也得改，因为现在你加了个参数就报错了，也是搜一下find uses，好在只有一个地方掉，就是home control这里，所以我们只需要改这一个地方就好了，打开 home control了，好，我们需要重构一下这个逻辑，这个参数不能平白无故的来，它从哪来，应该从页面传过来，当我点最热的时候传过来，当我点最新的时候传过来，对吧？

传进来0或者是1，所以我需要给请求的方法再加一个参，就叫我等下，但是你要注意，我们首次访问首页直接敲路径访问的时候，直接敲网址访问的时候，我还没点这两个东西对吧？我就不传餐，这个时候怎么办？

这个时候如果你直接这样写就有问题了，你没存在那就报错了，所以我们就要给他一个就是声明，要加上一个request，power注解对于参数加以声明，我声明它的name就是order food，请求参数中outward，另外一个我给他一个默认值得放到外流，等于0，所以说如果你没传进来，默认就是0，默认按照这个就原先的方式时间的方式来排序，这不影响。

好，那么我们在查询的时候就需要把它传给 service了，那么这个方法就做了一个改动，好做了一个改动就可以了。

另外还有这个地方，我们也需要在路径上把奥德姆的拼过来，就是奥德姆的参数我们是通过公众号传过来的，不是通过请求体传过来，是通过问号传过来，因为如果你通过请求里传，你要用pose的请求，用get不方便传， get适合拼一个问号，拼问号的话，我们把它也拼到路径上，这样的话我们路径返回到模板，模板会用到这个路径，在这基础上再去拼分页的参数。

那么你注意你在这上拼分页参数的时候，不要把奥德姆的给它丢了，不然的话就是说你分析以后奥德姆的串了也会有问题，所以把这奥特曼的就拼在这，也当做路径的一部分，就奥德尔 mod等于然后加上参数，最后我再把奥德姆的装到 model里，然后传给模板上要用 h h图，然后的话好点。

好到这儿这个方法我就处理完了，就是一些细节。处理完以后，最后我们就来处理首页index点tml搜一下，在这个页面上我们找到这个地方最新最热，因为你点它才触发排序的方式的改变，对吧？找一下就在这了，就在这了。

好，我们希望把超链接先处理好，th冒号，这里我需要练到的路径还是index，然后需要带上一个参数，就是order mode，然后等于0，完了同理最热跟他一样就改一个值就完了是吧？改成等于一就可以。

另外你还要注意，我们页签它默认的是点亮了最新，但是当我点最热的时候，你是不是得把奥德木的变成了一，你得把它点亮，我再点它又把它点亮，这两个页签把谁点亮呢？把谁点亮就在谁身上加active，现在不能写死， Active你要动态的加怎么办？我们可以根据刚才我在model里装的奥特木的装在model里，我们在模板上不就可以直接访问吗？我访问奥特木的判断它等于0，我就把它点亮，等于就把它点亮对吧？

那就克拉斯动态处理一下就好了，th冒号克拉斯，然后因为我需要拼一个变量，所以我加上双数线，然后这里边写一个表达式，奥德姆的对，如果说等于0，那么我就在这儿输出IQ，否则就什么都不输出，好，这个同理到这目的等于一。如果成立我在这输出active，否则什么也不输出。

好这样就可以了，处理完以后我们再试一下，我把应用重启一下好了，启动以后打开浏览器刷一下首页，默认是按照最新的方式来排序， C BA，因为我先发的是a再b再c倒叙 CBA没问题对吧？我们不用看别的帖子，我们只看这三就完了。

好，然后这是最新我点最热，你看这个路径最热， index output等于一没有问题，然后你看我点分页，是不是分页条件上就带上order等于0，因为当前默认是最新的，也没问题，然后分页参数卡瑞也在，好，现在我点最热点，最热以后我们不用看别的帖子，还有置顶什么的不用看，我们只看ABC，你看是不是a在最前面，b在其次， c在最后面，因为这三个分就这么算的，然后你看他这几个帖子排到他前面，因为这几个帖子都是置顶的，优先的，除了这几个以外，那么我很久没有发新帖子了，这个是今天新发的，其他的都是好多天以前发的，所以从时间上来说，越新的排的越排到前面去，它比别的就优先排到前面去，收视率更高一点，就这样好了，那么这个时候你看最热被点亮，然后你看分页的条件，你看左下角路径，index automotive等于一，是吧？

所以你点第二页的时候，依然是最热被点亮，依然是处于这么一个按照热度排序的模式，末页也是最热被点亮是吧？然后点最新，你看分页条件，奥德姆的等于0，然后第二页最新依然是保持最新，末页依然是保持最新对吧？说明这两个状态切换没有问题，不只是说数据的排序没问题，另外那么与之相匹配的分页也是没问题，并没有就乱掉。

好了，那么这次课我们就把热帖排行就搞定了，那么。

总之实际上并不难，那么就是背后的计算排行的算法你也不用背，但是你一定要有这个意识，我们要算这个东西，我们需要考察关注哪些指标，背后有哪些基本的原则搞清楚就ok了。

然后将来工作的时候，比如说你算某一个内容的分数的时候，可能一开始这个公式设计的并不好，就是这个曲线并没有那么平滑，可能会出现一个断崖式下跌，或者是某一个指标权重过大，很容易被刷分的情况，那么需要你不断的在实践当中去调整这些个参数。

然后的话一是避免刷分，二是避免这个分数有一个大的跳跃，基本上让它更平滑一点，更合理一点就ok了。好，这次课我们就演示到这里，咱们下次课再见。