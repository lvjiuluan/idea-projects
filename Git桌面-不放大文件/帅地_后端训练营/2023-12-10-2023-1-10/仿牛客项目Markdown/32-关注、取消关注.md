32-关注、取消关注.mp4

这次课我们来实现关注和取消关注的功能。那么这样的功能非常的简单，我们平时在上网的时候经常会有这样的操作，大家都能理解。我们开发时就是这个需求，我们是其实关注的是两方面，一个是我们要实现关注和取关的功能，再一个我们还要在用户的这个主页上统计出他的关注数和粉丝数，统计出一些数量，这是两方面的功能。

然后我们开发功能的时候，这个关键是你要把这个关系搞清楚，我们在写代码的时候，尤其是存储的时候，那么我们很依赖这个关系，那么这里我说的很清楚了，就是说如果a关注了b那a就是b的粉丝，这很好理解对吧？ B就是a的关注的目标，这也很好理解，你注意我们在纯数据命名的时候，那么我们把粉丝习惯于叫follow，我们习惯于把这个目标叫follow，所以说这两个单词代表的含义你要理清楚。

然后第二个我关注的目标，其实我可以关注一个人，我也可以关注一个帖子，我也可以关注一个题目，我也可以关注一个课程，其实我可以关注很多东西，所以说我们不要把这个程序写死，我们在实现的时候也是做一层抽象，我们关注的目标把它抽象为实体安贴点。

好了，你像关注这样的功能，其实也是一个非常高频的功能，所以说那么我们在实现的时候也会把这个数据存到reds里，为了提高性能。

好了，下面我们就来实现这个功能，当然我们主要是分两大步，第一步搞定关注取关，第二步实现统计。因为我们要把数据存到radio，所以说我还是先从 Key开始规划起，事实上你把 key规划好了，那也就清楚了我将来数据是以什么形态来存，那么开发业务组件的时候这个就更清楚一点。

好，首先我先上面一个前缀。然后叫 following是我们关注的目标，我这个q就叫sorry。另外我再声明一个前缀叫sorry，这个地方就叫follow，我上面两个前缀就意味着那么我要存两份数据，其实和我们点赞一样，一个数据是为了存我们这个业务相关的数据，一个是为了统计方便这里也是那么我点我关注的时候，我关注了某人，那么我把这个目标我的目标存下来，另外那么我关注的那个人，我就是被关注者，不是他就是被关注者，那么我就是他的粉丝，那么我以那个人为key，把我也存进去，把我周围他的粉丝存进去，这样的话从我的角度统计我的目标，很好统计，从他的角度来统计，他的粉丝也很好统计双方的一个相互的关系。

所以我们需要记两份数据，为了统计方便，好，接下来我就写两个产生拼 key的方法。

第。

一个是某个用户关注的，注意他关注的是实体，不一定是什么不确定。

好，我写一下，我希望 key是什么形式，我希望是这样，因为你是关注的目标，所以说它是以 follow me开头，然后的话冒号后面因为我们关注的是实体，所以说后面我跟的是 uziduzid表示谁关注的，谁关注的，然后关注的是哪个实体，把类型拼上去， key是这样一个构成。

我存的时候 key对应的value我存一个有序的集合最sad，而这site当中我存的是ittid因为这site可以排序，那么它需要有个分数，我以当前时间的整数形式作为分数，那么为什么这样去设计？

首先你看是某个用户关注了某个实体，所以这里边一定要体现用户和实体的关系，你看这里用户有了实体也有对吧？

用户关注某个实体，那么我是按照分类对他从 t上都做了分类，你关注的是人哪还是帖子做了分类，而这个值是具体你关注的什么东西，所以这个值是一个实体的ID，为什么要以当前时间作为分数来排序？

因为可能有的时候我需要统计我关注了哪些东西，我把它列举出来，按照先后顺序列举出来，可能会有这样的需求，所以说我们这样去处理的话，能够应付更好的业务需求的变化。

好，既然是这样一个key和这样一个value，所以能够把这个方法写一下时代的一个试卷，然后我就要get following。

 t。

那么很显然我这个参数需要传入的是因为你是过道k我这个参数需要传入uzid和idd type，而it ID是我们具体在存数据的时候，那么得到的 t我们是要提前传进来，好了，下面我就把 t拼一下，首先是前缀加上分隔符，然后加上按照我的要求是uzid然后加上分隔符，然后再加上安TT态度。

好了，

 sorry关注的目标， key我们就这样去拼好了，数据形式我们也做了一个整理。

再来那还要记录一份数据，也是某个用户的拥有的粉丝。好，我希望 t的形式是这样的，follow粉丝，然后那是某个实体，不是用户，某个实体拥有的粉丝可能是一个帖子，可能是一个题目等等，这里面我得写上实体 itdti对吧？

然后冒号intt ID itt type和ittid能够唯一的标识一个实体，那么存的时候这个值依然是有序集合，是为了更好的统计，按照时间统计，集合里存的是什么呢？

拥有的粉丝，其实这个好理解粉丝粉丝就是人，所以这里面存的应该是uzid那么我也以这个时间作为分数来存，这样我就很容易统计出实体他的粉丝，他的粉丝都是在什么时候什么时间关注的，这样就比较方便。

好，那么把这个方法来写一下，就是get。

 follow t。

那么这个参数就应该是type和ID对吧？我就return这个前缀，加上分隔符。加上 NTT太加上mttid好了，到这儿，我们这两个p它的拼接的方式就声明完了，那么当然了这里边可能是你没有开发过这样的功能，那么在对 k的处理上可能没有经验，所以说一开始可能会觉得比较别扭，我希望你把就这一段我刚才所说的我所做的解释，你好好的琢磨一下，把怎么说 key的设计的方式最好能够把它理清楚。

再一个这两个方法名就是关注的目标粉丝，他们是非常的单词非常的接近的，很容易就混淆了，你把它也理清楚到底什么是目标，什么是粉丝理清楚， follow跟follow的区别搞清楚。

好，那么理清楚以后，那么接下来我们就可以开发相关的关注以及取消关注的业务，那么这是一项新的业务，所以说我在包下新建一个类叫follow service。给它加上一个注解，另外因为我们要把数据存到res里，所以说我把res template注入进来。

好。

那么接下来我就来实现关注和取关的功能，这两个功能还是有一点点麻烦的地方，所以说我们别在一起写了，我们分成两个方法来写，这样直观一点，先写关注 follow。

那么 follow关注的时候你要传入用户ID实体，使用户关注了某个实体都要传进来。

好。

那么传进来以后，我们在存的时候，那么是要存两两份数据，一个是关注的目标，一个是粉丝，那一项业务有两次的存储，所以说要保证这个事物，所以说我还是要这样写。

 new session高度。

因为我们方法不需要有返回值，所以说我就不返回了。

首先我们先构造这两个key，一个是follow目标的key。我就write is key YouTube点get follow with key。那么你需要传输uzid还要传输itt type。

好，再来。那么在构造粉丝 follow up t ready，sqto点get follow key需要传入ittittid这写错了，那么有了key以后，下面我们就连续做两次存储的操作，因为你是关注的时候你要往里存一份数据对吧？我就当然我这里得先启启用事物点Martin，最后 Operations点 ex EC对吧？

这中间我们做两次存储的操作，那么就是office点 UPS方有序集合 c set，那么往里添加数据艾特把 t加进来，我先添加就是关注的目标，关注的目标里边存的是什么？刚才我们不是总结了吗？它里面存的是实体ID，另外还要有一个分数，分数是当天时间实体ID Andy tid然后再来一个分数，当天时间我们把它转成毫秒数 Cs他们点 current time，minutes，好，这样就行了。

好，另外一个 operations还是 for this site。点ID，然后这个是follow key， follow key里边存的是什么呢？是优质ID。好，然后也需要存上当天时间作为分数以用来排序。好了，关注我们这个逻辑就已经实现了，也不复杂，反正要注意事物就是了。

好，那么接下来我们再把取消关注搞定，取消关注其实代码逻辑和它是类似的，无非就是这里是添加那个是删除而已，对不对？P都是一样的，所以我就copy一下，然后取消关注，我给它取名叫Ann Salo，还是这三个参数不变，还是要这样管理事务，还是这两个t不变。

然后启用事物以后，这个地方我不是添加数据，而是删除为目的。

那么。

 remove的时候你要传入key，你要传入你要删哪个值，这个分数就不用了，因为你要删就不用指定分数了，这个也是 remove。

然后 t值分数不要了，好了，关注取关的业务逻辑我们也就实现了。

那么下面我们就可以开发这个视图层，首先我们需要在CTRL那里处理，关注取关这样的请求，因为是一个新的功能，所以说我需要新写一个CTRL，那么我在这儿新建一个类叫follow CTRL放大一点，然后加上注解 controller，那么这个类上我也不写这个路径了，我直接在方法上写路径。当然了因为我们是做关注，所以说你肯定是要把 Follow service注入进来对吧？注入以后，接下来我就要实现关注和取关的功能，我们也分两次请求来处理，把它拆解开。

注意这个功能我们在操作的时候是一个义务的，我们在页面上一点关注，整个页面不刷新，整个页面不刷新，然后我们做局部的刷新。好，所以说我请求的路径，我的写成叫follow，然后请求方式这是一个提交数据的过程，所以说是post，因为是异步的，所以说加上保底的。

好，那么你关注的时候，关注肯定是我当前登录用户去关注某一个实体，所以用户ID不用传，我们取当前登录用户就可以，而实体你要传进来，为了获取当前用户，所以说我还要把 Host注入进来，我首先要做的事情就是应该获取当前登录用户对吧？

为了后面使用方便，取到以后那就关注我就调follow service点儿 follow，然后把you这点get ID重去int太怎么去it ID怎么去这就行了。

当然有人说我这个地方如果没登陆，你注意你应该把这个方法就是用拦截器做一个检查，强制它登录以后才能访问，我就不补充这个逻辑了，因为这个逻辑我们之前演示过，你自己把它补充完善就好了。好，那么关注完以后我就要给页面返回一些这个消息，那是异步的请求，所以我返回一个Jason get接近它，零表示成功，然后给个提示说已关注就完了。

好，这个关注就处理完了，处理完以后取消关注其实和他一样就调的方法不一样，但路径你得改一改。这里我改成安发了对吧？

然后方法名改成叫iPhone，然后取消关注的时候也是某人取消对某个实体的关注，某人是当前用户，实体传进来，参数不变，然后当前登录用户我们也是这样先获得，然后这个地方你要调的是Anh，Farlow的方法，然后按Farlow的时候也是把这三个参数传进去，他去处理逻辑，这就可以了。

然后这个地方来说已取消关注，好这个CTRL咱们也就实现完了，实现了以后，那么就是说我们其实完整的网站的业务应该是很多地方都能去关注，这里我就不挨个去写了，那么我们只演示一个地方，你能把它搞明白，其他地方大同小异，我们就演示一下一如何关注一个人，那么这个关注人是在那个人的主页上有个关注按钮点一下就可以了。

所以说我们需要去处理主页的关注的逻辑，我打开主页 profile。Dash temple。那么这个关注按钮很容易找到，关注它。

好，关注的按钮其实它所对应的事件已经由GS处理好了，这是我们给大家传静态页面的时候，静态页面就带了。

好，关注按钮的逻辑它是定义在profile点js里，我们打开 Js看一下，你看这个逻辑都有，这是关注按钮，单击事件调关注方法，然后这个方法里首先获取当前的按钮，然后判断了如果这个按钮的样式是这个应该是一个灰色的样式，那就表示我没关注，然后的话不这个表示这应该是一个蓝色的样式，好像表示说我可以关注我就去关注，如果否则它是一个灰色的样式表示说我不想关注了，我可以取消关注，灰色的时候我可以取消，我就取消关注。

所以它是通过样式做了一个直观的区分，是你能关注还是不能关注，然后做了不同的处理。

然后关注的时候它这里只是做了一个效果，它把这个字变了，变成已关注还是关注它，根据你关注的状态，然后把样式做了，改动这里面样式我们不用处理了，这个字的显示我们也不用处理了，我们需要做的是关注时和取消，关注时你把逻辑补充完善就行。

好，无非就是发一个异步请求对不对？那么这里做一个处理，首先是关注到了点pose，好，然后先写路径， context pass，然后是 follow，其次是参数，因为我当前关注的是人人实体，它的类型我看接口定不定一样好。

我们之前订了订阅的实体，只有帖子和评论，我把这个人也加上去，那人就往下排，三实体类型是用户，然后的话这个是tap。

u等于3，

所以这个地方回过来我们传的安贴贴太，我就写死成三，刚才写错了，冒号三，当然还得有安 nttid对吧？冒号得有一个值。

好， ID我们需要从html中获取，你看怎么取？目前我们页面上没有显示ID，没地方取，没地方取我可以自己做一个处理，页面上不需要显示的没关系，我比如说我在8天之前我加一个隐藏框，我在框里给他写上 Id，然后我从这个框里取不就完了，对吧？

所以我这里写input。

 type。

等于黑的，为了取方便我给他加一个ID， ID我就叫 nttid当然你得给它一个值，这个值得是个变量，所以我写th往后value，然后 y6这里面我们需要写的就是用户的ID，用户是谁不就是user优点点ID，然后我们点按钮触发了单击事件，在单击事件里我们得到当前的按钮，然后的话获取当前按钮的上一个节点就能得到这个数据，这是我们利用GS的逻辑去做一个处理。

好，所以回过头来这个地方我得这样写的。

到了括号button，这个button是当前的节点，就是按钮，到了button点它前一个节点Free的值为l这样就行了。然后最后处理返回结果，dater，我先把它转成GSD相转成了js对象，然后做一个判断，它的编码是不是0？如果是零表示成功，否则怎么样？好，那么如果是0表示成功，我们需要改样式这里我就不去这样改了，因为你不只是改样式，因为你改完样式以后，页面上将来关注的数量都得改。

如果说我们这样写一句话，改样式还得再写两句话改那俩数量通过GS也有点麻烦。

这里我说点事儿，因为这个前端也不是我们的重点，反正只要实现这个效果就可以了，我说点事儿，直接我就刷新页面了，利用 Gs那就window location这样让页面重新刷一下，这个改样式就不用了，租掉了不要了，那么否则那肯定是错了，我们给个提示，把返回的一些提示信息打印出来就行了。

好，这是关注的逻辑，那么取消关注和类似的应该也不要了，取消关注，我把这个代码贴过来，然后我们稍作修改，这个路径应该改成iPhone对吧？然后 anti type还是三，因为也是针对人的anti tid依然是这个值返回值data，依然这样处理。

那么如果是0，就说明你取消关注成功，我们就刷新页面，否则给个提示完了，好到这我们关注就搞定了。搞定以后咱们先做一个测试，看一下行不行，我启动一下这个项目。

好，启动完以后我打开浏览器，然后访问一下首页，我这已经登录好了，那么是CC比如说假设我想关注AAA那么我访问 Aaa的首页，这里我可以点关注它，我点一下那点完以后没反应，为啥没反应？

首先他没报错，应该是没报错，没报错就应该是关注成功了，关注成功以后咱们不是刷新页面了，但刷新页面以后，我们这个数量还没有做相关的显示，所以它没动。

再一个我们关注它这个状态，我们没有去做特殊的处理，所以状态显示的不对，因此这个是我们一会要处理的地方，就关注数量，我们需要获取，关注状态我们需要去改变，但是数据对不对？我们可以查release，看一看有没有这个数，先这样看一下。

我查询一下这个case，你看follow we follow这个数据都有了，比如说我看这个follow follow151应该是CC的ID，我就z因为这是一个有序列表， range范围查询，然后 k我写 following不要写错，然后冒号151，冒号三，然后写上你要重，哪查到哪指的是索引，我要从0查到1-1表示最后一个作业回车，你看它里面只存了一个一个 ID，就是111一一是AAA的ID我关注的是AAA没有问题，数据就对了。

好了，那么既然关注我们搞定了，那么最后还要做一个数据的正常显示，当你访问用户的主页时，他的关注的数量你要显示对，关注状态你要显示对吧？那么为了显示这些数据，我们需要在 Service里再补充一些逻辑，因为你要把数据查出来再补充一些逻辑，所以我再回到这个follow service，再增加一些查询方法。

首先我先补充一下我要查什么，我要查询关注目标，关注的实体的数量，查询某个用户关注的实体的数量，返回浪，然后 find follow目标， count。

那么你需要传入uzid是谁的关注目标，还要传入类别，你是某一类的目标，而不是所有类的，因为你没有必要说你要统计关注了多少个帖子，关注了多少个用户把它俩混在一起去统计，这个没必要，你是分开的，你关注多少用户是一份数据，关注多少帖子是一份数据，肯定是分开的，统计放在一起没有意义。

好，那么这很简单了，首先我过到 key发了为。

 key等于red。

 is key YouTube点get follow your key。把user ID传进去，把n TT type传进去，得到 k我就直接就能得到它里边的数据量， red is template点ops phone z site。那么统计z site中的数量是 z car。好，然后你把k传进去，数量就有了，好了，这是统计关注的实体的数量，我们还需要做一个统计，某一个实体粉丝数量查询实体的粉丝的数量，还是返回了 find follow。

然后 count查询实体的粉丝数量，你需要存入的是itt type。

Ittid传的是实体，我首先构造的还是一个t follow a key，read this key，YouTube，get follow a key and detail。Ndtid也是直接return的register template ops for ZZ然后还是 z卡把k传进去。好，那么除此以外还要做再加一个方法，因为我们在页面上要显示我当前用户是不是关注了这个人，我要显示这个状态，当前用户有没有关注这个目标，所以你需要做一个查询，好判断出来这件事儿。

所以这里我再加一个方法。

就是查询当前用户是否。

以关注该实体。好，那么这个我返回一个布尔值，最终是一个判断返回布尔值，方法名我叫has，follow的是否已关注，加一个参数uzid表示赞成用户，然后你关注某实体，你还得传实体对吧？好，我们可以看一下我当前用户的关注目标里有没有实体就知道了，我就构造 key， follow为key，目标的key rides，YouTube点get发了vt然后又在ID传进去。

NTT type传进去。

好，那么有了 k以后，我们就很简单判断一下，red is template点ops for z sad。

然后其实有很多方法都可以判断，我可以调这个方法，随便找一个，比如说我查询一下分数，查询一下某一个数据，它的分数，你能查到就说明这里有对吧？你查不到就没有，这个就很容易 follow为key，这是key。

然后ittid我查 ittid的分数，如果说我就这样，如果说查到的结果不是空的，就表示说肯定就有这个值，他就已经关注了，如果是空的没有这个值，那就是没关注，就这么一判断就可以了。

好，那么有了三个查询方法以后，我们在主页上要显示出正确的数量和状态，而主页是通过user controller去访问的，对吧？

所以说我们还得去处理 user control这个逻辑。那么之前我们在这里查到了用户查到了点赞的数量，下面要补充一些内容，我们需要查询关注数量，就是这个人他关注了哪些实体这个数量，还有你还要查他的粉丝的数量，还要查他是否已关注我当天登录用户对这个用户是否有关注？

那查询关注数量我就调发对对调follow service大家还没注入，好，把它注入进来，然后回到刚才的位置，我调follow service，然后关注数量是find follow account。

好，然后你要把 user ID传给他，还要把实体的类型传给他，那么实体的类型，因为我们当前是查询某一个用户，它的实体用户的实体其实就是三，但你这里不要写使你写成这个常量，我看一下有没有实现常量接口，没有实现一下。

好，回到刚才的这个位置，我就写NTT type，user23，好，那么这句话一执行，我就得到了一个关注目标的数量。

 Follow me。Come。我希望把它传给模板。好，关注数量搞定，同样的再把粉丝数量查到，我就long follow account。

等于follow service。

点find。Follow account。

然后你要传的是实体类型，用户实体还是常量，然后用户实体ID就是优质ID。好同样我也要把这个数量传给模板，最后再查一下我当前的登录用户对这个用户是否已关注，那么这个产品你做个判断，所以我先把这个变量先声明好。 Has

 follow默认等于false。

然后这里我得判断一下我当前有没有用户登录，因为如果你没登录，你也可以通过首页看别人的空间对吧？没登录也可以，所以这里你要判断一下登没登录，那house偷得了get悠着，如果说他不等于闹，这个时候才有可能关注。

我就判断一下 Has followed就等于 follow service做查询点has followed，那么你需要把当前用户传进去，就是host holder，get user get ID然后当今用户关注谁，关注某一个实体，关注的还是用户类型是他实体ID是你这个空间的user ID好这样才行。

查完以后 has followed也需要成为一面好处状态的判断。

好这些数据我都传给了主页，最后一步我们就是打开主页，把数量状态给它处理。好我就打开 Profile，我先处理数量比较直观，首先就是当前的用户，他关注了几个人，那么这个地方我要显示的应该是 follow we count对吧？好，这里我显示了 follow we count。

其次当这个用户的关注者是几个人？关注者其实就是他的粉丝，那就是follow count完了，然后还要处理按钮的状态，8天的状态你得看一下我登录用户对这个用户是不是已关注，如果已关注你这里要显示已关注，如果没关注你才显示关注它这个按钮的这个名字，你要动态的改变，好我就这样我就th冒号，text等于这里做一个判断has这样我把它换个行，这个太长了，一一瓶都摆不下。

Has。

 follow。 Pass follow。这个是帧吗？如果是帧表示已关注，我显示已关注。好，如果是假，我就显示关注它，好，这是对按钮的值做一个处理。

除此以外，大家还要注意另外一种情况，什么情况？我是登录用户，我访问的是我自己的空间，这个时候你就不应该显示这个按钮了，登录用户访问自己空间的时候不要显示按钮，不然的话他点一下自己关注自己怎么说，虽然说不能说它有多错误，但是这个业务没有意义，自己关注自己没有意义，所以说这个案子我还得做个判断。

 Th冒号if等于等于什么？如果当前登录用户和 User是一个用户，你就不要显示我这样写，如果love in user登录用户，假如它不等于now并且那么。

log in user。

点ID不等于。

 user点ID。

好，我是这样写的逻辑，我们再重新解读一下，首先你登录用户得为空，就是说如果你你登录用户为空表示你没登录，那也不显示你没登录的话显示它没有意义对吧？你不应该这样的操作，并且登录用户的ID不等于这个空间用户的ID，如果等于就表示说他是一个人就不应该显示是这样，所以这块还有点绕。

好到这这个就处理完了，下面我们再做一个测试，我把 CTRL f九重新编译一下。

好编译完以后我打开这个页面，然后重来我是访问首页，然后的话比如我点 AAA你看已经关注过了，然后他获得了三个赞，然后 AAA他没有关注任何人，但是他的粉丝有一个就是CC没有问题，比如说你看我这个CC我再点一下，再点一下就有点问题，什么问题？

就是我们按钮就是怎么说，我们点是点一下它关注，再点一下是取消关注，而关注和取消关注它的逻辑的切换是通过GS通过样式去处理的。

就是说如果它是这个样子，我就可以关注，如果它是另外的样式，我就可以取消，而我刚才样式没有处理，所以说它样式不切换就导致我点的时候就有问题，所以说还挺麻烦，样式还遗漏了，这样我们把样式做一个重新的梳理按钮，这是 class目前它是写死成button，音符，8t音符你也看到了它是一个蓝色其实代表的是你可以你刷新一下，蓝色代表的是就是说你可以去看一下这个逻辑，如果是8d音符表示说你可以去关注它，而当前我们这个逻辑是不对的，好我这个地方需要需要动态的去拼，你已经关注了，我显示一个样式，你没关注我显示另外一个样式，好让样式能切换，让我们这个逻辑能动态起来。

好，我写th class，然后竖线这里面要加个变量，这个地方巴丁音符不能写死，这里我写死了，我应该是做个判断的是。

 has followed，

然后那么如果已关注我就要显示某一个样式，如果未关注我显示另外一个样式，其实未关注应该显示大厅音符，如果已关注了，我应该显示谁显示他，这两样是之间切换好了，但是这个是前端的逻辑，你可能没有写过这个页面，所以说你这个样式不太熟悉。

这里就是说我直接告诉你，你把这个记住就好了，这块有这么一个隐含的规则。

好了，那么我再重新编译一下，再打开页面刷一下。

好，这回就对了，你看他已经关注了，比如说这个地方我已经关注了，它就变灰了，然后如果已关注，这个时候我再点一下，再点一下他就取消关注了，取消关注的时候，这时候我就可以再点关注，那这个时候你看他关注者是0，是吧？因为我取消关注了，他没有粉丝了，我在关注他，他粉丝是一我再取消关注他，粉丝是0再来一下。没错是吧？

好，然后另外我再访问我自己的主页，看看有没有什么问题，访问个人主页。你看我关注了一个人就是AA，我的关注者没有我没有粉丝，我登录自己的主页我看不到那个按钮不能点，应该是这样的。好了，目前我们就把关注取关以及相关的数量状态的显示就处理完了，我们这次课就演示到这里，咱们下次课再见。