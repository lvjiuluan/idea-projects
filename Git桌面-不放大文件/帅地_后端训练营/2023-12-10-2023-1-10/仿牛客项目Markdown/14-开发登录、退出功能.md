14-开发登录、退出功能.mp4

这节课我们来开发登录和退出的功能。那么登录功能它有两个请求所构成，第一个请求就是我们点头部的登录的链接，然后能够打开登录页面，这个请求我们已经完成了，上次课我们在做验证码的时候已经把它实现了。

然后第二个就是我们在登录页面填写数据，然后再点立即登录，那么这个逻辑我们也很容易能想到，后台应该是对填的数据进行一个验证，如果验证的是ok没问题，我们需要生成一个凭证，然后发送给客户端，这样的话好记录登录的状态，让状态能够在多个请求之间能够连续，让业务得以连续，当然这里就需要用到 Cookie了。

另外如果说你没有成功，某些数据是错的，我们还要回到登录页，然后在这里给一个提示，其实和注册是非常像的，处理的方式，只不过它对数据的处理是有一些区别。

那么退出的话就一个请求我们点这个地方展开有个退出的链接，然后你点退出以后，我们需要把登录凭证改成一个失效的状态。之前是登录成功了，现在要改的失效，然后的话还要跳到这个网站的首页，这是我们的一个要求。

好，那么咱们就一个请求一个请求来实现，我们先来处理这个就是登录验证数据的环节。

这里我要说一下，我们生成的登录凭证最终是要发送给一个key给客户端，然后让他记住下次再提交给服务端，我好能够就是识别你，但是登录凭证中包含了一些敏感的数据，包括用户的 ID、用户名甚至密码，如果说这些数据不能发送给客户端，要存到服务端，我们可以用三星来存，或者是也可以存到数据库里，这里我就把它存到数据库里，my circle里将来我们还会对它进行一个重构，把它改到存到 Rise里，这是后面我们要做的事情。

好了。

我们开发之初，我们先来去看一下登录凭证的表，看它的结构，然后我们怎么存，我打开了这个表，它的表名叫log in ticket，然后这个表现在它里面是空的，什么都没有，然后有这么几个字段，一个是ID组建这没啥好说的。第二个是优质ID，用户的ID，因为你存的是用户的凭证，所以说你得识别是哪个用户，所以这个也很好理解。

第三个是txt就一张票，一个凭证其实就是一个随机的字符串，不重复的一个唯一的标识，我们要存的其实就是一个关键就是这个字符串，然后 Status状态，你这个评论是有效的还是无效的，其中零表示正常，一表示过期，我们看一下备注对零表示有效，一表示无效。

然后还有一个这是日期XP的，然后过期时间什么时候过期凭证，因为你不可能说把凭证永久的保存，它总有一个时间，哪怕这个时间长也需要有一个周期。

好，就这么几个字段。那么我们开发的时候还是按照以前的方式，我们先写数据访问层，然后再写业务层，再写表现层，数据访问层的话肯定我们得先把登录凭证相关的操作给它实现了。

好，我们就先写这一块，我打开这个idea，然后首先我得写一个实体类，好封装的这张表里的数据，然后的话再写它的征迁改查相关的逻辑。首先我在安铁的包下新建一个类和表面相对应就叫劳力 Txt。

然后刚才我们也看到了，它里边有几个字段，我就增加几个属性与之对应，分别是ID，然后是user ID，好，然后是一个ticket，就是一个字符串，还有一个状态，最后是一个日期，就什么时候就时间到了。

好，这是到期的日期，然后我要给这些属性生成盖德赛的方法，再给它生成一个兔子菌方法。好了，实体类我就写完了，没什么好说的，反正也没有什么业务。有了它以后，接下来我们就开始实现数据访问的逻辑，我就在 Do包下新建一个接口，接口的名字我叫love in。Take it。

好，那么我需要声明一个注解，map注解，比方说这是一个数据访问的对象，需要有荣幸的来管理。

然后。

我们的业务当中需要这么几个方法，第一个是你要增加这条数据，插入一个凭证对吧？你登录成功以后要插入一个凭证，所以这个方法先声明一下。

那么增删改的方法通常就返回的是整数影响的行数，方法名我叫insert log in。可以，那么参数很显然应该是实体类对吧？Log in KK好这是插入一条数据。

然后后续你。

插入完以后，我们肯定得利用这个状态，肯定得在某些时候把它查出来，因此我们再加一个查询方法。

那么查询的关键是什么呢？是依据什么来查？是依据 Ticket。因为整张表 t都是围绕 txt来设计的， txt是凭证，它是核心数据，我们最终就要把 take的字符串发送给浏览器让它保存，然后其他的数据是我们服务端自己要存一份，或者说我们服务端在数据库里存一份，是这样的，得要发给客户端。

因此客户端他用cookie了，除了这个数据以后，他再次访问我服务器的时候会把这个txt给我，我可以利用 ticket查到整条数据，那就知道这是哪个用户在登录，这是哪个用户在访问，是大概这么一个逻辑。

所以我们这个查询是以 ticket为条件的一个查询，那么ticket它是一个唯一的标识不能重复的，因此我们查到的是一条数据 log in ticket，这是反馈值，那么方法名我叫谁？

Let bye take it，然后参数就take it好了，最后还要加一个方法就是修改凭证的状态。因为当我们还要开发，当你退出的时候，这个凭证就应该失效，对吧？

那失效其实一个是你可以把它删掉，第二个是更改状态，我们采用第二种方式，实际上我们在互联网行业，我们真正删除数据的时候很少，通常都是改个状态，这个状态就表示它失效了，作废了，但是我们留一个底，那么将来我们想统计的时候可能会有一些用处。

好，那么修改状态返回的类型是int，然后方法名我叫update stayed。

那么修改的话也是条件是txt，你把这个txt给我传进来，然后告诉我你要把它改成什么状态，我就给你改好了，这三个方法我们就声明好了，我们的整个的业务当中其实就需要这么三个方法，别的就不用了，然后就要实现这个方法。

我们之前去实现 map，都是在目录下新建一个配置文件，然后写circle，这种方式我们经过之前的练习，大家应该也比较熟悉了，那么除了这个之外，我们还有一种方式，在 map类当中写结果当中写注解，通过注解去声明这个方法对应的什么？

Circle也可以搞定，那么我在 map里就用注解的方式给大家实现一下，那么两种方式你都会这样的话，无论是企业用的一种方式你都比较方便。

好，那么这注解也很简单，比如说我这个是一个音色的方法，要执行的是音色的语句，那么你就用音色的注解，然后小括号里面写一个大括号里，你可以写多个字符串，随便多少个都可以，然后他就是把这多个字符串拼成一个circle，就是 circle你可以拆成多部分去写，它会帮你拼到一起去。

同理这是查询，你就用 select注解也是类似的，然后这是update，你就用update的注解也是类似的，就里边可以写多个字符串，最终它会帮我们拼成一个circle。

好，当然了我们这里头没有删除的方法，如果有的话你也应该知道它肯定是delete，那就是delete，好了我们一个来实现来把 circle写出来。那么首先写我习惯于把换个行，这样看起来方便一点，然后插入 Insert， into log in。Take it我们写这个字符串的时候要注意不要写错了，因为写错了它是不会有提示，不会有检查的。好，然后我要插入的是哪些列呢？这个组件不用，因为它会自动生成，第一个字段的是uzid然后是txt的凭证，然后是状态，然后是过期的时间，你也可以后面接着把最后写完整，但你这样的话，把一个比较长的circle写到一句话当中，不好看对吧？

所以我们可以再换一个字符串，另几样再换一个，所以他为了你书写方便，他就允许你写多个字符串，到时候他帮你拼，然后我们写的时候需要注意的是什么呢？你在一每一行字符串后面最好加一个空格，这样他拼circle的时候，这两句话之间有一个空格断开对吧？

不要挨在一起，那样容易出问题，养成这个习惯就好了，反正每句话后面加个空格好了，insert into这些列，然后 Values y64里写什么？就是写表达式，这表达式引用的是对象中的参数属性，然后作为 Circle的条件。

好，那么这里第一个是uzid那么对应的属性就是uzid属性。所以你会发现 circle其实我们在这写和我们在xml里写基本上没区别，就是格式有所不同，但是道理都一样。所以这里我不多的解释了，你写一遍就明白了。那么第二个是 txt是对象中的txt属性，以此类推，下一个是所得的。

好，再来最后一个，x pair，好，这就完成了。然后还要注意一点，这是一个音色的语句，我们希望它的 Id是自动生成的，对吧？那么这个里面需要声明一下，不然默认的话它不会自动生成。我们之前写 xml的时候不也是做一些声明，这里也需要声明，声明 circle相关的一些机制，我们需要用到这样一个注解叫 options。

然后我希望组件自动生成，我需要在注解里声明就是use它有提示你看 use generate case是否自动生成组件等于two，还有自动生成完组件以后，它会把生成的值就是边注入给对象，注入给哪个属性，我们需要通过key property来指定，那就是ID对吧？就是这样的。好了，你看这个insert语句就写完了，这样确实比较方便，因为我们少写了一个xml文件，但是它的缺点就是说色块如果复杂的时候，就看起来没有在x三秒中那么舒服，因为毕竟它是分了几个片段片了，分了几个字符串显示到这儿了。

好，所以总之各有利弊书写起来，简单阅读起来，麻烦你选择哪一个都是有道理的。好，然后我们再写这个查询，查询我也是这样给它断开，然后就是谁来ID。User。Id。然后 Ticket。然后是status，最后是 aspect，养成习惯空个格。好，然后另起一行再接着写。From老b txt给个条件，我们这个查询是以 txt为条件，我就where txt等于参数提给他。

好了，查询的语句也很容易就写完了再来。这个是不对的语句。好，这个和音色其实大同小异，我就直接写了update。Love it。Take it。 Set status等于这个参数status，然后你看跟一个where条件对吧？Where ticket等于贴给他，但是这样就可以了，然后我想说的是什么？

我们在注解里写 circle的时候，其实它也支持动态的circle，我们之前在配置文件里有的地方用到了动态出口，比如说用到了if，那么注解里也可以写if，这样的动态的出口怎么写呢？我就在 update的语句上给他立案是吧？尽管说 Update的语句它并不需要动态，我就假设他需要我就给你演示一下怎么去做，我需要写一个动态的circle，是这样的。

首先我在这前面再补充一个字符串，这个字符串我这样写 secret，然后在这个字符串之后再补充一个字符串，square的标签闭合这块加个空格， SQL的表示脚本，那意思说这里边是脚本，然后我在 SQL的标签之内就可以加 if标签像if或者你可以理解为将if的脚本，我可以这样写， if开始，然后你还得闭合，if结尾，然后if上你可以写test，等于等于的是一个条件，但我这里写的是双引号，它不行，你需要进行一个转译，然后双引号之内你要写上一个判断的条件，假如说我判断 take的是否为空，比如说take it不等于no，我就再拼一个条件，你写到你会发现 if这么写其实和在xml中写是一样的，对吧？

所以其实它就是和xm中的语法是一样的，但是如果你想写if这样的标签的话，你前面必须套上 script，里边才能写这样的标签，这个要注意好。那么如果txt不等于now，我要怎么样？我就随便再拼一个，拼一段我就拼了一个按的1=1。好，那么你注意，其实我拼上这个条件和不拼没什么区别，因为这个是一个恒成立的等式，对吧？拼不拼都没有区别。我只是给你演示一下 If怎么去用，是这个意思。

好了，那么总之我们在注解里是这样写SQL的，那么好处就是方便直接就写少建一个文件，缺点就是像这样的不太方便阅读，而且你在这里写标签的话，也不是特别方便，各有利弊。

那么写完以后就这个内容特别容易出错，因为你的表名字段名都手写的，它也没有提示，万一写错的话就比较麻烦，所以我们最好对它先做一个测试，如果没有问题的话，我们再继续。好，我打开找到一个测试类测一下。我就在这里写 Map，tests因为我们这个类不是专门测试map对吧？我就在这里写，我就把刚才写的log in take the map注入进来，进行测试，我就在后面的加方法，test我们有三个方法，我就先测增加 test，insert，老兵，谢谢。

好，那么在这儿我就自己先随便造一个老兵KK的，好，随便的给他传点数据，这数据可能不是那么合理，但是没关系， site uzid随便写一个，比如说101log in take it点set， txt就是一个随机字符串，这里我就不随机了，我就ABC login take it。点site， x status0，然后是log in ticket点site。 Expired。

过期的时间我就new date，然后给它传入 system点current当前的时间，然后再往后推若干毫秒，比如说10001000毫秒乘以60，那就是60秒，一分钟对吧？一分钟，然后再乘以10就10分钟，假如10 10分钟的以后就到期了，就这样。好了，那么构造完这个对象以后我就要存了，我就调 log in，take the map点insert，把它传入进去。好，下面我就执行一下这个方法，然后看一看能不能把它插入成功。

好，没报错我们看一下，没报错以后控台会打印 Circle，但是没报错说明 cell有没有问题，然后他最后给你一个提示说这是 circle，这是你传入的参数，然后这个是更新了多少行一行都是对的，我们看一下表里有了一条数据没有问题，然后数据的ID是一，接下来我就要测一下怎么去查询，我就要查这个数据。

当然我们查不是根据ID，是根据 tk的来查，然后查完以后我就给他直接改了，所以我把这个查询和修改放到一起来测，我就test谁来 log in。Take it，好，那么就直接写log in，take the map点，select，buy ticket。传入的是ABC凭证，我会得到这个对象。好了，得到这个对象以后，我把它打印出来看一下有没有问题，然后的话我再对它进行一个修改，我就老给你txt，不点买票，直接点 Update status，我根据 take it把这个状态改为一，比如说它失效了，它退出了，然后改完以后我再查一遍，然后再看看数据对不对？

好了，执行一下看结果也没有报错，那么结果当中它打印的 log in ticket，这是我们第一次查询，没有改状态之前，数据没问题，状态是0，对吧？

然后第二次查询你看状态就变成一了，说明我们 update也没有问题，好，经过测试 map我们写的没有问题可以直接使用，那么大家在开发的时候最好是这一步都加上测试，因为这一步是最容易犯错的地方。

好了，那么这个数据访问的开发以后，下面我们开发业务层，业务层你当然就要支持登录的业务，你登录的时候就需要接受页面传入的条件，包括用户名密码，也包括你希望希不希望这个账号被长久的记住，或者说这个账号它什么时候过期这样的一些条件，然后我们对这个账号密码进行一个验证，如果没有问题，我们就认为你成功了，我们就给你生成一个凭证，就这么一个逻辑。

我需要去写业务层service在这里这个我们可以新建一个service，或者是我们就在 user service里写也可以，因为你登录其实是用户的一种行为，对吧？

所以说我们在 user service里写也就ok了。那么我们在实现登录的过程中，肯定是要用到刚才的 log in to get the map，我把它先注入进来。好，有了它以后，下面我就开始实现登录的功能，我在后面追加一个方法，那么登录的时候一个是你可能成功，第二个你可能失败。

失败的原因还不止一个，有可能是账号你没输入，有可能是这个账号不存在，有可能是这个账号没有激活，对吧？有多种条件，说白了有点和注册是类似的，它的情况比较多，所以我们返回的数据，我们可以返回一个map，可以封装，就是多种情况的反馈结果。

好，所以我返回值生成为设置为map，方法名我叫log in，然后我要求你调用方要把 U的内容账号传进来登录对吧？

然后把密码传进来，你注意用户在页面上输入的密码是明文，就是没有加密的密码，我们得到的也是这样的一个密码，但是用户注册的时候，我们给他库里存的是一个加密后的密码，所以你这个pass word还不能够和库里的密码直接去比，怎么比你也把密码进行一个加密，按照他注册是同样的逻辑加密，然后去比。

因为MD5只要你给的字符串是一定的，它加密后的结果是固定的，因此你加密之后去比，如果说一致那就密码就对不一致就不对。

好。

另外你外界调用的时候还要传入一个，你多少时间以后要过期凭证要过期，我要求它传入一个过期的秒数 expiredxpl seconds就是我希望你给我传入一个，你希望多少秒之后凭证会过期，好我暂时先水吞闹，好了这个方法就声明完了，接下来我们就来实现。首先我先声明 Map，最终我是返回 map。

好，那么我们对整个登录的处理，首先是要处理这个参数，它是不是空的这种空值的情况，所以首先的逻辑是一做一些空值的处理，我就判断使用可以调工具类使用YouTube，点is black，我先判断user name是不是空的，那么如果user name是空的那就不行，所以我需要返回一些结果，我就给页面返回的是user name message这么一一个消息，然后消息上写说账号不能为空，好然后直接就return了。

好这是一种情况。另外密码也可能为空也不行，这个逻辑和他是一样的。 Pass word，如果pass word为空，我就返回一个pass word message，然后提示他说密码，不能为空，然后返回。

好，那么如果这个账号密码都是有值的，都不为空，接下来我需要对它的合法性进行一个验证，首先我先验证账号，先对账号验证怎么验证，我们就用他输入的又在内部去查一下，看库里有没有，先看他有没有，如果没有就账号错了，对吧？如果账号如果有，我们再去比较一下库里的密码和密码一不一致，看密码对不对是吧？大概是这么一个逻辑。

好我要做一个查询，那就是查到的结果是user，那就得调 user，map点 select白，这里是banning，那我就传入user name得到user，然后紧接着我要判断一下 user它是不是no，如果是no有问题，这个时候我需要返回 map中的 k还是using message，但是这个提示消息要改一改，这不是为空了，是该账号不存在，这是一个错误的账号。好，那么如果说这个也没有return，说明账号存在没问题，你还得判断一下这个账号状态对不对？因为咱们注册以后不能直接用，它不得激活吗？对吧？

所以这一步我们先把先判断一下它有没有激活，如果没有激活也是不能登陆的。

好，可以进一步判断，如果说user点get standards，它等于0，等于0是表示说他注册了，但没有激活是一对，所以这个也不对，还是要return map，又针对message这块提示说该账号未激活，好，如果这儿也过了，那说明账号存在也激活了，接下来就可以判断密码了。我就验证密码，刚才这个地方也是不是，这个是验证状态。

好，那验证密码的话也容易，首先我要对传入的明文密码，按照同样的规则加密，然后再去比较这个password应该等于什么呢？加密后的一个值，我就调肯定 Ut有点MD5这个算法，然后把明文密码加上 sat，我们又这里有对吧？

Get sat好，密码加上 SARS盐以后再做一个加密，得到加密后的密码，加密后的密码和库里存的是不是一致，是我们所关心的问题判断一下。

悠着点，get password点，echoes password相比，如果说两者不相等，注意是不相等，不相等就表示不对是吧？不对的话你要提示密码如何，我就把这个map返回，这个地方你得写密码不正确对吧？

好了，到这儿如果程序能执行到这儿，就说明以上都没问题，账号也对密码也对，那就说明你登录是可以成功的，登录成功的时候我需要做什么，我就需要生成登录凭证。好，证明你是登录的，我这边要记，并且我需要给你发放凭证你也要记。

好了，生成登录凭证无非就是我要创建一个 log in take的实体对吧？然后往往库里存 Log in，take it设置方法以后，我们需要往里设置一些值，首先你要site ID不用自动生成对吧？Set优质ID那就悠着点get ID对吧？然后 log in ticket点set，take it凭证。凭证是一个随机生成字符串，那么我们之前在community utu里加了一个方法叫generate uuid方法生成的就是一个随机字符串，不重复的。

好再来，然后 log in ticket点，set status。零就是有效的状态，然后最后再site一个过期时间， new date。但是你这样解释当前时间不是这个意思，应该是当前时间往后推移这些秒是这个意思对吧？ New data我这里就这样写， system点carry的time，就当前时间毫秒数再加上那个秒，当然那个秒得换算成毫秒对吧？所以你就是x的second，换算成毫秒就乘1000就行了，这样的话过期时间是当前时间往后推移这么多秒，好，这个对象的构造完以后我就要存了，我需要调用 log in take the map，然后 insert，把这个参数传进去搞定。

好，那么如果说登录凭证已经生成了，登录已经成功了，那我最终返回的结果里需要把凭证放进去，因为我们最终要把凭证发给客户端，你可以放整个log in TV的对象，或者是其实只放 ticket那个字符串也是可以的，因为页面只需要记这个内容，只是说白它浏览器只需要记一个key，比如说我这是一个登录的凭证，他下次再访问服务器的时候把 key给我，我去库里找找到了与之对应的一条登录的数据，我一看状态对，时间也对，ok我就认为你是登录成功的，从而而且我通过推给他能找到uzid我就知道你到底是谁，就这么一个逻辑。

我们这个表它所起到的作用就有点类似于筛选了，这里我们没有用筛选直接用表存的。好，我在这儿就做这样一件事儿，我就卖的点儿兔子，我要把 txt存的放到 map里返回，那么它的结果值应该是log in take的点干下去。可以的，好了，判定之后返回这个逻辑就完成了。

好，那么我们有了这个业务方法以后，接下来就可以开始去编写，那么表现层的逻辑，首先我们的一些controller的方法处理页面的请求，那么因为是登录页面，你登录页面的话，你有一个表单会传入三个值，这个很直观，账号密码验证码，对吧？

我需要收到三个值，然后把它提交给user service做处理，然后如果说处理完了以后，我要么去重新上到首页，要么错了，我就回到登录页面，相关的页面也需要处理。

好，下面我就写 controller，我们还是在log in controller里写，那么因为这service我已经注入进来了，不需要重新注入了，我只需要在后面增加一个能够处理这次请求的方法就可以了。

首先我声明这个方法的访问路径 pass等于老兵，可能有人会奇怪，好像老兵是不是被占用了，你看之前我们这个方法它的访问路径也叫log in，那两个一样能行吗？可以的，但前提是什么呢？这两个方法它的请求方式得有区别，如果我们下一个方法也是盖的，这个也是盖的路径又一样就冲突了。

我这里是应该用的是post，因为什么？这是一个相当于是一个增加数据的行为，就是你表单提交数据给我，我最终要把数据增加到库里对吧？因此我要处理表单提交过来的数据应该是用 Pose的请求，那么根据请求方式不同，所以说也能够将这两个路径区分开，所以这样是可以的。

好，然后我上面这个方法再返回实际方法叫log in，这个方法我需要页面表单传入进来一些条件，首先我需要的是 user name，其次我需要的是 password，第三个我需要你传入验证码，我叫code。

第四个还有一个这个页面上可以勾上，记住我，就是说你不勾上的话，我就记得时间短一点，你勾上我的话就记得时间长一点，记住这个勾你也得把勾标记传给我，这个勾是勾上还是不勾上，它显然是一个布尔对吧？

所以这里说明一个参数是布里。 Remember me记住这个单词似乎写的不太准确， remembermeok没问题。

然后。

我们返回响应的时候，我还需要用到 model，把这个model也声明一下。好，另外我们页面传进来验证码，我需要取到之前我生成的验证码去比，用户打开登录页面生成的验证码放哪去了呢？放到了session里，这个方法对吧？放到了session里，所以这个请求当中我需要从session中把密码取出来，因此我得用到这个筛选，所以我把这个筛选也声明好。

另外如果说登录成功了，我们最终要把 tk的发放给客户端好让他保存，需要用cookie来保存，所以要想创建cookie，我还得需要用 HTTP server late为sports对象。

好了，总之这个方法比较麻烦，它需要的参数比较多一点。好，那么把这些逻辑理清楚以后，接下来我就开始写了，我们首先要验证什么？首先我们应该判断验证码对不对？如果验证码不对，账号密码不用看了，所以先判断这个验证码，那么验证码是在表现层就直接判断出来，不管业务层只管业务逻辑，你账号密码对不对？

好，所以我在这里直接判断这个验证码，我需要先把验证码取出来，开不成等于从三生中去筛选点get h标的。

我们当时往里存的时候，这个名字就叫卡卡对吧？然后它这个方法返回的是 Object类型，但是我们需要的是死卷着，你需要做一个强制的转换，好我就得到了验证码，然后将验证码和用户传入的客户的相比，我判断一下 string YouTube点is blank， capture。

如果我取到的验证码是空的，说明有问题或者 is block，如果说你船上的扣的是空的也不对是吧？或者 capture equals。

注意我用的是这个方法， because you cannot kiss就这个方法其实和一口是相等的，逻辑是一样的，但是它是忽略大小写的，这个方法是比较 session中的验证码和你传的验证码是不是一样的，如果不一样就不对。

总之这两个值有任何一个是空的不对，它俩不相等也不对，这个意思，那么验证码相比肯定是不区分大小写的，我们上各个网站都是这样对吧？

所以说用这样的一个方法好了，那么这种情况就是验证码错了，错了以后我们需要给页面返回一个提示，我把这个提示放到 model里，然后返回给页面提示我叫code，message然后说验证码不正确，我就委托我要去回到登录页面的，是放在 template之下， site下的名字叫log in点test mail，这样就可以了。

好，所以第一步检查验证码，是这样一个逻辑，如果验证码没有问题，下面我们就需要检查账号密码对吧？这样的内容，这个可以交给业务层去处理，我们在调 service的时候不只是要传账号密码，还要传一个过期的时间对吧？你过期的时间你是多久过期，我们是这样去定逻辑的。

如果说你没有勾上，记住我记相对较短的时间，我也是把它存到库里，我依然是把它存到库里，但是只是存的时间短一点。

然后的话如果你供应商记住，我也是把它存到库里，但是时间要很长，所以我需要定义两个常量，时间比较方便，这个常量我还是把它写到 community constant这个接口当中来，好。定义两个常量，第一个常量是默认的登录凭证的超时间，默认状态的登录登录凭证的超时时间。好的，设立一个整数，就是多少秒，然后 defeat。Expand seconds。默认超时的秒的数字，我就写3600，3600乘以12乘以12。

好，那一小时是3600秒，乘以12就12小时，就是说我这个凭证默认给你存12个小时，就是你不勾记住我的情况下，好，那么如果你工程基础我要存很久，因为我们现在大家也有这么一个体会，我们去各个网站别管是通过APP还是通过网页，我们只要登录一次以后，其实很长时间之内都不用登录了，对吧？尤其是APP，所以只要记住我们可以给一个比较长的时间，这个我写个注释，记住状态下的登录凭证超时间这个叫remember。

 Expand不懂再感觉这个时候我存的记多长时间是3600秒×24小时，那就是一天了对吧？我再乘以一个100记100天记了三个多月，这时间也挺长了，这样就可以了。

好，那么回到 CTRL了，我需要让它实现这个接口，我好利用它里面的一个常量已经实现了之前，所以我就可以直接用了。我得那我到底是用哪个值，我得看一下。用户勾没勾选上记住我，对吧？他没有勾选我就用默认的，他勾选上了我就用长的，所以超时的时间我还得判断一下，我说明一个变量 X PAD，seconds就是我们调service方法它需要的参数，超时的描述，我是根据Rimbey这个条件去判断它到底应该等于几。

如果remember me记住我应该用的是常量。Remember你remember expire second对吧？否则那就不记住我，那就短一点default，这样就好了。

好了，那么有了这个条件以后我就可以调 service了，user service点log in，我把user name传进去，我把它是word传进去，我把超时的时间传进去，那么service给我判断以后会返回一个map，我需要让他收一下。好，我得到了一个结果，这个结果我们能够判断出来它到底是成功的还是失败的，很好判断。如果 MAC里头包含了ticket，就说明成功了，因为成功的时候我们才往里放 ticket对吧？否则就是失败。

首先说一下如果成功了，我们最终不是要重新上的首页对吧？我就委托人我这里写上重新向前， Redirect重定向的首页的仿路径是index就行了，那么如果是不对，如果是没有退给他，说明你有错误是什么错误我不知道先不管，那我就得回到登录页面，所以我return登录页面。好，先把 Return写好，写好以后咱们就做处理。

那么在登录成功，在这个时候我需要跳到首页，但前提是我得先把这个txt取出来，然后发送给客户端让客户端存，说白了我用我就是给客户端发一个cooking，带上 ticket，好，我就这样写了。

先是另外一个 QQ等于new cookie cookie的cake，我就叫cookie的。那么它的value就是我从map中取到的一个结果，map点get tkt好，当然我们get到的是它是一个对象，我们需要把它吐死并转成字符串，因为 Cookie它k86都必须是字符串才行。

另外 cookie我们通常都要给它设置一个它的生效的有效的路径 sat pass。那么其实用户登录以后，它的凭证有效的路径应该是包含在整个项目之内，他访问项目中的任何一面，其实这个登录的状态都应该是有效的，对吧？

所以这个路径就是整个项目的整个项目就应该是community，但这里我们最好不要写死，而是写成写成一个参数，这个参数我看我有没有注入进来，没有。这个参数咱们不是在 Application process里去做了配置，你看application里边有这个参数就它对吧？

我们可以把它注入进来。

当然如果你不注入，其实我们通过request，对象也可以获得，这里我注入一下它，注入到 CTRL之内，那么我在这写上value，这是一个固定的值，它可不是一个b好，然后把 k写到这个地方，然后底下声明接受这个值的一个属性一个成员，我叫contact pass。通常都这么叫，你看他也是这么叫的名字。

Context pass好了，有了这个值以后，下面我接着写，set，pass就是整个项目都有效。除此以外，接下来你就要设置 cookie它的有效的时间了，那么设置cookie有效时间就是site max h这个时间就是刚才我们得到的一个second多少秒，那么设置完以后，我需要把 cooking发送给页面用到resource点，add cooking，把酷可以添加进来，在响应时就会发送给浏览器，正确的时候就是这样处理。

那么错误的时候我们要回到登录页面，要把错误的消息带给登录页面往model里存， model点at actual，有可能是user name出了问题， user name message，这个message应该是map要get，又在 message，当然有可能不是他的问题，但如果不是它的问题，那么map点get得到的结果，因此它是闹到页面展现的时候也不会有什么影响。

好除了u的name错误以外，还有可能是密码的错误，密码的错误的话，我就 set password message，那也是同样从map中得到这个值放在mod里。好了，到这儿我就把这个CTRL了就完成了，那么完成以后，最后我们就把这个页面处理一下就好了。

当然页面处理什么呢？你要处理的就是设置这个表单，首先你表单每个框上得有内容，我们才能够把表单提交给服务器。第二个如果说我们检查发现的账号密码或者是有什么问题，我们还要回到这个页面对不对？等你回来的时候怎么去显示错误的消息，怎么显示样式？

说白了配置和这个页面的设置和注册页面是很相似的，好了，我们接下来就来设置这个页面，我就打开登录页面，login点html，好，然后我找到这个表单的位置就在66行这个位置，首先我要声明这个表单提交给谁， Master等于post，我们采用POS的方式提交，然后提交的路径action等于老b好，这是提交的路径，然后每一个框上我们需要给它加上name，我换一行，首先这个账号它的name等于u的name和我们 CTRL的方法的参数有一要一致，其次是密码，这里我也太长了，我也换一个行，然后 name等于 password，然后还有验证码在这，ID不用管 name等于我那CTRL的参数叫code，所以这里我写的是code，然后再看还有这个记住我其实它是一个勾选的，它也算算是一个框，你也得给它加上name也要传给CTRL了，name等于control，我是怎么写的，参数你慢慢密好要跟它一致。

好了，这个表单就是提交的方式路径以及每一个框的内容都写好了，这是我们发送请求的时候要做这样的设置。

如果说检查到有什么问题，回到这个页面，我们需要对错误的信息做一个展现，我们在处理错误的信息的展现。

首先是账号，如果你回到这个页面的时候，我肯定是希望把原来的旧的值显示到框上，它就有一个默认的外流，所以我在这给它加上 th冒号value等于。

好，这个value从哪里取呢？ Y6从哪里取的？注意是从这里取，这块有一个规则你要了解，如果说我这个参数不是普通的参数，而是一个实体，比如说user，那么spring mvc就会把 yous装到 model里，所以我们在页面上就可以直接得到 u的对象的数据，那是从mod里获取的。

但如果说你是这样比较普通的参数字符串基本类型这样的参数，那么spring它不会把这个参数放到model里，此时model里没有有两种办法我们去得到它，第一个你人为的把它加到model里，这是第一个。

第二个还有一种办法怎么说？这几个参数它是存在于 request对象里的。我们如果说在这里头写代码写request点get private也能得到这些参数，因为它是请求里携带过来的，那么当程序执行到的 Html上面的时候， request还没有销毁，因为请求还没有结束，所以我们在这个页面上也可以从request中取值，那么我们在这儿我就懒得在control里把参数再装到model里，麻烦我就直接从request中取值，怎么取他们内部对这方面的知识还是很方便的，你可以这样写。

Carol user name这句话的逻辑或者意思相当于什么？相当于request点get private user内容。好，这个条件是从 Request对象中取参数得到的，你注意。好了，同理密码也可以做这样的处理对吧？Thyl等于他有点pass word，好，然后验证码就不要给他默认值了，如果说他账号或密码或什么错了，每次验证码是要刷新的，所以不要给默认值。

最后是这个记住我，如果说你刚才勾上了记住我，然后一点登录，结果发现有错，回到这个页面的时候，这个地方勾应该还在对吧？

这个记住我它是一个多选框，它的状态是通过 check进行设置的，不是通过value，所以我们要想让它有默认值，是通过属性来进行一个处理。

目前的话它是写死了，check它等于check，这样的话就表示说它就默认就是选中的，但我们现在需要动态的判断，或者把它改成一个动态的处理的方式，你就可以用还是用 timeline。

 Th checked表示属性里边的值，我是用动态的方式去处理它等于什么？它等于这个是 Paro还是从request中取参数，取的参数是remember me。好曲的，remember me其实它是一个处Fauss的值， Check的属性当中，我们给处force这个值也可以处理表示勾选，force表示不勾，选是它也能识别。

好，这是我们回到这个页面的默认值的情况，除了这个以外还有一些错误的提示也得去处理，我们这样回到上面再进行最后的一波处理。那么首先如果说你账号不对，你这里肯定要显示的是账号不存账号相关的提示对吧？这个提示应该是动态的。 Th模号text那就等于变量user name message。好，然后这个账号就这个提示它是否显示，取决于什么？取决于它前面的 Input的样式。

如果有这个样式它就显示，没有样式就不显示，我们应该默认没有样式我们首次访这个页面是没有回到这个页面，是如果说确实它有问题才加上去，因此 class应该是动态拼拼上去的，不应该写死，而且它是一个固定的样式，加上一个动态的有可能没有的样式，我这里需要这样做这样的处理。我需要判断user name，message它是否等于null，如果它不等于null，我就带上样式，否则就不带。这样好，同理，这个密码也是做一样的处理。首先我设置一下密码，它的值取值，它的取值是它所有的message，然后他也是对这个样子也是做同样的处理，也得加竖线，这是一个变量。

然后写错了 Password，message它不等于not，我就带上样式，否则就不带。

好这个是密码，那么验证码你也需要做这样的提示对吧？验证码的提示信息也得写上去，验证码的提示信息是扣的，message，然后也是一样的逻辑，一开始不带 s已经办理，也需要动态的判断，我判断的是客户的变量，客户的 message这个条件它不等于那我就带上一起卖了，否则就不带好了，最后我再检查一下这个按钮，是提交按钮，没错。

好了，那么我能想到的地方我都想到了，然后把它写上去了，当然写的时候有可能哪个单词写错了，也很正常，我们就测一下，如果有问题我们再去调。好我们进行一个测试，我需要把这个项目启动一下，启动的时候看一下，控制台，如果说哪个地方后端代码有明显错误，它可能启动时就报错，我这里没报错。

然后我访问一下，打开浏览器访问local host先访问首页，然后我点登录，首次点登录，我还没输入任何条件，那么它所有的错误的样式都没有，对吧？

然后此时验证码是可以刷新的，如果你看不清就刷一下好，接下来我就要输入一个账号去登录了，我找一个账号看一下优质表。

咱们之前讲注册的时候，我不是注册了一个账号叫CC，我就用它，但我一开始不用它，我一开始故意用一个错，嘻嘻用的错的，然后密码我也随便瞎写，验证码我也瞎写，好记住我勾上，然后我点登录以后错了，显然不对，哪个都不对，他就回到了登录页面，它首先提示的是验证码的错误，因为我们在后台是先判断的验证码，如果验证码不对，我们就不访问数据库了，这样效率高一点，所以首先我需要把验证码写对了，我就看不清了，刷一下，然后不区分大小写，好我写成一个对的验证码，然后此时回来以后你看勾勾上了，表示说我们对它的处理也是没有问题的，好再登录验证码还不对，3v8接，好刚才可能还是看不清，我是写错了，这回对了以后，但是账号不对，对吧？

回到这个页面它就提示账号不存在，我给他搞一个存在CC，但密码不对，我那个密码好像就是123明显更长了，验证码还得重写，7ac0登录，回来以后提示你说密码不对，好，我就把密码改对，123，然后 Rwut好，我就立即登录，这回成功了，他跳到了登录页面。

当然因为目前我们还没有做后续的处理，就是登录成功以后，比如说注册登录这些需要该隐去的隐去，然后这里显示的可能是和我登录有关的内容。

这些地方的正确的显示其实就和我们给用户颁发的凭证是有关系的，我们需要利用凭证看你到底是哪个用户，看你到底有没有登陆，然后对这些地方做一些设置，这是我们后面要处理的地方。

目前没处理之前，我们从页面上还看不出来我到底登录成没成功，看不到痕迹，我们只能去数据库看一下，怎么看你就看登凭证表你看生成了一个新的凭证，uzid151151是 CC吗？是的，然后状态是0没问题。超时时间是6月13号12:29，12小时以后，现在的话还是12号。Ok没问题。就是这样的，这12号刚才12号对吧？这12小时以后没问题，对的好了，那么我们就把这个登录逻辑就搞定了，最后还剩下退出的逻辑那就比较简单了，下面我们再把这个退出给它处理完。

退出的时候，其实我一开始也说了，我们首先需要把凭证改为一个失效的状态，然后跳转到首页就可以了。把凭证改为失效的状态，我们在数据访问层已经实现了 log into，the map里不是有一个update吗？已经写好了对吧？

所以数据访问层不用写了，那么业务层我们需要写这么一个业务，好我就打开刚才的 user service，我在这里再加一项业务处理，就是退出 public，然后就没有返回值了，然后 log只要说你没有报错，我就认为是成功的。当然你退出的时候你需要你是谁退出，你要把你的凭证传过来给我，我好根据凭证找到你是谁，我好给你做一个退出的这么一个行为，对吧？

所以说你要把凭证给我，你要传的是 txt。好，当你把txt传入以后，我就调log in。Take the map。点不对的去改变凭证所对应的状态，可以给它把它改为一。一表示无效那这就可以了。好，那么这块处理完以后，接下来我们需要在CTRL那里再加一个请求，能够处理页面的这个请求。

好，那么这个请求的访问路径先声明一下，路径是pass log out， master是就get就可以，因为退出它不需要传通过表单提交什么数据过来，就是一个普通的请求。

好，然后方法返回的是死病，方法名叫log out，那么这个方法当中我需要得到你浏览器之前存的 cooking，对了，刚才我们页面上表面上看不到它登录成功与否，但其实我们通过这个插件能看 cookie，如果说他确实存了 cookie，就表示他拥有登录的凭证，用了登录的状态，那也能证明他是登录成功的。

我们这样看一下，你可以点在他word刷一下这个请求，然后看请求里有没有，或者是也可以点 application， application里头有一个选项叫cookies，这里面会列举就是你这个路径下对应的cooking，你看他有一个cookie叫ticket，然后 ticket这个值结尾是1a26对不对？

你可以做一个检查，一a26没错，然后它的生效的路径是肯定的，没错对吧？

它的超超时的时间太小了，超时时间也没有错，所以从这也能看到它没有问题，现在浏览器已经存了 qk它退出的时候需要把qk传给我，先把那个值传给我，我怎么去得，它会自动传我怎么去得，咱们上次不是讲了，我们可以利用酷k五6注解对吧？

然后要求spring mvc要把它注入进来， key是ticket，然后加一个参数去接收 ticket。

好，那么我在这个方法里很简单，就调 service，然后 log out就完了，然后把k给他传给他，他把设置为失效的状态就可以了。然后你退出登录以后我们去哪，我把它重定向到登录页面，你可以重新登录， ready？登录页面就是老毕。

好，那么注意log in，我们有两个方法路径都是log in，一个是get请求，一个是post请求。那么我们重定向的时候，那么它默认就是get请求，当然这还没完，因为我们是在页面上需要点这个地方才触发退出登录的对吧？这个链接你得把它配好是吧？

所以我们需要配置部位的链接，而那个链接我们所有的头部的链接都是在index页面去配的，然后大家复用，所以我还要打开首页，index，然后我就找到退出的地方，它了目前它的路径不对，我需要进行一个修改。

好，那么路径要改成退出的路径，那么就是log out，好这样就行了。

那么做完处理以后咱们再次做一个测试，我CTRL f9，好，然后重新启动了，启动以后我打开浏览器然后刷新一下，刷新完以后我去点退出登录报告的它跳转的没有问题，但是底层的逻辑对不对？不知道，我们可以去库里看一下，看这个表的状态变成一说明我们更新的成功了，没有问题。

好了，那么这次课我们就把退登录退出这样的功能开发完了，总体来说并不难，但是它能够把我们之前所学的验证码，我们之前所学的状态管理cookie都利用上，我们可以体会得到这些之前所学的这些零碎在这个过程当中是怎么去运用起来的。好，课后的话大家也认真的把这个功能做好，因为这是我们几乎每一个网站都有的功能是非常具有代表性的。好，这次课我们就讲到这里，咱们下次课再见。