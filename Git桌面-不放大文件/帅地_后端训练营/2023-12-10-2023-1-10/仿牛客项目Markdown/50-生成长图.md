50-生成长图.mp4

这次课我们来学习如何生成长图，那么生成长图这样的功能往往是在这个APP上才有的。通常是在APP我们做分享的时候，我分享一个文章，我分享一个音乐等等分享的时候，然后我分享的时候把这个内容相当于截个图，然后的话可以发到朋友圈，发到QQ群 Qq空间，发到微博等等这样的。

那么生成长图的手段就有两种，一种是客户端实现，就是APP把它当前的界面截个图就生成长图了。

还有一种方式是在服务端，我们可以用html做一个和APP的界面一模一样的模板，然后我们通过一个工具访问这个模板，然后读取这个模板中的内容，生成一个长图，这是两种方式，那么因为生成长图是非常常见的一种需求，所以说我们在这个课里也给大家讲解一下演示一下，那么因为我们这个项目是一个外部项目，咱们没有APP所以说 APP客户端生成的事我们就不说了，我们只探讨的在服务端，我们怎么利用一个h三模板生成长图，就给大家演示这样一件事，那么我们想把这个模板转换成一个图片，那么需要用到这样一个工具叫wk html图PDF，是这样一个工具，这个工具它有两个功能，实际上就是两个命令，一个命令是这样的， wk html图 PDF，然后写上模板的访问路径，HTTP冒号双曲线什么，然后后面写上你要生成的图片生成的 PDF存放的位置命令是把模板的内容生成一个PDF。

那么下面还有另外一个命令是w Cay html，to，imagine这个命令是把网页生成本地的一个图片，我们要用的是后者，然后这是我们通过命令的方式去直接访问它，那么我们通过Java语言去访问它，不需要倒包，我们就直接用Java原生的一句话， run time点get run time。Exec执行一个本地的命令就可以了。反正这工具就是比较小巧，比较方便。那么这个是工具的官网，下面我们就来看一下这个工具，然后的话把它安装好。

咱们用一下试试，然后如果试用过以后，我们了解了它的基本的使用方式以后，我们在模拟开发一个分享的功能，只是模拟，因为没有APP然后的话把后端生成图片的逻辑就利用起来。

好，那么首先我们看一下这个网站，我已经提前打开了，这样然后如果你想看它的相关的帮助手册点这儿，然后点这就是它目前它没有非常成体系，详细的文档只有一个生成的一个文档可以去参考。

然后你要下载就点这 Download，这里面有各个操作系统对应的版本，那么如果是windows系统，我们通常选或看你的系统是多少位的，我选的是64位的。

好，我已经提前把它下载好了，稍微还有点慢，但我已经下载好了，那么我把它装一下好，我把它装到d盘work的下面好，然后 instead完成了完成以后关掉就可以了，这就行了。

然后打开d盘work找一下 wk html to PDF，我们要用的命令是在 bean的目录下，这两个exe文件为了我们通过命令行访问它，方便我把它当前的路径配到这个环境变量里，我靠一下，然后在 pass里加一项就可以了，环境变量也配好了，接下来我就给大家演示一下刚才我说的那两个命令，然后我们随便敲一个网址，把这个页面生成一个PDF再生成一个图片，咱们看一下。

当然我们要生成的话，我们需要指定本地存放生成的文件的路径，而且它要求我们提前把路径建好，命令不会自动创建，路径你要自己建好，我就创建一下，我就在 d盘work data之下，我新建两个目录，一个叫wk然后的话杠PDF好再来一个 wk杠image就是说我生成的PDF放这里，生成图片放这里，这就很直接了。

好，那么创建好这个目录以后，那么我就打开命令行试一下。首先我先生成一个PDF Wkhtml to，PDF空格，然后你要写上一个网页的访问路径，比如说百度淘宝是随便什么都行，我写优客网的优客网的首页路径，3w.com这就可以了。

那么这个命令就会解析路径，就是远程下载到它的html的内容，然后的话把它转换成一个PDF文件。

好，接下来空格你要写上你要存放的文件的路径以及名字，我这是d盘是吧？D盘。Work data， wkpdfs在这里边我希望生成的文件叫一点，PDF简单点。好了，我就写完了，写完以后回车稍等一会儿，它会有一个百分比，最后它告诉你大就完成了。好，那么完成以后我们去看一下有这个文件吗？一点kdf有400多k打开看一下，好。你看是吧，牛客网的首页对应的这些功能，这个效果还是很不错的。

好了， Pdf就生成完了。

好，下面我们再生成图片，生成图片的命令和差不多，我直接写了wk wk然后的话是html to image，然后也是写上一个页面的访问路径，我还请留客网好。

然后还是要指定一个路径，第一盘work data，wkemad然后我希望这个图片的名字叫一点PNG好可以了，我就回车。但完成以后我们看一下对应的路径，data were awk image有一个图片打开看一下，咱可以放大对吧？

就是我们首页的内容生成的图片没有问题，然后这个图片挺大的，我们可以看一下有一兆多非常大，通常我们生成图片的时候不希望这么大，因为你生成图片以后你存的话也占空间，如果你想把它传到云服务器上的话，那也比较费空间，不要浪费钱。

所以说通常我们希望对这个图片做一个压缩，让它小一点，怎么压缩我在把刚才的命令再调出来，然后的话我们可以在 WLK html to，image的后面加上一个参数声明，我希望图片压缩到什么程度，那么这是这样写杠杠，quality就质量75%，就是你压缩到原油质量的75%就可以了，好这个数量可能是比较合适，它是一个性价比比较高的一个值，就是说你往超过这个值以后，那么它的质量没有明显的好转，但低于这个值质量就会下降，但是这个值就是75%这个值，它的效果还不错，还可以，性价比比较高一点。

好，因为我这是重新执行一遍，我想再生成一个新的图片，2点PNG写完以后，然后回车，好完成，然后再看你看二点偏激生成的是吧？然后就小很多了，才700多k然后打开以后，这个内容和刚才一样，好了，当然了其实我们平时在分享功能里一般不会这个网页不会这么大，我们一般分享的都是比较简单的，比较简短的，你像牛客网手机的APP它有一个应该有个打卡的功能，打卡的功能就可以分享出去，一般非常简单，就是一个打卡的数字就完了。

然后的话，所以说一般不会像我们刚才看到这个图片这么大，所以说时间行的时候效果应该会更好一点，这是我们通过命令来访问这个工具。下面我们再写点程序，通过Java来访问它。那么我在测试的包下新建一个测试类叫做wk test。那么这个类我只是写个面方法，通过面方法测一下就可以了，这就不用结构类的了。

所以说我也不用去引用那些注解了，然后我们像刚才PPT上所说的，我们就通过run time去执行一行命令就可以，我先把刚才的命令给它粘贴过来，粘到这个字符串里面，它好粘贴过来，然后把改成三点PNG然后你要注意我们这个命令就是枪在命令行里头你可以直接这样写，我们在这个程序里需要把命令的完整路径写出来，我需要写d盘，work，wk，html to PDF，然后的话是 GB，那么命令叫wk Image，wk html too，里面就最后有了d盘work，wkhtml图pdfb然后 wkhtml图为位置。

我再检查一下没错，然后我们的存放数据的目录还是把它放图片还是放到这里，我们来看一下。

现在我这个命令行，有了我要执行的话就是Iran thyme点get right time，exe c comment传入就可以了，当然了它需要怎么处理异常，我就拆开这一下，如果补发的异常，我就把异常抛出来，就把异常打印出来，如果没有异常，那我就输出一句话，ok表示成功的意思。

好，这个程序就写完了，然后我们一边执行的时候一边看一下文件夹里有没有生成一个新的图片就好了。

好，下面我就来运行一下命令方法，然后这边看这个图片你注意有没有看见？这个ok很快就输出了，马上就输出了，然后三是过一会才生成的，为什么会这样？ Untime他执行命令的话，他只是把命题交给本地的操作系统，剩下的事就是操作系统来执行。

这个时候我们Java程序不会等着说操作系统给我一个反馈，他不等，然后他就直接向下执行下一行。

换句话说，操作系统执行命令和我们当前的主程序它是并发的，它是异步的，因此我们生成一个图片，这肯定需要一点时间了对吧？可能需要几百毫秒，甚至一秒左右都有可能，需要一点时间它就慢，我们整个没有办法往下执行到这儿，这是很快的，所以我们先看到ok再等一会儿才看到图片，你要注意这是异步的，我们看图片对不对？也是没问题。

好了，怎么在Java中去调用这个工具就演示完了，主要是你要注意这行代码和命令执行的先后顺序，因为我们将来在解决问题的时候需要注意到这一点，你要没注意的话，可能会有一些你感觉比较奇怪的问题解释不通。好，那么这个测试代码通了以后，我们会调用这个工具以后，下面我们就来模拟实现分享的功能，咱们把在实际业务中走一下感受一下。那么现在我要做一件事，首先我想对把 wk这个工具它的命令，你看我们在程序中写这个东西不太合适，最好把它做成可配置的，因为将来我们这个系统上线以后肯定我们换的是Linux，对吧？那就没有d盘，这命令就不对了，把它做成可配的我们好改，这是一个。

再一个我们图片生成图片存放的位置，这也得可以改，因为将来我们要切换这个操作系统，这个都可以可配对吧？而且刚才我们 Wk image是我们手动创建的，你想你上线的时候还得在Linux下手动创建一个这个文件夹，你万一忘了怎么办对吧？

所以最好是我一个是把它做成可配的，再一个我们系统服务启动的时候，我们检查一下这个目录有没有，如果有就算了，没有的话，我把它用程序创建出来，保证它一定会有，避免我们上线的时候麻烦好。

所以我在正式写分享功能之前，我先把这两件事处理一下，我打开 application，补充点内容，这是关于WPA的配置，这个配置就是我们自己定义的，自定义的我叫wk，一点一妹子，然后.come on。生成图片的命令行是怎么写？其实就是刚才这段代码。

好，然后另外wk点那张生成图片的路径，我叫story存放的位置，那么当前是地盘 work，data。Wk EMAIL好了，这是参数我们在这里配好了，配好了以后一会要用，还有一件事要处理，就是我们服务在启动的时候，我要检查这个路径存不存在，如果不存在我要守我要用程序来创建。为了验证这个程序能不能自动创建，我先把这个目录给删了，我觉得都删了不要了。

好，这个代码写到其实写到哪都行，我就写一个配置文件，专门在配置文件里做这样的事情比较合适。

我在肯费格目录下新建一个类叫wk选这个好，然后这里边写上选这个reason，但其实这里面我并不想定义什么b因为 Double k她和splore也没什么直接的关系，我要做的事情就是在服务启动的时候要创建目录怎么办？

我可以这样写一个post construct，这表示初始化，所以我写一个初始化的方法，盈利，我们服务启动的时候，因为这个类带有configurations注解，所以 spron会以为这是一个配置类，他会先去加载它，先去实例化的，实例化以后就会自动调盈利的，因为有这个主角是吧？

所以在启动服务的时候这个方法就会调用一次，这就够了，这个时机就刚好合适。

然后这样我先提前先把 logo先实例化好，因为我要用好了，另外我还要把那个路径注入进来对吧？因为我们要创建的路径，我们得从这儿去读，把它注入进来，通过value我叫wkenet story好了，在盈利的方法里我只要创建对应的目录就可以了，不是吧？

创建wk图片，至于PDF目录我就不创建了，因为我们项目中其实用不上生成PDF，如果需要的话再说好我就先实例化一个饭等于你然后把路径传进来，这个file不是一个普通文件，它是一个目录，我们判断一下它存不存在 fire点excess是存在加个感叹号表示不存在，如果不存在我就创建对吧？

那就file点，make dir创建路径，然后创建完以后我再给他记个日志，说创建wk，图片目录，然后后续加上路径，因为这个操作比较关键，所以说我们记录下来将来可好通过日志可以追查好。

写完以后我们可以测一下。当前刚才我已经把目录删了，如果说我一启动服务，它就有了，比方说这个程序是ok的，好，我启动一下，你看这个提示已经创建了，然后这个时候我可以看一下目录，wk妹子就已经有了，但是现在这里面没有内容，好这就可以了。

准备工作完成以后，接下来我们就来模拟开发一个分享的功能，因为我这里现在没有 APP，我就用这个web请求来代替，但我们这个请求尽量做的简短一些，我们的精力不是放在这个页面上，我们是放在服务端的逻辑上，好，这样我就写一个CTRL处理前前端的一个请求，在这个请求之内我要生成图片，生成完图片以后我还给你提供一个请求，允许你访问这个图片，整个服务端的环境就搞定了。

好，那么我新建一个类叫塞尔塞尔肯抽了分享的controller，那么给它加一个注解，然后我在这里先实例化一下logo，一会要用。

好，另外我提供一个方法，那么前端的一访问我就要生成一个图片，那么我们生成图片的时候，怎么说它一定是异步的方式，然后因为生成图片时间比较长，一定是用if的方式，我们一般习惯于用这个事件驱动，这是一个分享事件， controller只需要把这个事件丢给卡夫卡，然后后续有卡夫卡实现异步实现就可以了，而不是在这等着，因为你等的话时间会比较长，然后的话客户端响应的话会比较慢，这样的话服务器处理的能力就比较弱。

既然要用衣服的方式我们要用卡夫卡，所以说我需要把 invite producer把它注入进来。

另外的话我们在这里还需要用到什么？用到我们应用程序的域名，还有这个项目的访问路径，我们生成的时候用不上，主要是用户访问的时候他需要一个访问路径，而这个访问路径和域名和这个项目名是有关系的。

所以我们把这两者注入进来，首先是域名 Domain，我再来，然后我先不写，我记不住 k然后是项目访问名，contax pass好这两个key，我们可以从配置文件里拷，之前就有你看域名在这，然后项目名防路径。

好，这也是准备工作，然后接下来我们还需要把图片存放的位置也传进来，因为你要你要生成图片，需要用到这个路径也要把它转进来，这个路径刚刚我们配的就是它。

好了，这些准备的数据准备完以后，下面我们就可以写分享的请求了，我就先声明它的访问路径为class的卖品，分享就叫赛尔，然后请求方式我就get了，咱们简单一点，另外我把这个请求做成异步的反馈精神，这样简单，我就不想返回网页，我们也没有给他准备一个什么反馈的页面，所以加上 response包点。

好，然后把这个方法声明一下，这个请求需要传什么参吗？显然要传参。

你分享的时候你分享的是哪个功能，你需要把这个功能传进来，我好根据这个功能去生成对应的图片，那么其实我们跟我们实际上如果是个APP的话，你把功能传给我，我根据这个功能找到与功能匹配的对应的模板的路径，这有一个严格的对应关系，然后通过路径去生成图片，这里我们也没有什么功能，干脆我就直接要求浏览器把路径传过来就得了，你想生成哪个路径你就给我传就行了，我们省略一点事。

好，这里传的是什么？是html URL，比如说就像刚才我们写的 Knocked的calm，像baidu.com这样的东西，那么继续我们就来实现这个逻辑。

首先我们生成的图片文件名我们需要随机一下，这个要随机一下，每次都要变，不然的话很容易就重名了，所以说先生成文件名随机，好，我就叫file，name等于 community YouTube点儿standard uuid这就一个随机照片儿就可以了。

然后宣传完以后，因为我们采用义务的方式去生成长图，所以我们需要构建一个in mind好new in mind。

然后这个事件比较特别，它和什么点赞关注什么的不一样，我们在这个时间里也不用传什么实体什么的，我们这个数据怎么携带，这样我先把 topic先指定一下，然后的话再去携带这个携带数据，我们可以用 map可以传任何数据，但是目前这个topic我们还没有加以声明，我还得打开常见接口对它做一个处理加一个主题，在这讲主题这个主题是分享，好，然后回来这里我得实现接口，便于引用常量，好。

这个主题就是topic sell，然后我要携带一些参数，直接点site，data这是把这个数据存到了 map里，这样就方便一点。

首先要存的就是 html UI html路径把它传过去，然后 site继续再site一个file name，文件名我们在这生成也要传给他，文件名我们在CTRL来指定，然后让卡夫卡按照这个名字去生成，这只是文件名，注意它还得有后缀后缀，你是PNG还是JPG，这个也是我们在这指定 site data surface就是后缀，我希望都是统一的，都是偏近就完了。

好，这个事件相关的内容就指定好以后，我们就触发这个事件一慢不丢色，然后就发一卖，把对象传入就行了，这里写个注释，这是异步的生成长图。这样的话如果说你当前同样打卡分享的人特别多，那么我们这个方法的处理的效率也很高，因为他不用等待，这个内容处理完就可以继续下去好了，然后我们需要给客户端返回点什么东西，返回什么呢？

返回一下就是说我生成完长图以后长图生成完以后你怎么去访问它，我需要给你返回一个访问路径。所以下面我要给它返回访问路径。这个访问路径我们是这样的，我们最终是return应该返回一个Jason字符串对吧？

我就每天肯定那天又跳要 Get精神的时候，咱们第一个可以给一个0表示成功，第二个 now我没有什么提示的消息，然后第三个我给他一个map，就 map里可以额外携带一些数据，所以我把返回的路径放到 map里，因此我觉得这样需要16块的map，然后在 map里存上一个路径 map，点put路径我就叫crurl好这个路径拼的时候，你注意你可不能拼成这个东西， D盘什么对吧？因为d盘是我们本机的路径，用户远程不能用这样的方式来访问，他需要通过HTTP协议来访问对吧？怎么访问我们就需要拼了，首先是度命，我们这个项目的域名加上contact pass项目名，说白就是HTTP冒号双曲线，比如说127.0.0.1斜线community这样的路径对吧？然后后面还得加上我们自定义的路径，我们希望下级这个功能路径是什么？是赛尔这是我自定义的，然后 Image，然后image下集跟的是 family就这样就可以了，他通过这样的一个外部路径来得到这个图片，当然这个路径需要我们实现，我们一会要写这个代码去实现。

当然我们先停一下，我们先做这样的一个事情，就是先把异步请求给它处理掉，现在还没有处理对吧？

所以我们需要写消费的事件，我们去打开英曼特跟萨玛，那么在这个类里头我们也需要注入一些内容，那么首先我们需要注入的就是 command，wk command以及wk的存放的位置，这里边我们都需要用到，然后注入一下，这个可以copy咱们刚才 CTRL那里好像他有 stories把它拷过来，当然我们还需要另外一个 come on的给他补一下，wk里面come好。

拷过来好了，这两个内容有了以后，下面我们就可以来消费，分享实践了，我们就再加一个方法来消费这个主题就好了。好，我就写上卡夫卡，为什么？然后的话topics等于这里边我只有一个值，就是topic。Sell，当然了后面他需要跟着一个方法，wide handle。Sell message，然后当然这个方法需要有个参考参考一下，然后这个方法一开始我们也是怎么判断这个参数，怎么去取阴脉，和之前的这些方法都一样拷一下。

好了，如果说我们能够取到这个参数，我们就去处理后续的业务，我们从1万个点能得到什么，把那几个值先得到。一个是html URL，you might点 Get data，这是一个map，然后再get htmlurl这就是我们想要的数据，当然这里需要转型一下，这是第一个值，后面还有两个值，我们可以copy。

第二个是send name，t也是send name，然后的话是 surface，后缀 k也是一样。好，那么这三个值取到以后，我们怎么去执行这个命令，就是利用这些条件把命令拼出来，然后就执行就好了，对吧？我们需要先拼命令，他不是写死的，首先需要拼关键词，就是wk，盈利com对吧？然后加上跟着的是压缩比，或者说质量杠杠，quality，然后75别忘了前后有空格。

好，然后我再另起一行再加上就是html的访问路径， htmluil然后再加上一个空格，再加上图片存放的本地位置，就是wk位置，stories对吧？

然后他后面这只是目录，你还得加上图片的名字和后缀对吧？然后加上斜线，加上final name加上后缀。

好，连起来就是wk html to image。尴尬quality75。空格。Http什么？空格。D盘如何对吧？就是这样一个完整的命令。好，有了命令以后怎么执行就 get run time点exec对吧？然后的话传进来这个come on就行了，当然我们需要对这句话处理异常。那么这样如果说没有问题，这里我记个日志， log点Info说生成长图成功，然后把 come on的把命令给它也记下来好。那么如果失败的时候，给个也记个日志，还有生成长图失败，然后这个时候我把失败的信息就把它记录下来，就这样。

好这样就可以了。

这个事件就消费事件的逻辑就写完了，写完以后我们再回到刚才的CTRL上，这里我们只是说能够把这个图片生成，那么你给用户返回的访问路径我们还没有处理，这个处理就比较容易了。

因为之前我记得我们做过上传头像，上传图像应该是在 user controller里对吧？然后头像的访问路径我们不是处理过吗？其实跟这个是类似的，在这里我们就类似的逻辑我们再写一遍，获取成熟为快速的卖品 pass，我叫sir，然后 image后面跟着一个family，其实你看我们这个是不是这样写的吗？

我们的路径前面不说了，项目里面不说了，然后赛尔盈利成本是范围内对吧？所以我们需要按照这样的方式去处理或者说实现这个路径，然后 master等于 get好have it？

这个方法就不能简单地返回一个，它不是返回模板，而是直接给浏览器返回一个图片。我们需要通过response直接处理。好这个方法名儿，我叫get sat eat。然后首先我就要把路径中的参数先得到单位内部，先得到用 pass variable。好，另外我需要用 response，那么准备好以后，接下来我就在这里用这个risk向外输出这些内容。在一开始我先做个判断，判断一下这个参数。String YouTube点is blank。File name。我先判断一个参数，如果参数为科目我就抛异常，这没法返回说文件名不能为空，好，那么不为空我们就要输出了，手动输出内容的时候，首先你要声明我输出的是什么 set，content type那就是你妹去偏近，好，EMAIL表示我输出的是图片，后面偏近的表示的是格式，然后继续我需要我输出的话，我需要读取本地的文件对吧？

我先实例化一个file，new Fein这个路径是wk midge storied对吧？加上文件名加上斜线加上文件名，file name对吧？加上点评级固定的。

好，然后我们就要输出了，输出的话我们因为这是图片是字节，所以我需要获取 output stream，通过response获得好这句话说要处理异常才开始一下，那么如果有异常，我们给个记个日志说获取长途失败，后面加上详细的错误信息，好，那么如果没有18我们继续我觉得他要读取这个一边读取这个文件，一边往外输出要读的话，我要实例化一个file， file input stream等于new file input stream。

把file传进来，把这个文件转换成一个输入流，然后的话每次读取我们需要有一个缓冲区大一点，8分等于new，but你长度自定义我定义为1024个字节，然后在上面的游标，然后通过while读取，如果说b等于 fis点read8分，如果这个值不等于-1，每次我读读取到了读取的数据都读到8分里，然后的话把它赋值给 b如果不等于-1就表示我确实读到数据了，这个时候我就把它写到输出给目标，如果说没读到 while就结束 os点。

Right，8个。

然后的话从0~b因为你最多能读缓冲区这么多值，但有可能最后一次达不到这么满，所以说你要有一个范围声明，好，这样就可以了。我们读取图片的方法也就完成了。好，接下来我们就可以测试了，我把这个项目重启一下，好勒。重启以后打开浏览器访问一下， House。我先访问个首页，然后这个就不需要登录，咱们也没有什么限制，谁都可以访问，然后的话style Cr后面你要带一个参数，带的是什么？带的是 Htmui对吧？

是一个外部路径。你想把哪个网页做成图片，就把这东西传进来，我就问号htmlurl等于我就写留客网吧好，这个路径写完整好，完整以后回车，回车以后他给我一个响应，我这搞错了，你看按理说这个地方应该是一个HTTP什么，但是他想象这个说明什么？

他我这参数注入的时候写错了，估计看一下确实写错了，这里应该写个到了括号忘写了，图片生没生成没生成，看看报没报错，报错了。

然后说找不到指定文件，我估计那个地方我也写错了，看一下，确实这地方也写错了，就是说你看他的反馈，他反馈说明明这个地方应该是一个具体的值，但他写的是k那就很显然你 k没有被成功地替换出value，那就是你注入的时候就写错了，所以这个是很明显的。

好，改完以后还得再重来一遍，肯定是f九重新编译，好写完以后打开浏览器再来一遍，我刷新一下，回车，怎么还是不对？再刷一下。我这儿也没写对，我说怎么还不对，再来一遍。Ctrl f9。这个图片生没生成看一下。图片已经生成了，这样我把它删掉重来。好已经重新编译重启了，我再回到浏览器回车，你看这回这个路径就对了，虽然长一点，但是它格式是对的。

看文件生成了双击打开，确实是一个图片，那么我通过它返回的路径能不能访问，再打开个页签粘过来回车可以访问是吧？这次课我们生成长图就演示完了，然后怎么去模拟开发一个分享功能，在一个分享功能，你把它用起来，咱们也给大家做了演示。好，这节课我们就演示到这里，咱们下次课再见。