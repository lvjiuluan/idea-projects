29-Spring整合Ridis.mp4

这次课我们来学习，利用spring整合reds，那么关于整合的方案，我们从spring的官网，它有一个模块叫spring data，然后里边有关于整合rise相关的内容，你从这个手册里能找到这个答案。当然了这个手册比较长，那么我把这个手册中的内容做了一个提炼，然后呈现在这次课里呈现给你。

那么总体来说我们用spring整合readiness大致分为三步，那么第一步我们需要打包，而super boot他对 Red spot做了一个处理，那么我们可以直接导它整合以后的 start data readies包，打完包以后第二步我们需要对riders进行配置，因为它也是一个数据库，所以说首先你要在配置文件里，也就是application点properties里配数据库的参数，其次我们需要写一个配置类来构造 spring rides它的一个核心的组件叫rides template。

那么这个组件是由spring提供给我们的，当然了其实 spring boot它也对ready是做了一个自动的配置，其实它已经配好了 readies template，不过它配的对象，因为我们知道瑞迪斯是q56结构的数据库，他在配的时候他把 key做成了object的类型，但是这样做的好处是更通用，但是其实我们一般用的时候我们都是用的都是死菌，所以说它配成了奥PK的，我们用起来不方便，因此我们需要重新配，这里是其实是做一个重新的配置。

那么配好了 release template以后，我们在写代码的时候都是用组件去访问radius。那么比如说你要访问 string类型的数据，那么就read this template点ops of reasons for value。然后你要访问希类型的数据，佛希for list，for sat，for this sat，所以说通过这个方法名，你也就知道它大概代表的含义，总之这里边每一个这样的方法就返回一个对象，这个对象能够访问这种类型的数据就非常简单非常直观。

好了，那么接下来我就把这三个环节给大家演示一下，首先我们先来打包，那么我打开 maven reporter到com，然后搜一下包我就搜release。

好，那么收到以后我们要 spring boot data red is daughter，然后点进去，我选一个比较新的版本，然后把这段配置代码贴过来，粘贴到我们项目当中的 pom的xml。

好，实际上我们可以像这样的包厢springboard，它所整合的包或者是死不用说整合的包，其实很多时候我们可以不用去写 working，你可以把它去掉，为啥不用写word？

因为当前 poem它是继承于了某一个副poem，副泡沫中声明了很多包的常用的包的版本，所以我们纸泡沫可以不用去写这个版本，而且它负泡沫声明的这些版本互相它做个测试是兼容的，不容易出错，负泡沫声明什么咱们可以看一下，你看这就是副泡沫，然后这个是它的ID，你CTRL可以点进去，点进去以后它又有一个副框是它你再可以CTRL点进去，这里你可以看到它定义了很多关于各种炸包的版本，比如说我想看有没有rest，你看他就定义了 spring boots，start date readies他定了这个包，然后版本是2.1.5，那么这个版本它在这些包当中彼此是做过一个测试的，是互相兼容的，我们如果不写word的话，它用的就是这个版本。

好我就不写了，因为我们当前用的版本和其他的包，就这个体系当中的包它是比较匹配的，就这样就好了。那么打完包以后，第二个我们需要对数据库进行一个配置，我就打开 application，practice在后面做追加，我们当前的配的是release，这个ready你看一下，ready你可以搜一下。Rises out to confirmation这是死不认不得，对。

Rises做自动配置这样的一个BIM。

然后你会看到它自动配置的时候配的其实是类中的属性，是对类进行配置的 radius process，然后你会发现它配了 ready stop累的，然后 key是奥迪不好用，所以一会我们需要把它重配好了，回到配置文件就是我们配的所面向的类是这个类，然后这里边我就直接写我要配什么 spring，点readiness，点data，base。

就是我pay，我要用readiness中的哪个库，它不是一共有16个库对吧？我得选1个，我要用哪1个，你随便这里我选11好。然后 spring点rides，点cost，你要写上一房的库，它的 IP是多少？那本机 Host。

好，再来spring点rises part端口。那么我们安装的rids默认端口是6379。行了，当然其实还有更多的参数，我们不用挨个都配，其他的参数都有默认值，这三个是你一定要配的。好了，那配完以后按照刚才我PPT上所说的，下一步我们需要编写配置类，把 release他配的配好，那么我就在 can figure目录下新建一个类，然后这样 radios can figure对吧？这名字写得不好，写错了。

虽然说无关紧要，但是还是改一下， red is conveyed。

那么配置类我需要先写上consideration，好，然后再写上b我需要定义第三方的b那么这个方法声明为公有的，那么你要把哪个对象装配到容器当中，那么你就返回这个对象，它返回的是readiness，template。泛型它的key我希望的是使命，它的外流是object，然后这个方法名其实就是bean的名字，我叫red is timeless。

好，那么因为数据库我们访问数据库利用time play的访问数据库，那么这个time play的要想具备访问数据库的能力，他得能够创建连接，连接是由连接工厂创建的，所以说你需要把连接工厂注入进来，然后注入给他们类的，他才能够访问数据库。

那么你可以这样在这个方法之上，声明连接工厂叫reds connection。然后 factory red is connection，factor的名字我叫factory。那么当你在定义一个bean的时候，然后方法上说明了这样的参数，那么spring容器会自动的把并注入进来，这个并已经被容器装配了。好，那么在这个方法里我就要实例化，这个病 ready template6室内化完以后，我需要把工厂设置给 template， site，然后是connection，factory。

好，那么template有个工厂以后，它就具备了访问数据库的能力，我们配这个产品类的主要配什么？其实主要配的是序列化的方式，因为我们写的程序是Java程序，我们得到的数据是Java类型的数据，最终你要把这个数据存到 risk数据库里，那么你要指定一种序列化的方式，就是说或者说数据转换的方式。

好我这样社长，因为rides它是ky6结构的数据库，所以首先我要声明我要设置 T的序列化方式，除此以外我还要再设置普通的value的序列化方式，普通的，然后另外那么有一个外流比较特殊， y流本身是个希又分为py流，你这个时候还要这样设置希的t序列化方式，然后设置希的外流的序列化方式，基本上我们把这4项设置好就可以了。

好怎么设其实也很好，起 template。点set key，series设置key的序列化方式，序列化方式有一个类里边有了一个统一的定义，我们可以直接访问。类的叫radius theorizer Radius sterilizer，然后点儿使劲，那么这个方法它返回了一个能够序列化字符串的序列化器，你就指定为他就可以了，我们自己不用去创建这个东西。

好，然后再设置 value的 template点儿，site value zero，lever，然后还是去掉，相当于是一个工具类，然后点 value的话可以有普通的值，也可以有集合列表，你要把这样的数据需求化成什么样的方式呢？

通常我们建议是把它序列换成Jason，因为 Jason格式的数据它是结构化的，我们恢复回来也很好去读取，很好去识别，所以说节省的去的话，现在这里也有有点节省就可以了。

好再来，那我在template点site希写错了，希key zero letter。那又是key又是字符串，那你还用这个就可以。

好，然后 while yo tamper layed，点cide哈希Vai6 zero Liza，那么value可能是各种形式的数据，你还是把它转成Jason比较好，其实主要就是设置这么几个东西。那么设置完以后，为了让template当中的这些参数生效，你还要调一下 Template的点after property set就是当你设置完了，做完了一些设置以后，它要触发一下生效。

好，最终我们return template配置就搞定。好了，现在我们包也倒了对吧？数据库的参数也配了，然后 Template我们也配好了，接下来我们就可以通过 ready template去访问readiness，下面我给大家写一个测试类，我们把对reds的各种类型的访问做一个演示，看一下 reds他们类的怎么用。

好，我就创建一个新的测试类，我叫readiness test，当然这个类上也需要加上那么几个注解，我copy一下。

好，然后我们要访问 release，全是要利用刚才我们所配的 template，所以我们哪儿需要访问rides，就需要把 template注入到哪里去。好，我注入进来了， Red is template，然后下面我就写测试方法，首先我先给大家演示一下我们怎么访问这个字符串，以字符串为值的数据，写个字的方法，这个方法名我叫 test使用。

好，首先我先声明一个 key，我在声明之前我们先看一下 ready库，先确认一下这里面有什么东西，我当前的项目指定的是利用的是11库是吧？所以我选中11 kiss星，你看这里啥都没有，目前什么都没有。好，然后待会我们出了数据以后我们再看，首先我要声明一个key，我先声明一个变量把它定义好， ready？

Skip等于。

这是测试数据，所以说我以test开头，然后 count还是数量，就和我们上次跟他演示基本的命令一样，我想存一个count。

好，然后那么存的方式就是利用 template，然后点ops，放 Value就是string类型的值，访问string类型的数据，然后我要存数据点sat，你想咱们命令不就叫site对吧？其实它方法和命令基本上是对应的，然后这是你要声明我要给哪个k赋值，值是多少，值是一，就这样。好，这是纯数据，我怎么取再演示一下，取出来以后把它打印出来。 Read this template，然后点ops for value然后获取get你要写成key， red is key。好，再来，比如说我要把 count增加或者是减少，怎么办也很好做。 Radius template点。

Ops for value点。Internet，那么我们所学的命令是incr是简写，然后它它对象里的方法是全称更直观一点。

好，然后 red SK好再来一行。那么如果是减少就是de decadent，好就演示这么几个，然后我就执行一下这个方法运行。好，那么执行完以后看一下控制台它的输出，我们看打印的是三三个获取的行为，第一个我取到的值是一没问题对吧？然后增加以后返回了新的值，变成了二对吧？减少以后新的值一没问题。然后这个时候你再看控制台，命令行 His星有这个值了。

好了，以上就是我们对string类型的数据的一个访问的方式，那么其他类型大同小异，我这里也快速的给大家演示一下，也很简单的。

那么下面我们再演示如何访问，希还是先声明一个key，test user，比如说我要存的是用户，然后我就这样哈，ID s template点ops骚哈希，然后往希中存值是put首先你要写上 k而你存的值本身也是一个它也分为ky6，你要写这个值的k你看HK就希t值的y6，类似再来一个，比如说我想存一个user name张三，好，这是存值，取值也非常简单，我就copy一下。

第二 get写成key，right？

Sk然后的话再写上value的key ID，同理这个我在获取邮政内容就可以了，写完以后执行。好，你看我最终取到的值是一张三，看命令行，kiss星太悠着，有了，没问题，好，再来。如何访问列表。

也。

是一样的，首先写个key，比如说我要存一组ID，然后我先存这个列表，从左边进或者从右边进都可以，这里我从左边进。那就read this template。点o ps for list。点left toss，好，命令是l toss，这里是left toss，它就全称没有简写。

然后 Red is key，我要放一个101这个数据，同理你可以在102103放多少个都行，都是从左边往里放，放完以后我们再演示怎么去取，怎么去访问，还是瑞丽斯谈不累的点，ops for list。

然后的话，比如说size是获取当前列表中一共有多少个数据，它这个方法叫size和命令不统一，但是可能更直观一点。

好再来，比如说我还可以这样 index，然后零那意思是我要获取第零个位置的那个数据，也就是获取某一个索引所位置所对应的数据，好，再来还有 range按照范围取数据。

那么02意思是我要获取从0~2范围之内的数据，02是索引，然后还有弹出的方法，怎么让这个数据从列表中弹出去出，对。也非常简单，我这样写 Ops for list点那就看你想从哪边弹了。

从左边弹就left pop，右边弹就是write，pop我就从左边弹了。Left pop，然后 red SK好执行三次把它们都弹出去，好，这就写完了，那么执行一下试试。好，你看这个结果，一开始那么统计的数据量是三没问题对吧？然后第零个位置的数据是103，因为左近对吧？101先进去了最右边，103最后进在最左边，然后这个范围内的数据就是这样的数据。所有的数据谈的话，我是从左边谈的，103102101是这样一个顺序也没问题。

好，那么接下来我们再接着演示集合，老规矩还是先声明 key，比如说我要纯teachers，然后那么我们往集合中存数据非常简单，readiness template ops for sat，然后的话纯数据 I的把 t写上去，然后加上你要存的数据就随便写，比如说刘备其实这块可以直接后面逗号加多个参数，纯多个数据，直接存多个多写几个，好，那么我写了这么几个人名，然后这是存进去了，怎么取怎么统计它里面的数据量什么的，那是这样的，把这句话call一下，然后点size，就是多少个数据， ready ski就可以了。

好，再来复制一下，比如说我要从这里弹出一个数据，你就pop它不分左右，随机弹出一个值。好，再来比如说我要统计集合中一共有多少个数据，所有的数据都是什么，你可以这样 members，然后ready ski非常简单，好，执行一下，你看这个结果存完以后一共有5个值没问题，对吧？

然后随机弹1个他弹的诸葛亮，然后再去统计它里边一共有多少个人名，就4个没有问题。

那么最后一个要演示的类型是有序的集合，test，sorted set，还是先声明一个key，比如说这回我要存的是学生16.4，那么存的话就是red is template点ops for这三条 I的然后你要先写上 key， read this key，那么有序集合它是存的时候要存分数。

第二个是存值，比如说我要存的是唐僧这个人，第三个要存他的分数，就随便写了，比如说80 80分，这是一个，再来一个悟空，比如说90，我再来八戒50，然后再来沙僧，比如说起始好最后一个白龙马60，这样的话我就存了好几个人，每个人都有一个分，都有一个排名，我们来看怎么去访问这些数据，把这句话copy一下。

然后点z card，z card是统计这里边一共有多少个数据。好，再来。10杠写出来。10杠。Scar是统计某一个人的分数，比如说我要统计八戒，查询八戒多少分，好再来，这个是比如还可以这样， rank是统计某一个人的排名，比如说八戒的排名默认的话，它是由小到大排序的，如果你想由大到小排序，你可以这样可以 reverse rank，它就会由大到小按照倒序排列，然后给你取一个排名，好再来还可以这样问题。

认知是某一个排名范围内的数据，我希望从0~2取前三名，这样的话是由小到大取前三名，如果你想由大到小取前三名，也是像类似瑞沃斯 range，它是按照由大到小倒序排名，然后取前三名012。

好，那么执行一下。好看。首先统计的数量是5。没错。然后统计8届的分数，50没问题，八戒的排名第四，那么按照由大到小应该是悟空第一，唐僧第二，然后三，第四，八戒排第五，但是它返回的是索引从0开始，所以八戒就是4。没问题，然后统计由大到小前三名，分别是悟空、唐僧、沙僧。没问题，对的。

好了，当然了除了访问这5种类型以外，那不是还有一些公共的命令可以访问 Key，对吧？这个也演示一下，也有相关的API可以做到，我直接写了比如说 radius，template。

第二我想删除一个key，delete，我要删除这个 user，好，我们先确认一下这里有没有user？有对吧？现在我要删除它好，然后再来我还可以这样做。

 Read this template点has key，相当于是 access命令，判断某个key存不存在，删除以后我就判断 key还有没有。

好再来我们还可以针对某一个p的数据设置过期的时间我设置一下，write is template点x expire过期的，然后你要指定一个k我就随便写了， test16.4，我希望它在10秒，但这个10秒的单位你要指定它默认默认好像是毫秒，不管是什么，我们可以通过一个工具类来指定叫time，unit这个类，然后点seconds，比方说我10它的单位是秒，这样就很清楚了。

好，就演示这么几个，至于说 kiss命令我们通常不会在程序里这样写，这都是一般我们去数据库查看，有什么东西偶尔用一下，我们平时写代码几乎不会用到命令就不演示了。

好，我就运行以后，你看这个输出结果是false，没有 key了，确认一下 kiss星没有了，但此时还有students，因为这个时候还没到10秒，我再来一次，随阵子没了，超过10秒了，那么常规的操作我们就演示完了，那么在刚才我演示这个代码的时候，可能有细心的同学会发现一个小问题，你比如说像这个方法，我在一套逻辑里可能是要访问 release多次，有可能每次访问的时候我都访问同一个key，每个API我都要把 key传进去，这做一件重复的事显然是比较麻烦的。

那么其实针对这样的逻辑，我们是有一定的简化的方案，我把这个方案也给大家做一个演示，这个方案也很简单，就是我们在一开始的时候，我们在创建访问瑞丽斯对象的时候，就把 t给它绑定进去，是可以产生这样一个绑定t的对象，然后我们利用这个对象就可以反复的访问同一个k如果有这种情况，你用这种方式解决可能会更舒服一点。

好，那么写个注释，这就是我们多次访问同一个k。

以绑定的形式来存在，我们再写一个新的测试方法。

这个方法我叫test bond绑定 operations绑定操作。好，其实我们将一个key绑定到一个对象上，所产生的对象就叫绑定对象，就叫棒的什么operations。

好，比如说我还是要访问 test，count key我先把 key先给它说明好，叫test。Count刚才我们访问过了，而且它里边还有一个值是一，好，那么如果说我想反复的访问它，我可以这样写，棒的，然后外流瑞森斯，如果你想访问其他类型的key，那么你可以这样棒的，比如说希 operations site of reasons，所以说中间的棒的什么office中间是你访问的数据类型的一个单词，这里我要访问的是 value of reasons。

那么这个变量我就operations，然后等于read this template点，然后棒的棒 value operations，如果是其他的类型，那就棒的什么？其他的operations。

好我把 key传进来，然后我利用这个对象去访问 release，访问就是 k访问的时候，它 API其实和之前的 API是相似的，只不过不用传 key了，非常简单，比如说我要访问 com，我要将它累加，我就直接点internet，你看我们之前访问的时候，之前累加的时候是要传入key的对吧？这样的，现在不需要了，因为提前已经绑定好了。

好我多加几次再来一次，好我又累加了5次，最终累加完以后，我再把这个数据得到再输出一下，那么获取的时候也是利用office，然后点get叫get就可以了， get的时候你也不用传输t因为已经提前绑定了，那么写完以后我来执行一下这个方法，你看最终的结果是6，那么之前我们增加过添加过这个数据，然后对它做个操作，但它最终的结果是一这次我们又给他累加了5次，最终结果是6，这是没问题的。

好，最后咱们再聊一个话题就是事物，那么因为reds它也是一个数据库，它也是支持事物的，但是它所支持的事物的机制其实不完全满足 acid4个特性，因为毕竟它不是关系型数据库，只有关系型数据库才严格满足这4个特点。

然而总体来说 release他的事务管理的是比较简单的，它的机制大概是这样的，就是说当我启用事物以后，当我再去执行一个 release命令的时候，它并不会立刻执行这个命令，而是把这个命令它会放到一个队列里，先存着，然后你在执行一个命令再放到队列里，直到你操作完了，你看你提交事务的时候，它会把队列中的命令一一股脑发给 reds，服务器一起执行，它是这样一个机制。

所以这里面其实就有一个隐含的问题，你使用的时候一定要注意，那么因为他这个事物之内的命令不会立刻执行，而是提交时统一批量的执行。

所以说如果你在事物的过程中做了一个查询，这个查询不会立刻返回结果，也就是说你不要在事务中间去做查询，你要查你要么提前查，要么事务提交以后再查，所以说这一点大家一定要注意它可不像是关系数据库这一点你要注意。

那么我们在开发的时候写代码的时候， spring也是支持编程式事务，还有声明式事务，当然也是声明式事务它更简单，然后只要做一些配置，然后加上存在性的注解就可以了。

但是因为它的事物刚才我说了，它有这样的一些问题存在，所以说我们通常不会用声明是事物，因为你声明是事物，它只能精确到一个方法，我要在这个方法加上存在智能，而方法内部，那么整个逻辑都是整个的事物范围，这个方法之内我就没法去查询了，对吧？

所以说通常我们都用编程式事物把事物的范围缩小，我比如说中间这三步，我需要管理事务，就把第三步写到相关的代码里，其他的地方你该怎么样就怎么样。好，所以鉴于这种情况，我只给大家演示编程声明式事务，因为用的少我们就不说了。

好写个注释，这个是编程是事物，再写一个测试方法。

这个方法我叫test转加起来，

演示的是这个事物，那么我们想处理事物其实也还好比较简单，那么也是调用red template，然后点 sq的，那么这个方法内部需要你传一个接口的实例，我们可以做一个匿名实现ani筛选，然后叫call back session，call back接口里边带了一个方法叫sq的方法，这个方法会在 sq的方法调用的时候，它底层去自动去调的，调的时候它会把 operations就是执行命令的对象传进来，我们就利用对象来执行命令来管理事务。

当然这个方法返回一些数据，那么最终会返回给 sq的方法。所以说我们可以在这儿接受这个数据，它的类型是opx由你来定到底是什么东西。当然我得到这个值以后，我最终把它输出一下看看，而不是return。我们看一下这个是个什么东西就行了。

好，下面我就在这个方法之内给大家演示一下这个事物，当然我首先需要提前定义一个key，我要定义一个key readiness，key这个key我叫test

 tx。

 TS就是casino的缩写，事物的意思，好。

然后那么我们利用这个对象有两个关键的方法，第一个方法叫做operations。

我把这个参数名写的简单一点， business点 market这句话是启用事物，启动事故以后你可以执行一些相关的操作，然后最终的return的时候你要return of recent点 exec这是提交事务。这中间我做一些简单的逻辑的处理，随便写点啥，我这样写。Of reasons there。Of ops For set，对，我要存的是集合的数据，我要往里添加数据，首先把 key写上，然后的话加一个直张三。

同理我再来，事物肯定里边是多次的点，ml操作对吧？李四王五。然后我说了我们在开启事务和提交事务之间，他是把命令放到队列里不会立刻执行，所以说你查询其实这个时候是没有效果的，咱们可以试一下。

Operations点 Ops for site，然后我要查一下它里面的数据 members， ready skit，看看里面能不能得到数据，这就完了，总之我们编程式事物就这两句话是关键，整个还有整个代码结构是一个关键，好写完以后我来执行一下这个方法。

那么大家看这个结果，首先我们在刚才这个方法内部做了一次查询，你看第一次输出就是一个查询，然后它打印出的结果是空的，确实什么都没有，所以说我们在rise管理事务的时候，中间一定不要做查询无效，注意，然后最终他确实执行了，执行完以后给我们返回了一个最终结果，这个结果你看这个结果包含的数据比较全面，首先它的三个一代表的是每一个命令，执行的时候，它影响了数据的行数或者数据的个数，每次都添加一个数据，一一一一分别添加一个数据，没问题，然后最终他给我们显示出来集合中最终所有的数据都查出来了，张三李四王五也就没有问题。

好了，那么这次课我们就把 spring整合ready相关的这些API给大家做了演示，那么这次课我们就演示到这里，咱们下次课再见。