31-我收到的赞.mp4

这次课我们来实现我收到的赞这样一个功能，就是我们在个人主页上要显示这个人他所获得的所有的赞的数量。当然我们现在通过点赞的数据是可以把这个数字统计出来的，不过你有点麻烦，那么因为我们现在的是显示某个人他所获得所有的赞，你要统计这个人发过多少个帖子，发过多少个评论，那么把这些帖子和评论的赞的数量把它加起来，这样会很麻烦。

所以我们一般采用另外的一种方式，就是我们在用户点赞的时候，那么可以再增加一个维度把站的记录下来，我们可以再加一份数据，我们以用户为key，然后把这个数记一下，这个时候统计就非常方便了。

所以那么要想按照这个思路来解决问题，首先我们需要把之前我们所开发的点赞功能进行一个简单的重构，就是我们点赞的时候要以用户为t把赞的数量再记录一下。

当然每次记录这个只是数量而已，所以说我们只需要调用 in cream的方法加一就可以，当然如果你取消这样的就different减一就行，非常简单。

那么这件事完成以后重构完以后，那么我们就是来开发个人主页，然后个人主页上要显示用户的一些信息，然后要显示赞的数量，目前我们关注还没有开发，所以说关注我们先不用显示好了，那么大概了解这个思路以后，咱们现在就开始写这个程序，那么因为我们要在rids里承继一份数据，所以首先我打开 ridsqq然后我再增加一个k加一个前缀，这个是以user为key，所以说我叫practice user来好这样一个前缀，然后我再提供一个方法，写个注释，这是某一个用户的赞。

Get user like t因为你是某一个用户的赞，所以说很显然你应该是传入的是uz ID对吧？当然我这样我在注释的把 t它的形式把它写得直观一点，是like user，然后的话是user ID，那么我们存的时候就直接存一个数，整数就可以好，然后我就retrain，然后这个前缀，然后再加上一个分割符是贝类，然后再加上优质ID， key就ok了，拼好了拼好以后，下面我们就来改造点赞的业务方法，like service，我搜一下 like service。

好，就这个方法。

那么这个方法因为我们需要再加一个维度加再加一个维度记录数量，那么就是我们这一个业务当中会连续执行两次更新的操作，所以整个业务应该保证事物性。

那么rise如何保证事物，咱们之前不也讲了，我们可以通过编程来解决问题，所以说这个代码我需要做一个重构，这样我就干脆把它注掉，因为这个代码结构差的比较多，把它注掉，然后的话重新写的时候参考一下之前的代码就可以了。

好，我就写ready template is cute，然后new session call back。因为我们当前的方法没有反馈值，所以说我这里就不处理返回了，这个参数名改的简单一点 vs。好了，然后在这个方法内部我们实现我们要实现的逻辑，首先我要把这两个k拼好，是吧？一个是以实体为k再一个是以you的问题把 K也先拼好。Ready？Qq点get user let t这个时候我就需要传入uzid但是当前我们这个不是 user ID，这个是点赞的那个人，而我这个是被赞的那个人的user，说白了应该是实体的拥有者，实体的作者， user。

当然了我们一个是可以通过实体去查，但这个查又麻烦了，因为你得判断实体的类型，它是帖子还是评论，然后去查询。

另外你这里查的话又得访问数据库，本身我们这个ready是操作是性能比较高的，你一访问数据库它又把它的性能给拉低了，所以这样我就不查了，我要求你调这个方法的时候，再传一个参数进来，你把实体的作者传进来，加个参数mtt user ID。

那么我们在点赞的时候是在帖子详情页面上你点赞的时候，实体的uzid是很容易得到的，你传过来就很方便，加了这个参数以后，所以这个地方我get key。传入的就是 inttuzid好， t有了以后，下面的逻辑还得做这样一个判断，做这样一个判断。因为你要知道当前他点没点过赞，好进行下一步的处理。

我还是像之前的那样的写法，只不过这回是叫operations operations for site然后 is number把安贴贴来，key传入把 user ID传入，我们看一下当前用户有没有对实体点过赞，然后这块要注意的是你这是一个查询，你这个查询一定要放在事物的过程之外，因为之前我讲是不是讲过这个readiness事物比较特殊，如果你把查询写在事务范围之内，他不会立刻得到结果，因为他在事务过程当中，你执行的所有命令他没有立刻执行，而是把这些命令放到了队列里，当你提交事务时他统一提交，暂时性他比较特殊，好，所以提前先查询了，然后我们开启事务就是operations Martin对吧？

最后你执行事务，那么就是operations点exec那么在中间我们要执行两次修改的操作，当然我得先判断了is number，如果他已经站了我就要取消站，就operation死掉了。

Ops for site点取消删除数据，remove安贴贴来，然后又是ID。

好，另外你这是对实体为t的数据做处理，同时以优则为k也要做类似的处理o ps放这个我们存的是普通的死菌，所以放 y6，然后这个不是删，它是减一，数量 decrement减1，这个key是user like key，否则就说明没点过赞，我要点赞，点赞就是把这个数据加进去，所以call一下。

第一个还是实体为key，然后的话把u的ID加进去。第二个当然这个加得是爱它，第二个是以user为t t没问题，然后是增加所以是equipment。

好了，到这儿我们点赞的方法就重构好了，之前的这段代码不要了，处理完以后我们在 service里面再补充一个方法，因为你最终是要统计用户他被占的数量对吧？现在你是记了，你还得提供一个方法去查对不对？所以我在后面再追加一个方法，就是查询某个用户获得的赞的数量，我们直接返回一个整数就可以了。方法没有叫find you there like come。

好，那么参数就是uzid你把uzid传输就可以。首先我还是要拼 Key，这里我可以copy一下，这是uz ID拼 k推完 t以后我就调用red established点ops for value，对吧？然后统计数量这是一个字符串，你查询的话就直接get，然后把 t传进去，那么我们就会得到一个结果。当然它默认得到的是一个opat我们需要把它转为这个integer，这里需要转成integer。

好，转完以后最后返回数据返回的时候做个判断，因为有可能这个数据是now如果是我就显示为0，否则就显示数据的整数形式就可以了。那么service重构完以后，我们来重构表现层 CTRL以及页面的处理逻辑，我打开 like control了。

好，找到站的方法他已经报错了，那是因为我加了个参数，现在这个参数还没有对吧？好，我需要给这个点赞补充一个参数，目前这个方法还没有接受这个参数。我就加上一个int entertain，user ID。

好，当页面的把参数传进来，那么我就把它传给 Like方法这个点赞就搞定了，搞定以后这就可以了，那么但是我们需要对页面做处理，因为这个参数页面得传过来，现在还没有传对吧？那么我们点赞是在帖子详情页面点的对吧？

所以我们需要修改帖子详情页面，那么我搜一下详情页面的是disk，Cass，detail，html。

好，我记得一共有三个点赞的位置，然后调了三次那个方法，我们逐一给他做一个处理。好，首先这个地方是对帖子点赞， like，那么这里边我就需要给它加一个参数，你看当前是传入了实体类型，还有实体ID，我们需要补充的是实体的 user ID，那么实体这个post就是实体就是帖子对吧？那么user ID就很容易取，就是post有这种ID就行了。

好，这是第一处，那么我们再往下找，还有两处再往下看，这应该是第二个位置。 Cvo对评论，然后后面是回复，没问题，这也需要加一个参数，这个是评论的优质ID。 Cvo.comment是评论对吧？所以我就可以写cvo.comment，user ID。好，然后再看最后还有一个回复，在这儿再加一个参数，那就是rvo replay点user ID。

好了，那么你看这三个点赞的地方，我都把这个参数补充完了，但是你别忘了我们调的 like方法，也得支持传参数对吧？所以还得去重构这个方法，我们就打开对应的 GS我记得 GS是discs点GS，我给这个方法再加一个参数，叫做itt user ID。好，那么当你把参数传入以后，我需要传给服务端，我在这里加一个参数。

好了，那么其他的逻辑不变，主要是追加了这么一个参数，那么点赞的时候，我们就通过这个参数把用户把用户的他所得到的占的总的数量做了一个累加，当然最终我们是要在用户的主页上对这个数据做一个显示非常简单，因为那个页面的很数据很少，我们就把显示一起开发完以后我们再统一测试，那么对于个人主页它是属于用户的某一个功能，所以我不新建CTRL了，我把这个功能起到user controller之内，user controller里我在这里再追加一个方法，个人主页，好，那么这个方法名方法路径我叫做主页一般叫做profile，然后注意个人主页，一个是当前显示的是当前登录用户的主页，再一个你也可以查看别人的主页，因为你想我们在帖子列表上，每个帖子墙上不是有个用户头像，那个是可以点的，用户的详情里边的每一个评论也有头像，你私信也有头像，这些有头像的地方头像都能点到那个人的主页里，你是可以查看别人的主页的。所以个人主页不只是查看当前用户的主页，也是显示就是任意用户的主页，谁都可以访问的。

所以个人主页我希望你能传过来，你要看的那个人的ID，而不是当前用户，所以我希望这样我希望把用户ID拼到这个路径里，然后就叫优质ID，因为这是一个查询，所以说请求的方式是get好，然后把这个方法省略好，get profile配置。

首先我需要声明帕斯维尔堡注解，然后把 uzid得到从路径里解析出来。另外为了给页面的携带参数，我需要把 model加上去。好，下面我们首先把你要访问的用户查出来，这个简单了放 Id，优质ID为了避免有人恶意攻击，他特意传一个错的数据进来，然后反复去查攻击你，我们判断一下你 uxi定的是否存在，就 uz是否存在，那么如果不存在的话，我就抛异常了，那么该用户不存在。

好，那么如果没有报异常用户存在，那我就查询相关的数据。刚才我们PPT上也看到了，页面上要显示的是用户相关的基本信息，所以我要把用户的基本信息发给页面，很简单的猫都有点爱的爱去表达，然后优的把我们得到的一个结果传给一面。另外我们再去查一下这个点赞的用户的获赞的数量，那就得掉。 Like service我需要把 service注入进来，还没有去处理。

好，那么有了这个service再回到刚才的方法里，我就like service，find user like com，你把 user的ID传给他，那么他就得到了这个数量，那么把这个写清楚一点叫like count，因为将来我们这个方法还得重构，还要处理关注数量等等对吧？做一个区分。我需要把这个数量都发给页面给猫都有点at like count。

好了，到这我们页面上目前所能够得到的数据就这些了，我就直接返回模板，指定模板site，然后那个页面名字叫professor点htma Professor，好，这个处理完以后，接下来我们就处理这个模板，首先我们打开首页，在首页上加上用户的访问路径，然后再去处理这个页面，先访问首页上有多个地方可以要处理，第一个是头部不有一个当前用户的个人主页的路径，这个地方你得改，这个地方要以当前用户把他的ID传进去。

好所以这里我写th冒号，那么整个路径是 user profile后面要带上一个变量，所以说为了拼变量，我前后需要加一个竖线，好，这个地方变量要写的是当前登录用户的ID，当天登录用户是谁？是login user对吧？老给你悠着点的地方了。

除此以外，那么在帖子列表里，每一个用户的头像，它外面都有一个超链接，这链接应该链到用户的主页上去，所以这个链接也得改，那么也得拼一个变量，所以我先把书先写好路径还是user profile，然后跟着一个ID，这个ID应该是帖子的发布人的 Id，帖子的发布人就应该是你看 map点优点对吧？

Map点优点，点ID，当然除了首页的这些位置以外，详情页对吧？然后私信那些地方都有头像，都应该加上这个链接，我不挨个去改了。因为这个没有什么难度，大家可以自己把它完善一下。我把这两个地方改完以后，能够能够做测试就可以了，能够演示这个效果就可以了。

好了，既然能亮过去了，最后我们就来处理了。这个是主页 Profile，profile html这个页面是我们第一次编辑，所以说稍微麻烦一点，你需要把这些基本的东西都写好。好先声明 timeless模板，然后这个地方要做处理，Heider要做处理，然后最后的 GSI要处理。好，这些细小的基本的细节都处理完以后，最后我们再来显示正文的数据，就在这了。

正文的数据这里边你像这个选项这三个可点的地方我们先不管，因为目前我的帖子我的回复咱们都还没实现，就不切换了，以后再说，然后这是个人信息的显示的位置，这个地方数据我们要加以显示。

首先这里要显示的是用户的头像你这里得改，我们传过来的是优的对吧？优这个点， high的URL头像。

好，然后 span这个地方是用户名，那就是悠着点悠着关注他，我们现在还没做，不管用户的注册的时间需要处理一下，格式化一下，然后是悠着点create time给一个格式。

好，这是用户的注册时间，后面的话显示的是他关注了多少人，他的关注者是多少，我们还没有处理，还没做先不管。然后是用户获得了多少个赞，这是我们要重点显示的内容，赞的数量传过来的就叫like count。

好，那么这个页面它显示的数据比较少，到这就可以了。好，那么这个功能我们就代码写完了，我们做一个测试，我把这个项目启动一下。

好，启动完以后这样，因为我们重构了点赞功能，所以说之前的点赞数据和我们当前的要展示的数据不一致了，我这样我把之前的数据给删了，咱们重来重做一个测试，不然有点乱，你看这里都是一些点赞的数据，之前的我把它删了这个好什么都没有了，然后我们访问一下，我需要做一个登录，我用CC登录。

好，那么登录以后，比如说我查看 Aaa的帖子，看 AA的帖子，然后我给帖子点个赞了，然后当然我取消一下也没问题是吧？再赞一下，然后再给评论点个赞取消。可以的。没错，然后我想看一下 Aaa目前他有收到过多少个赞，但你注意其实现在他应该收到一个赞，因为这个帖子是赞给他的，而这个评论我是赞给BBB BBB的李，红鹤的BBB的对吧？赞给别人的不是AA好，我这样我回首页，我点头像看AAA的主页获得一个赞。

好我希望再多一点，我这样我去这个帖子里有AAA的评论，我给评论加个赞，还有他的评论再加个赞，此时 AAA应该拥有三个站，看一下三个站。没错，主页的头像名字也对。好当然我也可以看我当前登录用户我自己的主页，我点个人主页，这头像名字也对，占的目前是0。好，你看我们经过这样的一个改造和简单的这么追加了一个页面，统计我收到的赞的功能就实现了，我们这次课就演示到这里，咱们下次课再见。