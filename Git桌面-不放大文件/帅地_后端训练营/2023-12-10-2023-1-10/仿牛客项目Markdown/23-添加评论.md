23-添加评论.mp4

这次课我们来实现添加评论的功能，这个功能也不复杂，然后我们还是按照这个数据层，然后业务层表现层顺序来开发就可以了。然后值得注意的是我们在处理增加评论的业务的时候，这里边需要用到咱们之前所学的事务管理的内容，因为我们增加评论以后，要连带着把帖子那张表里的评论数量加以修改，更新一下数量，所以说在这一个业务方法里需要执行两次dml操作，那么我们要保证业务的完整性，所以说要对这个业务方法进行一个事务管理好了，咱们就一步一步来开发。

首先我们来写这个数据层，我们在数据层首先先把增加评论的方法写好，另外我们把修改帖子评论数量的方法也给它写出来就可以了。

好，那么我打开这个idea，然后我们先找到 comment map，然后我在接口当中在新增一个方法是增加评论的方法，那么它返回的是整数行数，然后方法名我叫insert comment，那么需要你传入实体类 Comment，说明完以后我们打开它对应的配置文件，然后把 circle实现就可以了，配置文件我搜一下 comment，map、xml，这样我还是在一开头把新增的字段把它列出来，在这说明。

当然新增的字段和查询的字段其实就差一个主键，稍微改一下就可以了。

Insert feels，然后把 ID去掉，好，然后我们就写一个insert语句，把刚才那个方法也实现了，insert，然后ID call一下insert comment，然后新增的时候我们需要声明参数的类型，它是一个实体类型， parameter type等于comment。好，然后这里边我们把 insert语句写好， insert into hormone。那么对应的字段我们依赖刚才的 circle就好了， include refid等于它有栅栏问题，整错弄错地方了。

我再拷贝一下，好。粘过来，然后再万64里面我们写上注入的各个参数，第一个是优质ID，然后下一个是安贴一贴态度然后是inttid然后是target，ID，那么大家在写字段也好，还是参数的时候一定要注意大小写，然后是康婷婷再来CD以及克瑞特太好了，那么这个语句就写完了，写完以后就刚才说了还差一步，就是数据访问层，差的是我们还需要更新的帖子的评论的数量。

所以我们打开 discuss post map给它增加一个新的方法。We can soldier discuss post labour。好，那么其实我之前在介绍帖子表的时候就说过这个事，咱们再回顾一下，我们看一下这个帖子，这张表，这张表后面不是有一个comment，com字段对吧？那么这个字段它是冗余的，把这个帖子的数量除了一下，然后的话为了查询时方便，不然的话你每次看帖子，那么这个数量都要从评论表里再查一遍，有点慢。

所以这样容易存在是为了查询是速度快，所以这个数量什么时候更新，就是你增加，评论以后就要更新它好。

因此我在 map接口里加一个能够更新数量的方法，这个方法反馈整数就是你更新的行数，方法名我叫update。Comment com就评论数量，当然你更新的条件你是根据ID来更新的，通常都是这样，就叫ID帖子ID然后更新的是评论数量，这个写的清楚一点，comment。

好，然后我们需要打开接口所对应的配置文件，然后把这个方法实现掉，也是搜一下，这个是discus post map。好，那么我在最后这个位置把这个地方实现一下，放好没有先复制好。Update。然后 ID等于它因为参数是普通的数据类型，你可以不用去声明，返回值肯定就是整数，也不用声明。那么这个语句很简单了，就是update这张表，然后 Site comment，count字段等于我们指定的参数，comment，count，然后需要有一个条件是ID等于参数ID。

好，到这儿我们数据访问层就完成了，完成以后我们根据数据访问层来实现业务层的逻辑，我们就找到对应的业务组件，这样我首先在帖子的业务组件里加一个更新的方法，就更新数量，然后我们在开发评论的时候可以依赖于这个业务组件，那么这个业务组件它不只是可以依赖于它对应的 map，也可以依赖于其他的service，所以我打开 post map然后加一个方法，他们来it update，comment，count。

参数，一个是ID，一个是comment，count。

那么这个时间就非常简单，就一句话，这里边也不需要什么额外的处理，我就直接返回discus post map点update comment com就可以了，但是你要把对应的参数传进去好了， service写完以后，接下来我们就可以开发我们这个功能的重点了，但是你看这写完以后，他这画了个波浪线报错，在我刚才编辑代码的过程中，可能代码没写完的时候，他报了错，写完以后他没有切换过来，我试着按一下CTRL f9，然后重编一下试试。

如果还不行这还不行，你可以这样，你可以把整个代码推出a把它全剪切掉，然后再可能再把它恢复一下，这样有的时候就好了。

总之工具它有的时候偶尔也会有一些小的问题，但这个问题没有太大的影响，那么稍微处理一下就可以了。

好。接下来我就打开这个 comment service，然后我要在这里处理增加评论的业务，这是我们这次课的核心了重点了。那么增加业务方法，我返回的是整数和行数方法名，我叫爱的comment，参数就是实体 comment。

好，暂且不管返回值，那么这个方法因为里边包含两次dml操作，所以我希望对它进行事务管理，让它保证这两次操作在一个事物范围之内，要么全成功，要么都失败。

那么做事务管理咱们之前讲过，我们通过spring进行事务管理，有两种方式，一种是声明式事务，只要做配置就可以，一种是编程式事务，我们当前的整个方法是在一个事物范围之内，并不是局部，所以我们用这个声明是事物加个注脚就搞定了。

所以我在方法之前加上纯Jack的注解，然后通常我们都要声明它的隔离级别 Isolation等于引用一个常量isolation点，我这里就选用瑞的 committed这个级别。

另外还要声明同时还要声明传播的机制， provocation等于provocation点为care的。

那么如果你在这你把隔离级别传播机制它所代表的含义你忘了你就回过头，然后我们前一次课去回顾一下，好，然后我们就来实现这套业务，这套业务的实现非常简单，首先我要增加评论，那么对于页面传入的实体，我们有必要把内容进行一个过滤，包括 html标签的过滤，还包括敏感词的过滤，因为它里边可能包含一些特殊的内容，如果不处理的话可能就会有问题了。

好，既然要使用敏感词规律，我需要把敏感词规律的组件注入进来。三CT优点把它注入进来，那么这样我首先先对先把这个参数判断一下，万一这个参数是空的怎么办对不对？保证严谨一点，如果参数是空的我就抛异常，给个提示说参数不能为空。

好，那么如果参数不为空，我要对评论中的内容进行一个过滤，那就comment的site，content把过滤后的内容传进来，首先我要过滤的是标签，那么利用这个工具 Htmlutos点htmlsk然后传入的是过滤之前的内容。

好，同样的我们再过滤一下敏感词了，site content，然后是三c听field点filter。 Comment点get content。

好，那么内容过滤完以后，这回我才能够放心的把它存到库里，我就调用康的麦克的音色的方法对它进行一个插入的操作，但是最终我会返回， rose插入的行数其实成功的就一行，然后在我们增加完评论的时候这写个注释，这是添加评论，添加完评论以后我们还需要做的另外一件事就是更新评论数量，但是你注意我们的评论它的针对的目标不一样，我可以评论给帖子，可以评论给评论，可以评论给其他的内容，而只有评论给帖子的时候，对吧，你才要更新帖子的评论数量，所以这里要做个判断，我们这里写的详细一点，更新的是帖子的评论数量。

好这个判断，那么如果 Comment点get Entity它等于其实它等于一的时候，那么等于一的话，我忘记了我之前有没有常量，看一下 community constant，我们上节课写的常量其实就是等于它了，对吧？

为了引用它方便，我也把刚才的 service实现这个接口，那么如果这个类型是帖子，我们就更新帖子数量，更新帖子数量，首先你要查到这个数量，我们可以调康尼迈克，查到最新的数量，它里边不是带了一个方法叫select count by anti的对吧？

首先我们需要传入的是类型anti tap。你就可以传纸，comment点get under tap其实就是它了，就是帖子，然后另外还要传一个 Inttid那就是comment点gitinttid这个对象里都有。

好，那么利用这两个参数我们能查到实体它对应的评论的数量对吧？Count。好，然后查到数量以后，我要把它更新到帖子表里，我这里需要把迪斯卡斯pose的map注入， service注入进来调用它。

好注入进来，然后回到刚才的位置，我调用discourse的service，然后我们刚刚写的update和我们的课程方法，那么它是根据帖子ID，帖子ID是谁？他因为当前类型是帖子对吧？所以这个ID就是帖子ID，就它根据帖子ID把数量更新了，更新为最新的值，这就可以了。好，那么这个业务方法我们就实现完了也不复杂。业务层实现完以后，最后处理表现层的话，首先你要在CTRL那里处理了浏览器的请求对吧？

其次你肯定是要对这个页面做出一些改进，我们首先处理CTRL Ctrl的请求，那么这个功能我们可以单独创建一个CTRL，然后我就在包下新建一个controller controller我叫comment controller，然后给它加上注解。另外我声明一下， Curto了他的访问路径， comment。好，另外我在这里要加上一个方法来处理增加的请求，那么我希望请求的路径是这样的，这里我放大一点，然后声明请求的路径是叫爱的添加对不对？然后还要注意这个还不行，咱们看一下静态页面，比如说我进入到一个帖子，然后我要给帖子添加评论，当我点回帖评论完以后，那么我们应该去哪？

其实还应该回到就帖子详情页面，你回到这个页面以后能够看到这个帖子不是更好吗对不对？

而不是去别的地方，你能够回到这个页面，这是帖子详情页面，那么我们帖子详情页面的路径，咱们真实的路径当中是有一集是带上了帖子的ID的，所以我们最终要澄清像的地方需要用到帖子ID，因此为了能够得到这个帖子ID，我也希望咱们这个添加的路径里，你把帖在地给我传过来，就这次请求说完了，你要把帖子在地传过来，我希望你通过路径把它传过来，我好后面好用。

好，所以我在这里定义一个参数，帖子ID， discus，post ID，另外再声明一下请求方式 request，这是一个增加提交的数据就是post，然后返回死卷，方法名我叫爱的 comment。好，首先这个方法之内需要得到这个参数对吧？你需要用到 pass variable注解，得到参数。好，另外因为我们本次请求是提交数据进来，提交的是什么？提交的是评论相关的数据对吧？他不提交页面上会提交什么？页面上其实主要就是提交内容。

除此以外还要提交另外两个隐含的东西，一个是你评论给哪种类型，哪个ID就实体类型实体ID这个学校也还传过来的，所以页面上需要传输多个条件进来，我就声明一个实体来接收这些数据，这样比较方便。

然后实体中接收的是三个值，可能还不完整，我们再补充一下就可以了。

好，然后我们在实现这个方法的时候，你注意那肯定是要用到我们刚才所写的 Service对吧？我把这个service要注进来，好我把service注入进来，然后我们在给 comment补充数据的时候，你要补充uzid你要补充状态，你要补充创建时间，悠哉ID从哪来增加？

一个评论肯定是当前的用户增加的对吧？你应该得到当前的用户的ID，所以我为了得到当前用户ID，我把 House的后者给它注入进来，好了，这样就行了，我们接着就来实现这个逻辑。

刚才说了 comment，它三只传三个条件进来，我需要补充一下，那就是comment点sat又在ID，我从house头这里获取，当然有可能用户没登录，没登录你这样写就会报错，因为你get user是空的，但是没有关系。

我后面会做统一的处理，就是说我后面会做统一的异常的处理，所以说像这种问题也问题不大，不只是异常的处理，我们后面还会做这个统一的就是权限的认证，如果你没登录你就访问不了它，所以通过这种方式也可以规避好赛特优质ID，然后 comment再来再site， standards，状态默认给它来个0，表示的是有效的，然后 comment点，site，create time。

那就是当前时间 new date。

好，补充完了这些内容以后，我就可以添加了就调 service点爱的comment，把它添加进去就可以了。然后最终刚才我也说了，我们需要跳回到详情页面对吧？那就重定向 read write，然后从镜像到帖子详情页面，它的路径是这样，diss Cass detail，然后后面还要加上贴在ID贴在d这里有。

好那么CTRL咱们就写完了，那么最后一步就是处理这个模板了，模板其实帖子详情页面模板，因为我们是在详情页面上去做评论的，这样我搜一下详情页面，它叫diss Cass，detail，听见没有？

好，然后详情页面上其实有三个地方可以进行评论，一个是最底下大框中做的评论是针对这个帖子的，我们先把它搞定，他在比较靠后的位置往后长，在这在福特之前，然后分页之后，在这，然后这里面有一个表单，我们要提交表单，所以你需要对表单加以声明，提交方式为post，然后你要指定提交的路径， x这里为什么x前加这个th，因为我们这个路径增加，帖子路径当中包含一个动态的参数对吧？

所以我需要拼一下，我加个双输线，一个固定的值拼成一个变量，它的路径是comment，I的后面带上的是帖子的ID，我当前页面获取帖子ID怎么取呢？上前面找找，因为当前是帖子详情页对吧？我们这里可以很容易获取到帖子的数据，你看这POS的点什么？ Pose就是铁的对象对吧？好这就好办了。

回到刚才的地方，这儿我要获取帖子ID就是 post点ID，好路径写完以后，那么接下来我们在处理这个框，这是一个文本域比较大的框，你要给它取个名字加上name，name等于我们要和 comment实体当中的属性相对应对吧？我们要把传给内容的字段，所以说你看name等于 content。

除此以外我们还需要传入两个隐含的条件，就是你评论给谁给哪个实体，而实体包含类型和ID，这两个我们需要隐含传，你传隐含的数据可以用，就是隐藏框 Type等于黑的，框的作用其实和文本框一样，就是他看不见，然后 name等于先传int cat，那么隐藏框的质量需要你通过挖掘指定，这个类型是回复给帖子的固定就是伊朗。

好再来一个，我们还要隐藏着传安推ID，这个ID就是个变量，你这里就得加th，贴成冒号，后面需要写一个变量，帖子ID帖子ID不就是它对吧？好了，给帖子进行评论，这个表单我们就处理好了。

再往上看，是前面的还有两种类型的框，咱们就看这一种类型是给一个评论，进行评论，但是他没有指向某一个人，再一个是你点这个回复，他又弹出一个框，这个框是给评论，评论，但是评论是指向某一个人的，他俩的区别其实就是差在这个人上，我们先处理。

没有这个人的往前找，这个是他然后我们静态页面上在实现的时候，他没有给我们写成表单，我们只能自己补充了，所以我在这儿补充放，我们这里最后有个缩进好看一点， form master的也得等于post，然后他提交的路径其实和刚才一样，我可以copy，这样不容易错。

Common的艾特，然后 pose点ID没问题。好，另外这个表达里有一个框，这里是输入内容的，你需要给它加一个内容，而这个内容也等于空调。

好，除此以外，当然这个表单里也需要另外的两个隐含的数据，所以你也需要两个黑的，我把它掏过来，把它放到后面放到这儿，一个是itt type，这个是回复给评论的，所以 Type是二，然后 ID就应该是评论的ID就不是帖子ID了，这里评论ID怎么取呢？咱们看一看我当前 li他在哪儿？他是在 u他是在 ul之下的，在 ul之下的。

然后那么在 ul li里，我们获取评论的，获取评论是通过cvo来获取。好，回到刚才的位置，就是这个地方你应该写成cvo然后点这是一个卖法，.comment，获取到 comment对象，然后点ID这就行了。

然后最后要注意这个回复按钮，它默认给的是一个button，不是一个submit，所以你要把它改成submit，提交按钮好了，那么给评论做一个普通的评论，我们也搞定了，剩下的还是最后一个表单回复给固定的某个人，好，我们再往前找，其实就是在这儿，你看他回复给谁谁谁就在这儿，当然他这里也忘了写form，我自己补充一下，然后缩进一下 form，上面的配置和刚才的一样，这个没有什么变化，然后里边的框它的name也是 name等于content。

这个button啥都没谈，当然他也需要另外的几个黑灯对吧？

我把这两个黑灯拷过来，好拷过来，当前他回复的也是评论的也是评论，所以y6是2，没有问题，然后评论的那个题评论的是评论评论的ID是多少也是这个值，没有问题，然后这个时候他需要就指向某个人，所以说你这个时候要给后端传一个什么传，你看一下这个表传。

他get ID目标的ID，用户目标用户的ID，所以你还要再加一个黑灯，然后把这个目标用户的ID写进来， type等于黑的，然后 name等于他改的ID，然后他的value应该是个变量，等于好，这里面我们应该回复的目标是谁？

回复的目标应该是当前评论的作者，那么当前这个评论他是谁呢？它其实是 rvo你看当前 li它是rvo它是个回复它的作者。

好，所以这里面我应该这样写， rvo点它的作者是 user，然后点 ID，好，然后最后再稍微注意一下，就这个地方这个文本框它有一个place holder就是一个提示，提示你回复给某某某，这里面他写死了，回复给寒江雪应该是回复给一个变量对吧？

所以这块我们还得拼一下比较好， th冒号，然后的话这里边要拼的话，我就加上这个竖线，然后寒江雪把它去掉，我们要把它换成一个变量，换成那就是换成的是回复给刚才评论的作者其实就是lvo点user，但是你这里要显示的是悠着点悠着内容。好了，到这儿我们这三个表单就配好了，配好以后咱们去测试一下，看看能不能正常的评论，下面我把这个服务启动一下，好。

启动完以后我打开浏览器，然后先访问一下首页，然后没有问题，我需要登录一下登录，我用这个CC登录，登录以后，比如说我要回复这个帖子，就回复换一个比如回复，回复我在这就随便写一个，你好好回帖，回帖完以后没报错，然后跳回了这个页面，然后你看回帖刚才应该是16变成了17，表示ok，但是你回复的帖子它因为它它楼层比较靠后，我们是一楼在前，所以它在后面你需要到最后一天才能看得到，你好，没有问题。

好，这样我再做一个回复一个，另外就是给给评论做一个回复，那么这里有写hello， hello，你看这个hello就有了，好，那么屏障以后我可以切换一个账号，我利用这个牛客这个账号去看一下，看一下以他的角度来看这个数据会是什么样，我退出一下。

然后患者好牛客，他的密码我猜一下是123我有点忘了，nvv7，对了，然后看一下这个事物，这样的没问题对吧？

这样我回到首页，他不是对我这个评论给我做了一个回复，我回复给这个人看一下，我回复给他，我不在这回复就回复给他，说8月回复，回复完以后你会看这是牛客回复给CC，how are you？

好，所以我们分别在这个地方，然后在这个地方以及这个地方做回复，它所表现的形式都是ok的，比如说我们评论就成功了。好了，那么这个功能我们就开发完了，咱们这节课就演示到这里，我们下节课再见。