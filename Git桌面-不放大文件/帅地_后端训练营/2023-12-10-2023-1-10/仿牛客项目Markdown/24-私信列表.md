24-私信列表.mp4

这次课咱们来开发私信列表的功能，那么我们在开发功能的时候，也并不需要用到什么新的技术点了，但是这个功能还是它的业务还是比较值得我们去探讨去琢磨的。

那么首先我先来说一下业务，私信就是我们黑的部分不是有一个消息的一个链接，然后你点进去以后就能看到这样一个界面，这里我就不给大家看静态页面了，因为静态页面上它的数据是静态的，这里边都是一样的数据反而容易误导你，让你在理解业务的时候有偏差，我这里是一个做好的功能截取的数据，这个可能就更准确一点。

首先我们我们说的私心列表指的是朋友私信这个列表，并不是指的是系统通知，那系统通知我们以后再说，然后我们在开发这个功能的时候，首先我们要开发这个列表，这个列表是显示多条会话，这里面首先你要理解什么是会话，比如说我和CC之间往来有很多次通信，那么我和他之间的通信，所有的通信加起来就叫绘画，所以绘画是针对人的，我和CC的对话叫绘画，我和BBB的对话叫绘画，我和lhh的对话叫绘画，所以这里列举的是我和某一个人某一些人的对话信息。

因此我和 CC对过话，这里就出现CC，我和BB对过话，这里就出现BB以此类推。

然后我和CC的会话它里面其实包含了往来的多条消息，所以你点进去以后能够看到多条消息，所以我们这里也不只是要开发私信列表，私信列表其实指的是一个会话列表，是以人为维度的，然后我们点到某一个会话里能够看到私信详情，而私信详情是你和这个人之间详细的对话，所以说大家首先要理解绘画和就是详情的一个关系，我们会话列表上是显示了我和某人之间的对话，然后的话这里面显示的消息显示哪个消息显示的是我和他之间最新的一条对话就最后的一条对话显示在这里，是这么处理的。

当然了我们在显示的时候可能还要显示我总的未读消息数量在这。那我和CC的对话当中有几条未读在这儿和他有几条未读在这儿，要未读消息要显示出来。

再一个这个消息里还要显示，比如说会话包含几条往来的具体的消息，这里就共几条，它这里其实这个提示不是特别准确，他说共9条规划，其实这就是说这个规划共包含9条消息，就再概括一下我们所开发的私信列表，它所展现的是我和某些人之间的绘画，我和任何一个人之间多次对话为一个会话，所以说这里边你能看到的应该是不同的人，一定是不同的人。

针对某一个会话我点进去才能够看到我和这个人更详细的私信详细的对话。好了，那么像这样的一个功能，我们这个表怎么设计的，我们值得去看一下。咱们先看一下这个表的设计，你看我已经把这个表打开了，这个表叫message，然后首先是ID不用说了，然后是from ID，就是消息的发送，人的ID。To，ID消息的接收者ID。这个很好理解，用户的两个ID谁发给谁，然后先看这个内容。不说了，状态状态零表示未读，表示已读二表示删除，然后这是创建时间。

然后这里边还有一个字段叫conversation idea就是会话的idea，用来标识会话的，因为我们要查询会话列表，其实当然你没有这个字段，我们就是利用 from ID加to ID组合在一起也可以查到，但是不方便，那么有了这个字段以后会方便，我这里给大家说一下这个字段是怎么一个设计。

比如说我有一个用户，他的ID是111，还有一个用户他的ID是112，比如说111和112他们之间的会话，我就会话的ID，我就用就将这两个ID拼起来，中间以横线连接，但连的时候你注意，那有可能这个消息是111发给112的，也有可能是112发给111的，我这个ID如果说我就是直接按照自然的方式来拼的话，可能会出现两种情况，一种就是这样的，按照这个顺序，而这个是但其实你看无论是这种情况还是这种情况，都是111和112两个人之间的对话，其实都是他是一个会话，这两个人之间无论谁发给谁，它都是一个绘画，但如果你是这么拼的话，分两种情况来拼给人，感觉这是两个绘画，我希望无论是这种情况还是这种情况，那么我们批完以后批完会话ID以后是一样的，所以我们有一个规则，就是我们把小的ID拼到前面去，而大的ID拼到后面去，这样的话无论是这种情况还是这种情况，最终的拼的都是这样的。

所以说我们设计会话idea的目的其实是为了将来我们在查询绘画有关的数据的时候，我们以绘画为条件进行一个查询，筛选的时候，方便大家要注意好了，当然了这个数据其实还是冗余的，那么这个数据完全可以从from ID和to ID推演出来，等有了它以后，我们在查询时效率会好一点。

好了这个表说完以后，下面我们就来开始开发了。开发的时候这样，刚才我这个PPT上也写了，我们一共是两个功能，我们这次课都把它搞定，一个是查询信息列表，会话列表，一个是私信，详情就是点进去看到详细的往来的私信。

我们在开发的时候，我在开发数据访问层时，我把这两个功能需要的方法都一起给它写完，咱们一起做一个测试，然后业务方法我们也把它一起写完。

我们在开发视图的时候，我们就分开来开发，我们先把这个列表相关的开发完，测试过，我们再开发详情这样去处理一下。

好，我就打开这个idea下面我就要开始写代码，首先我需要给这个表写一个实体类对吧？我在安贴包下新建一个类叫message，好，然后根据刚才表的结构，我增加了如下的属性，第一个是ID，然后是from ID，然后是to ID，然后是会话ID，这是一个字符串，因为中间配了横线，它不可能是数字叫conversation ID，然后是content，内容。

好，再来是状态，最后还有创建的时间。那么写完这些属性以后，我生成对应的get和set，另外我再生成一个to spin方法，好了，那么实体类就写好了。

下面我来写 Map，把数据访问层的逻辑一次性的都写完，我抄你一个接口，这个接口我叫mic，迈克这里我放大一点，然后加上麦克注解，这里边其实我一共需要定义好几个方法，一共是1234、五。

对，应该是5个方法，咱们对着页面看也容易看得出来，看看页面点消息，因为这是1个列表，而且是知识分页，所以你要提供一个查询这一页数据的方法，你要提供一个查询总行数的方法对不对？这是两个。

然后你点内容进去以后，看详情它也是个列表，对吧？所以说你也需要提供2个方法，那就4个除此以外你还要查未读消息数量，而未读消息数量有两种，一种是针对某个人某个会话的未读消息数量，还有一个是针对所有会话的未读消息数量，就针对某个人的针对我当前这个人的未读消息数量，但这2个其实可以合成1个来做，所以加起来一共是5个方法。

好了，我把这5个方法就是给大家理一理，然后把在这里做1个声明。首先第一个我要做的事情是查询当前用户的会话。没错了，会话列表查询的是会话列表，而每个会话列表里边就每个会话我们显示什么呢？我们显示的其实就是一个消息，但是这一个会话包含多个消息，我们显示哪一个针对每个会话只返回就是一条最新的私信，每个会话只有一个私信，最新的就可以了。

好，所以我最终返回的是一个集合多条数据，集合中的封装的是私信 Message，那么这个方法名我取名叫select conversations，因为他查的其实不是私信他，查的是针对绘画玫瑰画最新的事情，所以我取名跟逻辑相匹配。

我查的是某个用户的规划，所以你这个筛选团队可能是要有用户的优质ID，然后为了支持分页，你要加上奥赛的加上这个里面好，这是第一个方法的声明，好。

再来第二个，第二个就方便了查询当前用户的会话数量，说白了就是你把前一个方法以这个条件查询，最多能查到多少条数据得到，好，我们查询得到的是一个整数，那方法名我叫 select commission，count。参数user，ID。好，再来，接下来我们需要做这样一件事，查询某个绘画所包含的私信列表，就是在开发详情页面时需要用到这个方法。

好了，所以我得到的是一个集合中的封装的是和这个人多条私信麦穗，然后方法名我叫select letters， letter是私信的意思，然后我们这个查询是根据什么条件来查？是根据会话来查的，你和某一个人的会话来查的，而会话的条件是康复是一声ID是吧？

所以我们以他们是一些ID为条件做查询，然后支持分页加上outset limit。好了，再往后与这个方法匹配的还得有一个查询数量的方法对吧？我需要查询某个绘画所包含的私信数量，返回的是整数，那么方法名我叫select。Lighter count参数还是康复c是ID的太长了，我copy一下。好了，那么有了这4个方法以外，我们再查一下未读的消息数量，查询未读私信的数量。好，那么 select letter。Unread。未读 Count。那么你查的话肯定是查当前的用户的未读数量，所以你可能优质ID是要带上，你不能查别人的，然后你如果是只以它为条件的话，你会查到用户所有的未读数量，对吧？

但是我们还有这种情况，这个地方是查用户所有的未读数量，而这个地方是查他某一个会话的未读数量，是这个人某一个会话的维度数量，所以说我们再加一个条件，就是会话ID，然后你注意会话ID我们把它作为一个动态的条件去拼，而不是一定会有你传了我就拼上去，你不传我就不拼，这样的话这个方法能够实现两种业务。

那么这5个方法我就声明完了，声明完以后我们需要对它进行1个实现，我需要写配置文件，那么我在 map之下新建一个配置文件，随便找个文件拷贝一下，然后粘贴进行修改message map。好，那么改完以后我把它的内容删了，一会重新写，这里面需要改一下 map的名字。好了，目前我们所实现的都是查询的逻辑，所以这里边我首先把要查询的字段进行一个统一的定义，后面好复印 circle，ID等于select fields。

然后把所有的查询的字段都列在这儿。 Id十万。Id to ID康，谢谢ID。框天。内容 Students以及 create time。好了，那么首先我们要实现第一个方法，就是它这个方法实现的时候稍微有点绕，不过也并不是很难。我给大家解释一下，我先把这个结构写好， See like ID等于它，然后返回的类型是 message。好，那么 circle怎么写？这样我到这个工具里写一写给大家看一下，首先我们说我要查的是会话，然后其实每个会话就是要查我和某个人的最后一个这个对话，所以说其实我和某个人有多少次对话，那么就应该产生多少条数据，是这样的。

好，首先我们来看一下这个表里我先做个筛选，我们先看一下这个表里的数据都有什么，谁来？行吧，12。卖水的，然后外是这点你要先加上不等于2，因为等于2就是删除了，我们不要二。好，我们看一下有效的数据是多少，然后再来and还要加一个from，ID不等于一，等于一代表什么意思？你看后面它有特殊的数据，等于一一代表是系统用户，那么系统用户他给你发的消息这就是通知，这就不是私信了，所以你要把这种通知的数据排除掉，剩下才是私信。

好，我们看一下这数据有多少，其实并不是很多。

好，这里边你看12它之间有反复的有多次这种会话，我们去重以后有多少个，其实我们需要统计去重以后多少，就说白了康复c是ID，去虫以后有多少个，在这种情况下，那就是有多少条数据了。

你可以这样你可以去查一下diss shift，然后 Com c是ID，我查一下看看一共就这么多数据，这是多少个数一下？

一个23456789 10、11 12 13 14，好像是14个，一共是14个，或者你可以这样count一下。

14个，所以说我们查到的结果应该是14个好了，但是我们怎么去写这个circle，因为我不只是说只要康c是ID，我要的是每次绘画我要的是最后最新的一套数据，一条完整的数据，我怎么得到每个绘画最新的一套数据，一数据它肯定是ID最大或者是时间最后对吧？

所以你可以这样，你可以我这先这么写谁来？ Max ID我查最大的ID，当然你查最大的ID的ID，你得利用会话进行分组，对吧？你要不入办一下格若克拜，他说这是ID，然后你查就会得到14个 ID，它是每一个规划最后一条数据，我们利用作为子查询，然后去对ID进行过滤，最后得到的数据就是我们想要的了，所以你这个时候理解了，其他就好办。

好，我把这段视频都拷一下，粘贴在这儿，但是我需要再稍微修饰一下。Select max ID from where它等于不等于2？它不等于1，然后不是会败注意，这里边我们还需要加上筛选条件，条件是优质ID对吧？一直加上去，这还没加，然后我这样加 and注意优质ID可能你当前用户可能出现在哪，你可能是发信的人也可能是收信人，所以你就在ID可能等于他或者是他对吧？

你要写一个或者的关系，这地方比较绕， from ID等于user ID或者这个to ID等于user ID。

好，这样的话这段这段代码才算是完整完成完成以后，那么我指的得了ID还不行，我以它为子查询，然后对外层查询做条件筛选，我就可以得到完整的数据外层，我这样写select，然后 include他不让卖c喂ID印对吧？这段话就起到了对于 Id的筛选就可以了。

好，最后我需要在查询，结果里我要奥特曼一下奥特曼ID倒序，好，然后在支持分页就limit offset，然后 limit。好，那么第一个方法就写完了。第二个是查询数量其实也是可以和类似的，只不过它不要分页而已，我再把第二个方法也写一下。Id等于它然后第二个是它数量，它的返回的类型就是整数。

第二个我也需要以这样的类似的这样一个条件去筛选，对吧？我把它拷过来，然后当然也是以它为子查询了，我这样写外层查询，谁来看？

看着我看着谁，我一会内政大学我就要取个别名，这个别名，然后内政大学我给它取一个就子查询我取一个名字叫m吧，m点max ID服装子查询，把刚才代码贴过来缩进一下，当然这个地方给它取个别名，要不不好引用 as max ID啊，然后整个子查询为了好引用加个m所以我是从子查询里统计最大ID的数量，也就是绘画的数量有它以后就容易了。

好，再来其他两个就简单了，就比简单多了，好。

再来select ID等于他，然后返回的类型还是message。我这个就不用嵌套了， Select include他有这样的你搞错了，他然后让message，我这个方法是查询某一个会话之下包含的消息数量，所以你应该把会话条件拼进来，还要支持分页，当然也应该加上这样的条件，就是不等于二，不等于一，这个是要加上去的。我就写了where standards不等于2and12，ID不等于1，按的conversation ID等于conversation ID，然后 Out there by ID desc然后还得分页里面的outside里面的。

好了，那么查询就完成了。下一个也很简单，查数量，当然它的返回的类型要声明一下是整数。好，那么查数量就count一下就可以了。 Select count。Id from message。条件的和刚才的上一个circle是类似的，它不等于二，它不等于一，然后它是ccid等于它，所以我直接粘过来，这就完了。

最后还有一个查询未读的私信的数量，它的条件是又在ID和com CS ID，而后一个条件是动态拼的，不是不一定有的。好，最后再把它也实现一下，ID等于它然后返回的也是整数， select can't。Id。不让message然后 where是未读的消息数量未读，那么就是状态你得等于零才表示未读。当然另外弗朗麦蒂依然要在这来， From ID依然要不等于一，这也加上去。

然后你注意未读是我当前用户的，未读那一定是别人发消息给我的，所以说你就在ID拼进来，应该拼到哪上去，应该拼到to ID上去，一定是别人发给我， to，我的对吧？是这样的，所以你要按的 to ID等于参数又在ID，这个条件一定要有，然后 come see是ID，如果有我们就拼，如果没有就算了，所以要用if来拼。

If test等于 com c是ID，如果它不等于空，不等于我就把这个条件拼上去，就按的他说ID等于他。

好了，到这儿我终于把这些个方法实现完了，我们这次实现写的方法比较多，再一个有些方法还比较啰嗦，有点绕，所以说对不对？不好说，最好我们要测一下。

接下来我就写一个测试测试代码测一下，这样我就在 map test这里测，我就不新建类了，那么我把新的map注进来，好，我重新写一个方法，我就一个方法把所有的刚才的那几个方法都撤了，就不写那么多了， test select。

Let us咱们逐个去测，首先我要调用message，map点儿，说第一个select conversations。好，我要查谁，我要查看一下。这样我重写一下谁来。行不让 message然后把这两条加上去。我查111这个人的信息，因为111这个人的消息比较多，是吧？它比较多，所以我传的 Uzid是111，然后分页我查第一页，比如10条，那就01010个绘画。好，然后这样我大点20咱不是说了一共14条数据对吧？我这样写的话，直接把这14条数据都看到比较好，然后我就 list message等于它那么查到数据以后，我把它遍历一下，然后打印出来看看。

好，每次输出我打印这个message，好，我先执行一下，先不写别的了，先执行一下。好，你看最终的结果多少条数据？123456789 10 11 12 13、14，ok，没有问题。然后其实就是所有人这里我造的数据是这样的，所有人其实都和111通信了，所以你按照1111查，是把所有的数据其实都查到了，这样比较方便，就没搞得那么复杂。

然后你看这里的数据或者是from里有111对吧？或者是to里有111，那都是和111有关的对话，都是他的绘画就这样。

接下来我们再测第二部分数量， Message，map，点，select conversation，count还是111，我会得到一个数量，好，一会我一起执行，我先把另外两个方法也写出来，接下来我们再测一下查询某一个会话之下的私信 select，我要查哪一个会话，我查这个就111和112，所以在会话的ID应该是111下划线112对吧？然后零10给他一个分页条件的限制，我得到一个集合，然后同样的我把集合来输出一下，我可以copy。

好，然后再来我再查一下集合的数量是多少，我们用另外一个方法可以直接查到卖c的map点see light lighter，然后 CTRL ccid是它count等于它把它打印出来看看，最后再测一下我查到的查的未读数量对不对？好，说到未读数量，我们得看一下我这里到底有多少未读数量，因为未读数量比较少。Select seeing from the message where status等于0，然后 and from ID不等于一。看一下，你看vih的数量一共没多少，其中规划1131它有两个，我就查这个。我就a message map select letter，unread count。这个to，ID是1131131，看他这个人的位置数量，而绘画是他。好，然后抗体等于未读数量等于它，然后我再打出来看一下。

好，这几个方法都写完以后，我统一执行一下，看看它对不对？然后大家看前面这个是绘画的列表，刚才我们看过了不看绘画的数量14没有问题，1112之间的会话的详细的私信有这么多，一共有12345678条，后面查到数量也是8条没有问题。

然后最后未读消息数量131的是2。好，在这里面我们确认一下111和112它之间是8条私信吗？咱们可以这里查一下。再加个条件就不等于0了，这个就是说不等于2， and看我们先生ID等于11112我验证一下刚才我查到的数据对不对？不然错了就不知道。你看一共是12345678。没错。

好了，经过这个测试发现我写的代码ok，没有问题，那么下面我们就可以进行下一个环节就可以开发业务层，好下面我去开发业务组件，这样我在思尔维斯包下再新建一个类，因为这是一个新的功能，这个类叫message service。

好，然后我给它加一个注解service，这几个查询业务其实怎么说很简单，我们直接调 Map把数据查到就可以了，这中间不用做什么特殊的处理，所以我们就定义5个方法，直接调 map把它实现就可以。

当然首先我需要把 map注进来好，然后第一个方法是查询会话犯的consist这块没有引入一下，然后参数一个是优质ID，一个是offset，一个是里面实际上很简单就一句话，my smile点谁来看看CS，好这就完了，同样道理，另外4个方法也是这样简单的实现我就不啰嗦了，直接把它写出来。

好了，这几个应用方法我就写完了，这里没有什么逻辑我就不说了。现在业务层写完了，最后就是开发表现层，那么表现层刚才我们也说了，我们需要有两个功能，一个是会话列表，湿气列表，一个是点进去私信详情，都是分页显示一些数据，而这个数据其实数据并不多，比如显示一个用户名头像对吧？一个内容还有一个数量，时间差不多就完了，然后一循环就这么点东西就可以了。

然后分页我们还是可以复用首页的逻辑，所以说就很方便，所以其实看起来好像两个功能很多，其实很少。

好，那么接下来我写CTRL处理私信列表的请求先处理我在CTRL的目录下新建一个类取名叫message，很臭了大一点，然后前面加上CTRL的注解，好，然后这个类我就不给它取别名了，当然你取不取都行，我就不取了。

然后首先声明一个方法，处理私信列表请求，那么先声明了它的访问路径，访问路径是let类似的私信列表对吧？

然后请求方式是get，因为是查询方法名我叫get later list，然后没有什么参数进来，为了向页面传数据，我需要声明 model，另外为了支持分页，我要加上配置组件，那么要实现这个查询，首先我需要把 service注入进来是吧？

得用它message service，另外我再把 house hold住进来，因为你要查什么，你要查的是当前用户的私信，当前用户不得通过它获取对吧？了好。

这里面首先我要查的是私信列表，会话列表，我首先需要对分页的组件做一个设置，我先设置一下分页的信息配置点site limit我设它为5，因为我的数据并不多，一页显示5条，这样还能看出分页的效果。

然后配置点site，设置一下访路径就是当前的路径， letter，list，然后 page点side，rows设置一下一共会有多少条数据，这个得查了。Message service点。Find conversation你要查询当前会话的数量，这里面我们需要传递uzid uzid我可以通过 house偷的获得，这样我在此之前先把user获取到，因为后面可能还会用到，提前先获取一下。

好复用好，这里我就可以写user点，get ID分页信息处理完以后，那么接下来我就可以查询绘画列表了，也就是一句话就搞定了， message service点算一个conversation，传入user，点get ID传入user ID还要传入分页，消息配置点get offset配置的get limit。最终我会得到这样一个集合的名字，我叫 conversation please。好，这个有点长，最好换个行。好，得到数据以后你要注意这个数据还不够，因为什么？我们页面上不只是要就是这个消息，绘画这个消息我们还要显示什么？

还要显示就这个内容就是数量，这还要显示每一次绘画未读的数量，还要显示绘画里边一共包含几条私信，就是他还要帮额外的一些内容，所以你需要把额外的内容也查到，然后做一个包装。

那就这样还是按照以前的方法来处理，声明一个集合，里边的封装的是map，我把多个数据都存到map里面好，那么这个集合我取名叫看了c损失，那么我需要遍历这个列表，然后去构造 Map，如果它不等于我就去遍历。

好，每次遍历我需要新建一个map来重构这个数据，首先我先把卖c之前存进去，我就卖掉点兔子这个名字我得取消康复c型绘画和我们业务相匹配这样好。

理解好。记然后还要传什么？还要传的是每个会话里不是包含一个未读消息数量的，对吧？你要把未读消息数量查到。

好，我就map点put未读消息数量，按read count，然后调用 message service去查询 find，然后是later and read count，然后你要传入优质ID，另外还要传入会话ID，那个好办，从麦这里取 message点 get consisted，除了这个以外，我们还要在页面上显示会话里包含几条消息。这个也要查，我在之前补充在前面写。 Map点put，let come私信，数量也是查。 Message service，find letter count。那么需要传入会话ID， message点get consist ID。好，那么除了这个以外，其实还要显示什么呢？还要在每一个消息之前显示用户的头像。

会话有两个人 from有to显示谁一定是显示和我当前用户与之相对的那个人的，比如说当前用户是a我这里一定显示的是b对吧？你显示当前用户的头像就没有意思了，所以说显示的是与当前用户对话的一另外的一个人的头像，所以我们需要把这个目标找到，然后的话把它查出来。

首先我要判断这个目标它到底是谁，他或者是from中的一员或者是to中的一员，这样判定也很容易 to get ID目标的ID等于我们判断当前用户的ID它是否等于message点get from ID如果当前用户是这个消息的发起者，那目标就是接收人对吧？

所以说 to get ID此时就等于什么？就应该等于message点get to ID是吧？否则就是 Usid它等于to ID我的目标应该是from，ID有点绕，你稍微自己琢磨一下。

好，我得到了目标ID以后，目标这个对象就很容易查到了，查到以后我就要把它放到map里面，map点put，名字我取叫它get，这个得用user service来查，我还没有注入一下，注入以后回到刚才的位置， user service点儿饭的，白的把它盖的ID传入，我就得到了大概的对象也存进去了，最终我得到的 MAC我需要把它放到集合里，别忘了。

好，那么经过循环以后，最终我们得到了集合中的数据，我需要把它放到model里，传给模板，给它取个名字就叫conversations得了。好了，这个列表数据就有了以后还少点东西，还少点什么看一下。

咱们刚才查的未读消息数量是整个页面上有一个未读消息数量是它，你得查一下，所以我们把它也查到，这得单查，所以再来就是查询未读消息数量，这回查询你就不要带 com system ID了，是查整个用户的所有的先生个变量叫light and red。

Count等于 message service点。Find。Let every account把 uzid传进去，第二个参数传入空不用了。那么得到的数据我们也要传给模板，好处显示名字就叫let I read counting。好，这就完了，最后我们就返回模板的路径就可以了。Return这个页面是叫什么？看一下。这个页面是叫它later，然后后面有详情页面叫later detail，所以这里我要写的是sat later。好了，那么 Control处理请求我就写完了，接下来我们就来去处理这个模板。

当然这个模板我们首先要在首页上加上链接链到那去，所以我先打开首页index html，然后找到head的部分，找到这个消息，这个地方这儿我们需要给它加一个链接，改一下这个链接，然后刚才我的链接的名字叫lighter类似的，好这个路径就写完了，写完以后接下来我就可以去处理 Leiter的html。

当然首先我需要先声明，这是一个timely模版，然后这些静态资源的引入我需要注意一下处理，最后的 GS也需要处理。好处理完以后再往前看，这个页面比较长，这里边都是模拟的数据，这么多重复的数据，我们可以把其他的a删掉，留一个以此来循环就可以了，我顺便就把多余的ei给删了。因为碍事。好，先到这留一个可以了。

然后这次课我们开发的是查询，而不是发送私信，所以弹出框先不管，提示框先不管，这都是发送私信是要做的。然后前面的头部需要复用首页的头部对吧？所以我们需要写上提示为case，index还等，然后这个head我也可以折叠起来了。好，那么接下来我们就处理了正文的内容，咱们来看，首先我们处理这个地方，这个地方是哪？就首先你得能点能练就，其实就是练到当前这个消息页面对吧？能练过来。

其次未读数量要处理一下这儿，首先把链接给它改一下，有点长，我把它回个行，要不一瓶都看不下了，这样一下。

然后这个地方我改一下链接thhef和刚才首页上链接是一样的， Later list，然后这里边18里边的显示的数据，你需要去动态的处理， th冒号，text等于是未读消息数量是哪个变量它然后你要注意，如果说未读消息数上是0，你就不用显示个0在这了，对吧？没有必要，所以如果是它等于0的时候就别显示，不等于00:00它才显示。

所以这里我再加一个条件， th冒号if等于它不等于0是否在显示这个地方就处理完了，剩下我就是处理这个列表了，处理 li就这个li我们肯定是要做循环处理的，我们要循环的刚才的 CTRL的发送过来的集合，所以这里我需要写thh每次循环的变量名我叫map，然后我们需要遍历的是谁呢？是它循环了，然后再循环内部我要显示的这些数据要改成动态的值。

首先这个地方是什么是是未读数量我要把它先处理一下。好，我就写th冒号 text等于 map点，未读数量。I read count。当然这个也是跟刚才未读数量也是类似的，就是说如果说你未读数量是0，你也没有必要显示对吧？显示它就不好看。所以加个判断就当这个值不等于0的时候才显示，否则我就不显示这个数据了。

好，然后再往下，这个是一个图片是用户的头像，这里我们需要显示目标用户的头像，目标用户是谁？他get MAC点他get对吧？然后点 Hide UIM再往后这儿，你要显示目标用户的名字，th冒号u text等于matte点。Get点。有点好。然后再往后要显示就是消息发布的时间，会话发布的时间在这里写 th text时间的需要格式化，diss点format，然后是map点看了，谢谢。

点create，然后指定消息格式，好这是时间。然后再往下这个链接是链到详情，页面我们先不写，先不管它，然后就链接先不管，但是这个内容我们需要先处理一下，这个内容，绘画的内容。最后一条消息的内容，我这样写th冒号，you text等于 Map。

点最好copy一下，因为这个单词有点长容易写错。 Map、.composition，点内容、content。好，再往下再往下就这儿共几条绘画，这个几你得是一个变量对吧？不能写死，所以我在5前面加上个I吧，然后在a上声明它应该是几，这里应该是 map点，lighter com是会话所包含的私信的数量对吧？好，那么这个地方 Li里的数据就处理完了，处理完以后最后就说分页，分页就简单我们直接复用 index，页面的分页就可以了。

所以在这里写th冒号，replace等于 index。

冒号这个名字好了，到这儿我会话列表就写完了，写完以后咱们测一下，我把这个项目重新启动一下，启动以后我打开浏览器先访问一下首页，好，然后我点这个消息，但是这个消息上这个数量咱们还不先不处理，以后再说先点什么都没有，什么都没有，应该是我当前登录人有问题，就这个人他可能没有和别人发生过对话，我换一个人换一个人，我换成鄂AA AA它应该就是 ID为111的用户，我看一下确认一下是不是对用户的会话是特别多的，最多的AAA的密码还是AA然后登录以后点消息。

好，你看这个数据基本上是数据大概是对的，你看但是头像明显头像不对，这个头像我估计是哪写错了，我们看一下检查一下头像在哪呢？这儿这里是这个符号写错了，不是at这个是dollar。

我直接引用一个变量路径，然后作为 src的值，所以这里不是艾特好，这个地方改完以后重新编译一下，然后再打开这个页面刷新一下，好，这头像就ok了。

然后你仔细再看一看其他的数据，然后你看这是和BBB的会话和lhh的会话，AA的会话，yyy的会话，ww的会话没有问题，然后它的内容比较简单了，也都各不一样，头像也各不一样，然后当前用户只和他有一个未读的消息也没有问题，然后后面每一个会话里边包含多少条数据，这里也是动态的，也没有问题。

然后分页我们看下一页，可以下一页没问题对吧？首页没问题。好，当然了这里面我就不去详细的去验证说8条数据对不对？然后的话一条未读消息对不对？你可以自己在开发完以后自己去查询一下表，自己做一个判定。好，目前我们就把私信列表的功能就搞定了。那么最后我们再去花点时间把私信详情搞定就可以了。好，那么私信详情所需要的这两个查询方法我们已经写完了，不管是数据访问层还是业务层我们都完成了。

所以我们实现这个功能直接从表现层开始写就可以。那么首先我在master control里再加一个方法来处理的，这次请求加个方法。

我先声明一下这个方法的访问路径，这个方法它的路径我声明为叫later detail，然后因为你是点中一个会话，然后的话查看会话包含的详细的往来消息，所以说你这次请求当中需要传入的一个会话的ID，我希望在路径当中就包含会话ID。

好这个参数我叫composition ID，然后因为这是一次查询，所以说查询请求方式我用get好，然后声明一下这个方法名我叫get lighter。

Detail首先在这个方法里我就要先获取路径中的参数，那么还是使用pass外包，我们得到的是一个字符串，然后我们在显示详情的时候也是显示多条消息，所以说也是要支持分页的，所以说我把配置加上去。

另外为了向页面传数据加上model，好了，那方法的声明完了实现的话其实并不难，首先我先对分页的信息做一个设置，配置点set，limit我还设置了它也显示5条数据，然后配置点set，pass就是当前的路径， Later detail当然detail后面需要加上参数，然后再设置行数，这个行数需要查 message service点儿饭的来着抗体，然后把 com ccid传进去就可以了，那么有了分页的信息以后，我们就可以做分页查询了，那么我就调用message service点find典范的letters。

当然你需要把会话ID存进去，然后再把分页的相关的参数存进去，我们最终会得到一个集合，里边封装了一页的消息，那么这个名字我叫 later this，好，我们当前得到的就是一个信息列表，写注释得到以后，那么还没完，我们也需要对这个数据做一个补充，因为我们在页面上显示的时候，你像 user你要显示它的邮政名头像对吧？不能是ID。

那么这个message里面有两个uzid一个是from，一个是to，我们要显示要哪一个还是都要，咱们可以到页面上看一下，看进程页面就可以了，消息进去。那么这里其实谁是发信人，这里就显示谁的头像显示谁的名字，所以说不管是哪条记录都显示的是 from user是这样一一条。

所以说我们需要补充的是 from you的相关的数据，这样我再声明一个集合里面的存放map给它取个名字叫lettuce，好，然后我对莱特利斯的做一个判断，如果它非空我就对它进行一个便利，然后每次循环，首先我要先实例化一个map，准备用来封装数据的，然后首先我先把私信先放进去，给它取的名字就叫light，和我们的业务保持一致，另外我再把 from ID转换成from user做一个查询就可以了。

它的名字我叫福旺user，然后我调用user service进行查询，find user for ID这个ID应该是从message里取 get from ID好，完成以后不要忘了把 map放到集合里，所以let us点艾特，好了，集合数据就有了。那么我们在循环以外需要把集合发送给模板，所以说我要model点艾特，然后 Let us写错了。

好，除此以外还要补充一个内容，补充什么？我们打开刚才这个信息列表看一下，在列表之前有这样的一个东西来自谁的私信，其实这是来来自谁谁的，是当前登录用户与之对话的目标的人的名字。

所以说我们还得查到和当前的登录用户对话的那个人是谁，然后把它显示到这里，我们称这个人为目标，这个目标其实和我们之前的方法取的方式差不多，就是说我们看一下当前用户他是from ID吗？

如果是那目标就是to ID否则就是from ID但是我们这已经遍历完了，我们在编辑之外需要这样一个数据，你可以其实随便从集合里取一条数据，比如第一条数据，然后以此来判断可以我不取这集合中的数据，比如说我用康乐西山ID来判断也可以，因为它不就是两个ID拼在一起的，对吧？我们看一下一斜线横线，哪一端的ID和当前的登录用户不一样，那就是目标对不对？这也可以我从这里取取的逻辑我简单封装一个私有方法，然后一会好用，后来一个方法最终返回的是直接返回的是一个user，然后我叫get later。

好get就私信的目标，我需要你给我传入的是康复新ID。好那么首先我要把康复CS就做一个拆分，它中间是用一个横线相连，我就对它做一个拆分，拆分以后我会得到两个字符串，其实就是一个两个ID字符串，当然了那一会我们查的时候，我需要用到的是整数，所以说这样我把数组里边的每一个字符串转成整数，第一个叫第零，那就等于 integer pass into ideas对吧？

以此类推，再来一个 ID11，那么这两个ID有了以后，我们和当前的登录用户做一个判断就好了。 Host holder，然后点get you的点get ID。那么如果 Id它等于ID0的话，就是写错了少了一个，I我说怎么这么别扭呢？那么如果它等于ID0的话，那就说明目标是ID一，我就返回ide对应的用户 use the service点，find by idid好，否则我就返回另外一个数据对应的用户就可以了。

好了，这个方法的封装以后，回到刚才的代码里，我们进行了下一步操作，就是我要查询私信的目标，然后要把它发送给模板上的好处显示我就直接猫都有点艾特，然后这个变量名我叫条带目标，这个数据调那个方法直接获取就可以了。

就get lighter to get，然后把康c加ID传入就行了。

好，那么最终数据处理完以后，我们要返回模板，那个模板叫做site，然后叫let it kill，好，那么 CTRL我们就写完了，写完以后接下来我们就可以开发这个模板，首先我们先在会话列表里先做一个处理，因为你要加上链接才能链到详情页面对吧？你要把链接做好，链接是在哪？在列表里在这个是私信的内容，私信的正文，那么我们点正文就能链到详情页面去，目前的话它这个路径是不对的，我们去改一下。

好，我把它链到，但是我们这个链接里边还包含一个变量对不对？所以说你得拼给我写个双竖线，然后的话是light，然后是 detail，然后是一个变量，这个变量我们需要取到康ccid咱们看一下怎么取呢？其实也好取，你看这个数据 Map点conversation点什么对吧？ Conversation其实是一个message，它里边就有conversation，ID是吧？

所以说你就可以这样 map点看看星星，然后看看谁先ID好了，这个链接处理好以后，就可以练到详情页面，下面我们就可以去编辑详情页面了，我打开这个页面我搜一下，lighter得跳，这个页面我们从来没有编辑过，所以说要从头开始。

首先我先把这个模板说明好，好，另外把静态资源引入路径改对了，忘了背了括号补充一下，好。然后这个header你需要用首页的header去替换，替换完就可以了。至于这个内容我们一会再改，我们先往下看，尾部不用处理，这些静态资源都需要改，这是需要改的。

好，下面我们就开始改正文了。从前往后过，首先在这个地方就是你要把这个名字改成目标的那个人的名字对吧？这个容易就是改个名字而已。 Thu text等于目标是 to get点user name。

这就行了，然后弹出框这里不用显示什么消息，这是增加天发送私信的时候用的，我们暂时先不用，然后是私信列表，然后私信列表里边也是有多条数据，每一条这里是一个l然后静态页面上给我们模拟的一些数据，我们可以把多余的ln的删掉，保留一个就可以了。

好，我保留了一个li，然后以此为模板进行遍历。

我在ls上写上th冒号，each等于我们便利的集合，它里面封装的是卖的，所以便利什么我就卖，这样比较直观，然后集合叫let us好，每次遍历里边数据有一些地方要改，首先用户头像要改，刚才我们也说了用户要显示的是 from就是消息的发送的人的相关的内容，所以说我们要显示的是from相关的信息。

那么就是map点 from you'd刚才我们查到了是吧？然后 Ida URL行了，再往下看。然后这个是 from的用户名，也就是thu text map点from user点username。好，然后再看，这有个时间应该是这个消息发布的时间需要格式化， th text等于格式化一下，对此 format，然后时间的获取是 map点 later。Create time。格式指定一下。好，再往后看。然后这就是正文you text等于点 later点内容 content。

好了，那么这个消息的展示的内容这就设置好了，设置好以后最后还差个分页，而分页的逻辑我们可以复用首页的逻辑，这个就简单了，它等于index冒号，然后是这个名字，好了，到这儿我们详情页面也就处理完了，处理完以后行不行，咱们再试一下，我重新编译一下 CTRL s9服务重启的，然后我们打开浏览器看一下，当然目前我所处的是会话列表页面我刷一下，刷以后看这个链接对不对？

比如说你看放到这上去看，左下角的链接没有问题，我点进去看，这有8条规划，8条消息，然后第一页123455条消息，来自BBB的私信，当前用户不是AAA对吧？目标的私信。然后左侧显示的是发消息的人的头像和他的名字没有问题，然后下一页没问题。当然这里还有返回是吧？点一下返回不对，只有个返回它这个链接。不对，这是我们需要改一下才可以的。

好，下面我们来改一下返回的链接，好，我再回到这个工具，然后找到返回的位置，他之前写的 Location点h一f等于一个静态页面，静态页面没有问题，但是我们现在不是静态页面了就不对了。

这里我们需要改成我们当前的路径，就是莱特，然后 detail当然其实你也可以改成什么？

 History点back，但是 history点back它是靠历史回去的，我希望他不走历史记录，而是每次他真的去重新访问一下会话列表，然后这样的话好可以刷新一下，因为我后面还会把已读的状态设置好，比如说你私信里有未读的，你点进来就变成已读了，我希望他能刷一下，如果你直接后退的话可能就刷不过来。

这个地方因为直接写不太好写，这里头直接写这里不太好写，因为我们现在路径变得复杂了，而且我们路径当中还要包含这个项目名，而项目里面我们把它做成了一个常量，你在这里不方便写那个东西，我这样我就直接写一个方法叫back，然后我在下面写一段js来实现它就可以了。

当然 GS是很简单的在这儿，好我来实现后退的方法，其实就是做一个很简单的跳转，就一句话location点href等于然后项目的访问路径，context pass加上上一线，双引号，然后是let list我们回到会话列表页面。

好，写完以后重新编译，再看我在这刷新一下，然后点一下就回去了。好了，到这儿我们就把私信详情也开发完了，整个私信列表私信详情，这两个查询我们就完成了。好，这次课我们就演示到这里，咱们下次课再见。