54-项目监控.mp4

这次课我们来学习项目监控，就是在我们这个项目上线以后，我们怎么去对这个项目进行一个监控，好知道他这个是不是健康而稳定。那么我们所开发的框架是 spring boot，像这样的框架所开发出来的项目，我们项目监控就更重要了，为什么？因为我们用spring布的去开发的时候，它的开发难度是降低的，我们很多地方它都不用配，或者说简单的配一配就可以就能用就能开发。

但是程序在执行的时候，它底层做了很多的事，我们表面看不出来，所以我们程序中一共有多少个bin呢？并之间是什么关系，有多少个日志对吧？有多少开始我们的请求这个路径合并之间是什么映射关系等等，这么一系列的内容，我们都看不见摸不着，这个很让人这个担忧，担心他们是不是会有什么问题。

所以说我们在系统上线以后很有必要去关注这些个点，看一看这个程序是否像我预期的那样去健康运行。

那么 Spring boot的开发者他们也就是想到了这一点，所以说它提供一个很好用的工具来帮我们做这样的事情，这个工具叫spring boot act Twitter是专门用来监控十分像的，那么它的功能非常的强大，然后也非常的灵活，那么它弥补了4分部的项目，它在简开发简单的同时，带来了底层的就是隐藏所带来的一些就是隐忧，他帮我们解决了。

而要学习 step的艾克推特，我们需要主要了解这么一个概念，叫on，the points。

翻译过来就是端点，那什么是端点呢？这里我写的很清楚，就是监控应用程序的入口，我们通过端点去对我们刚才所说的那些个方面去监控，这个端点是多个 sprint里边它自带了很多个端点，如果你觉得不够用你也可以自定义，所以它一个是功能很强大，同时又很灵活。

然后我们如何去访问端点去看这些内容有两种方式，一种是我们通过HTTP的方式，当我们应用启动以来以后，我们通过浏览器写一个符合HTTP规范的路径，就能够看到就能够访问端点看到一些内容，或者是用 gmx我们 jdk安装以后，它里面带了一个工具一个副客户端也可以，我课上就演示前者比较方便一点，我们用前者要访问这个端点这路径怎么写，路径是这样的，前面的话你该怎么写怎么写，如果house的8080 community，那么从项目往下，下级路径叫active统一的，然后下级这是端点的ID health，这是举个例子。

那么sprint内置了20多个端点，你就访问哪个端点就写他的ID就可以了。

当然了因为它的 idea特别多，我们不用说每一个都给你演示一遍，大家每一个都了解都懂。那么当你这个工作的时候，然后的话，你需要监控什么？你去手册上找一下 sprint部的手册上，就专门有一章写这个艾特，然后那边有多少个端点，他写得很清楚了，你去找一下，然后去看就可以了。

但是我们在加了这个功能以后，你要注意的一件事就是我要按需去配置，要暴露的端点，那么怎么说就是说如果你这个端点就从来不用你就别暴露了，因为暴露的话一个是影响性能，再一个的话也有被别人窃取到的一个风险。

再一个的话我们要对所有的端点进行一个权限控制，因为如果你不控制的话，那么谁都能访问到信息，它就能直接访问你应用的底层的内容，这个是很危险的对吧？所以说你要给它加上权限控制，像这样的请求，只有管理员能访问这样好一点。

好了，大概做了介绍以后，下面我们就来写一些例子来看一看这个东西怎么用。首先我们要用这个功能，你得先打包，我就搜一下这个包打开妹妹被抛弃的人，然后的话我搜是不瑞不疼对头。

好，就是 Spring boot activity不是 start，我没有start用 start好点进去，然后选一个版本，然后这copy我把它粘到我们配置文件里，这个版本我去掉，这样就用副泡沫指定的版本，很快这个包就导进来了，导进来以后，你只要这个导入了这个包，它立刻其实就有效了，这个时候我们启动应用的话就可以访问它的它的一些端点。

当然它默认的话不是所有端点都这个暴露出来，是这样，它默认有20多个端点，其中几乎所有的端点都是启用的，只有一个端点，默认是禁用的，端点的作用是用来关闭服务器，我建议你就不要把它启用了，因为什么？你通过端点去关闭服务器这个事儿有点儿儿戏，你要关闭服务器去服务器上去关，你为什么要通过端点去关呢？对吧？

而且它关闭服务器的方式还得用POS的请求对吧？就给人感觉这是留了个后门，你非要走后门，这是这是很危险的一件事，你就别启用了，对我们来说默认就所有的端点都启用了，但是默认情况下它只暴露了两个端点，只允许你访问两个，那么其他的端点你要访问的话，你需要声明加以配置，一会我们看怎么配，好，这样我已经导入这个包，我就把程序启动一下，我们来访问一下这个端点它暴露的端点看一下，好启动一下。

好了，服务已经启动了，我打开浏览器，然后访问一下，我先访问首页，好，然后我要访问这个端点，下级路径 Twitter，然后它默认暴露了两个端点，一个叫health端点返回的是当前的服务健康的程度是否健康的状况，然后它返回的是一个阶层格式的数据，返回的是status，up表示这个状态是ok的。

挺好。好，然后还有一个端点是默认是开放的叫音符，其实返回的是一个服务端的一个一些相关的信息，但是现在他什么也没返回空的。好了，总之我们现在先尝试一下，确实能访问，只要我一装上这个工具，它立刻就能够暴露出来一些信息给我们，对吧？当然这两个只是一个概况，更有效的我们更关注的内容，默认的话它没有给我们暴露出来，怎么暴露，还需要配我们配一下，我就打开配置文件。

 Application，practice，这个配置你可以从思政部的官方手册去找，然后这里我就直接写出来了，这是x的相关的配置。

然后的话通常我们会这样配，首先是manager问题，点on，the point就是端点，然后点y X pose点include等于什么意思？就是说我要暴露哪个端点，比如说我要暴露病死，这个端点我要查看所有的病你可以这样写，比如说我还想暴露日志的端点，你可以选logs，当然是20多个端点，比如说我都想暴露怎么办？你就别一个一个写了，你可以写个星，就所有的端点都暴露，我都可以访问，但是可能有个别几个我不需要，我想把它禁掉，我先都暴露，然后再把个别几个禁掉，这样不省事对吧？

所以说我看可以这样写，再复制一行management。

第二and points Web expose，然后这个地方就排除 include等于，然后写上你要排除的端点，比如说我要排除音符，然后我要排除cat，比如这个是缓存相关的信息或排除，其他都保留，这就是一个例子，将来你可以自己完全自定义，但是我是给你做一个示例示范。

好，那么写完以后试一下CTRL f9，好，那么它就重启了，重启完以后我打开浏览器，我这回再访问Info，你看它提示404不暴露了，隐藏了，然后我访问catch返不了隐藏了，而其他的health可以的对吧？

然后还有一个beans，BS是返回我们应用中，我们当前这个容器里所有的病，他是一个超级大的一个内容，当然有人说你返回这样的内容我怎么看？

他只是给你返回这个内容，这个内容的分析，你可以写一个程序，或者是你想你把这个内容拷起来，写一个程序解析一下，然后再去细看，或者是你安装一些和 act有关的一些工具，它能够帮你去分析这个结果。

总之我们看到这是一个接生的对象，它里面包含了所有的病，有这些东西我们就怎么说就放心了，然后的话需要用的时候再详细的分析，对吧？毕竟有这么一个渠道好。

然后再看比如说我要看logs，这是所有的日志的内容等等，总之二十几个端点你可以挨个这样去看，每一个端点暴露出一方面的内容，你需要看什么，你就去这样去访问就可以了。

好，以上是我们演示的是它内置的端点，比如说我想监控的内容，这里边没有，我想监控的内容其实可能和业务有关系，要监控个性化的东西，你可以自定义端点，下面给大家写一下怎么去自定义一个端点。

我们会自定义端点以后，可能你对艾特的底层就有一个更清楚的了解了，我把这个端点单独建一个包，我在这个肯定得等一下再建一个包就叫艾特。

好，然后这里我要创建一个类，代表的是一个端点，我先说一下我建这个端点要监控什么，比如说我要监控数据库，看它的连接当前是不是正常的。

好，所以端点这个类的名字我叫data，贝斯数据库，然后 and point。好，那么这个类我们需要就把它交给容器来管理，所以我加上component它不属于任何一个层，它是公共的一个组件。

另外我们还需要在端点上再加一个特殊的注解。On，the point。On，the point里你要写上ID等于什么？这就是给端点取一个ID，好，让我们将来通过ID能访问它，你这个ID是什么这个地方我们就通过ID来访问它。好，这个我就叫好，然后这里边怎么写？首先我先实地画一个logo，一会有用。好，实例画完log以后，我们怎么看数据库当前的连接是不是正常的？你可以在端点调用端点的时候，你尝试去访问一下数据库，你尝试去获取一个连接对吧？如果说这个连接能取到，那就表示ok的，如果取不到就是有问题的对吧？

所以说我们尝试获取一个连接，我们尝试获取连接其实有多种方式，一种方式我们可以访问连接池，你把data source注入进来，然后 get connection，或者用更原始的方式，我们直接把连接参数注入进来，然后我通过专卖店去访问都行。这样我就简单简单一点，我就通过连接池去访这个连接，咱们来看一下，好，那么连接尺其实是由 spring容器来管理的，所以说你直接把它注入进来就可以了，连接池的顶层接口就叫data source。

好，有了连接池以后我就可以尝试获取连接了，我就能看我能不能得到连接。接下来我需要写一个方法来去做这件事儿，我定一个方法，这个方法我就要check，connect这方法之前需要加一个注解，我叫read。Operation什么意思？就比方说这个方法我们是通过盖的请求来访问的，是一个盖的请求，如果是其他的请求，你要写你要访问其他的option，其他的好像有我记得好像是right option。

你看有write option那就是 post或者是put提交数据，我这是get请求，所以用 Read option，也就是说这个端点你只能通过get请求来访问，它表示的get请求的意思。

好，然后这个方法之内我就尝试获取连接，我就 data source点get connection。当然这句话我们需要再开始，这样我把这句话写到小括号里，为啥写在小括号里？因为在小括号里我们初始化的资源，那么编译的时候它会自动加finally把它关闭掉，这样我就不用手动关闭了。好，然后那么在这里我如果是程序进行到这就表示没报错，那我就记个日志，不是记日志就直接返回一个结果，我们要返回一个什么结果？

其实你也看到了端点要给浏览器，返回的是一个Jason对吧？

所以我死卷要返回的是Jason的字符串，我这里写委特community有推广get杰森死菌，然后的话扣打0给个提示说获取连接成功，比如说连接没问题，如果捕获到异常了，这个时候我最好记个日志说获取连接失败，把这个错误消息也带上，然后的话这时候也返回一个结果，给浏览器平面的YouTube get杰森斯卷一获取连接失败。

好了，这样就可以了，写完以后我们不用配，因为这个并是交给容器来管理的，直接就可用，然后我们直接重新编译CTRL f九。好了，完成以后我们打开浏览器访问一下，这块你就得写data，base你看获取连接成功没有问题对吧？那就表示说这数据库连接没问题。好，如何自定义端点我们也演示完了，总之你是用它自带的还是自定义的都可以了。

最后别忘了一件事儿，就是我们端点的路径一定要做权限管理，不然的话谁都能访问，这个很危险对吧？而做权限管理的话非常简单，因为我们现在有这个secret，所以说我们直接在 Secret里做一个简单的配置就可以了。找到配置类，这个功能应该是只有管理员能用，其他人都不能用，所以说我把它配到这儿。这个路径是艾特杠，星星只要以艾特打头的，那么都是管理员才能访问。

好，再重构一下，再重新编译一下，编译完以后再来。比如说访问一下首页，看一下我当天有没有登录，没登录我访问艾特Twitter，然后health不可以你得登录对吧？我登录一下 CC。好，再访问艾特还是不行，因为权限不够，这不是管理员。好，我用管理员登录11再来访问艾特尔斯，这就可以了，再访问 Database。好没有问题。那么如何使用speak Twitter进行一个项目监控，就是这样的一个操作。好了，那么关于这项内容我们就演示到这里，咱们下次课再见。