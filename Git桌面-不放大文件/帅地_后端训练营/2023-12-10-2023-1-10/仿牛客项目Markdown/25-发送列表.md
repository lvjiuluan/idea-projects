25-发送列表.mp4

这节课我们来实现发送私信的功能，那么发送私信的功能我们需要用异步请求的方式来实现。除此以外，我们在完善一下私信详情页面，当我们进入到详情页面以后，如果详情页面上包含了未读的消息，但是这个时候你进来了，你已经看到了，我们需要自动的把它设置为已读，要再补充一下这么两个功能。

当然我们对着PPT说这两个功能并不生动，我给大家看一下静态页面，咱们通过静态页面来直观的了解一下这个工程到底怎么回事。

首先发送私信你是在消息页面，然后点发私信，弹出个框，然后你填写的发给谁，填写用户名，然后填写内容点发送，然后用异步请求的方式发给服务器，然后服务器返回了结果以后，判断是成功还是失败，我们最终给一个提示就好了。

除此以外，我们在进入到详情页面的时候，这个地方也是可以给某人私信，就给当前你对话的目标私信你点的时候，这地方要自动带上当前对话的目标，那个人的名字，然后的话内容你去填就可以了，然后点发送完成。

所以这个地方和刚才那个地方，其实这两个地方的逻辑是一样的，完全是一样的，我们可以分成一套代码，只不过我们在这个页面上点这个按钮的时候，它只是默认带了一个用户名而已，这个好处理。

再有当我们进入到私信详情页面的时候，那么如果这里包含了已读的未读的消息，你要把它改为已读。

好，这样我们先来处理添加发送私信的功能，首先我们还是从数据访问层开始写起，我们需要在数据访问层写一个增加的方法，对吧？我就打开 Message map，然后补充一个方法，增加那么增加返回的是整数，然后的方法名insert message。

好，然后参数就是mess，把实体写个注释，这是新增一个消息，除此以外，一会儿我们还要做就是把未读的消息设置为已读的这么一一种状态的这么一个逻辑，这个显然就是要更改这个消息的状态，把它由零改为一，然后我们在私信页面一下能看到多条消息，所以你可能一下需要改多个私信，所以说这里我定义一个修改状态的方法，不对的 status，那么这个参数这个修改的条件应该是多个，ID不是一个，所以这里我给一个集合，inter，然后爱丽丝另外你要把这个状态传进来，你要把它改成什么状态？

传进来。

好，这个方法是修改消息的状态，当然你不只是可以利用它设置已读，你也可以利用它设置，删除它都可以。那么定义了这两个方法以后，我们就来实现它，我打开配置文件搜一下 message map。好，那么要实现增加的逻辑，我把 insert字段也把它提出来，在这里写一下，把ID去掉就可以了。

然后我就来实现这个方法，insert message在后面补充了，ID等于它，然后这个参数是message，那么增加的时候 ID是自增长，我声明 ID字段对应的属性是谁这样生成，完 ID以后会回填对象中的属性，这样我们通过这个对象就能得到刚刚生成的 ID。

好，下面我就写 insert语句了，很简单了。

我需要引用刚才的 circle。好了，然后 Virus给它赋值分别是from ID to ID，他们申请ID，然后是content，接下来是状态。最后是创建时间，好了增加的逻辑就完成了。

好，接下来我们再来处理修改的逻辑，ID我copy一下，省得写错了。好update，然后它的参数多个我就不声明了，返回的一定是整数，不用声明，然后不对it sat。 standards等于standard的参数，然后 where你注意它传入的ID是多个，所以你就不能ID等于了，你肯定得ID in。

 In，然后多个我们知道in的语法是in，括号里边有多个ID中间逗号隔开，这里怎么写？因为参数给我的是一个集合，买卖特色它允许我们通过一个叫fall意识的标签去遍历集合，然后拼成一个括号里边带有多个条件，中间逗号隔开的形式怎么拼？我一写你你就能看得懂很简单的 For each。然后 collection你要写什么？就是集合你要遍历谁？

遍历的是爱丽丝参数集合，那么每次遍历我们需要声明一个就是变量，用来指代每次我们获取的值需要写一个属性叫 Item等于ID，每次我们得到一个ID，我们就是要把 ID拼到括号里去，拼的时候我们以左边的括号开头，右边的括号结尾，中间以逗号隔开，这个也需要声明的，那可以也很好写，open表示说以主括号开头，然后 separate，逗号表示中间以逗号隔开， close右括号表示以右括号结尾，这就可以了。

好。然后 for each中间我这样写井号ID，那意思是我最终在这个循环当中我要拼的是什么？我拼的是每次得到的一个循环变量，那就是把 Id拼到这俩括号之间，以逗号隔开，这样一个形式非常简单。

好了，这样的话咱们数据访问层就写完了，写完以后我们就可以接下来写业务层也不难，能够打开之前我们创建好的业务组件， message service，我需要先增加一个方法，用来就是添加一条消息。

爱的。

 message，参数是message，这个没什么好说的，唯一需要注意的是你在添加之前你要对消息的内容进行过滤，避免它有敏感词有标记就影响别人阅读是吧？

我需要把过滤敏感词的工具注入进来。

对，好了。

我就对内容进行过滤了，很简单了，message点，site，content，然后的话先过滤标签， html点，然后是麦穗点，get content。好，然后再过滤敏感词，message点get content。那么都过滤完以后，我就直接调用map去做插入就可以了。好这就完成了。除此以外我们在实现再补充一个业务，读这个消息，把消息变成已读。

好，我写一个方法来解决这项业务这个方法。我叫read message读取消息，因为读取消息最终是改变状态，所以我返回的是改变的行数。我支持一次多多条消息，所以你可以传入一个集合， Ids实际上也非常简单，就一句话，message my project update，然后把ideas传入，读是把它的状态改为已读，已读状态就是一就可以了。

好了，那么业务层面也写完了，最后就是处理数据访问层，接下来我就打开这个麦子就肯抽了，我在后面再追加一个处理请求的方法，这个方法先声明它的路径是let send可以了，然后请求的方式这个得是post，因为这是要提交数据进来。

另外刚才我们也说了这个请求是异步的，所以说你要加上注解 response body，好，我把这个方法声明一下，send light。

然后那么页面上那个表单需要传两个数据进来，一个是你要发私信给谁，而且传提交的不是接受人的ID，他是接受人用户名，那就to，name。另外传的是私信的名内容，content，这两个值传进来就可以了。

好，那么我们要发私信，首先我们要构造私信的数据，而这个数据这两个值有了，其他值还没有，但这个值不行，这个值是接收者的用户名，但我们需要的是ID，我需要通过用户名查询用户，然后再得到ID，所以我需要调user service的find by user name这样的方法。

User service点find，但目前还没有，这个之前还没写，我们就补充一下很简单了，我打开user service写错了，user service我在后面补充一个方法是一个查询方法，他查到的是一个user，是吧？

然后方法名我叫find user by name，根据用户名来查，显然你传入的是用户名，实现非常简单， Map里我们早已经把这个方法已经加上来了， user map点select by name。

好。

有了这个方法以后我们可以继续了。回到刚才的这个地方，那就是user service点find user by name。然后你把to name传进去，我就得到了我对话的目标了条，get得到以后判断一下，万一用户不存在对吧？判断一下，如果他盖的是空的，我们就直接给他返回一个提示，就不往下进行了，返回一个Jason数据，肯定内推YouTube点get杰森 string。给他返回一个一代表错误，然后给他一个提示，说目标用户不存在。

好，那么如果目标用户存在，我们可以继续可以利用当前的数据去构造，要插入的对象就是message。

好，那么我们挨个的构造它的数据 Message点site from ID那肯定是当前登录的用户发的消息，对吧？所以我们要从当前的用户中去取，然后 message点site to ID给谁 to get ID是吧？好，然后还有个字段是会话ID，会话ID之前我讲过它是这两个对话的人，ID拼起来中间有横线拼起来，但是要求就是ID小的在前，大的在后，所以我们需要判断一下 message点get from ID它是否小于message点get to ID？

那么如果是的话就把from拼在前面，我就这样写。

Message点set看了ccid然后是message点get from ID加上别忘了下划线，加上message点get to ID，好，这样拼一下，否则就反过来拼就可以了，我把这句话 copy一下，然后把这两者顺序的颠倒一下，或者直接就改。 To ID from ID。

好，可以了。再往后那就是message点，site，内容，content，内容，然后 Message、点、site，status你不设置也行，因为默认值0默认就是0，然后可以set，create time当前时间好了。那么这些都设置好以后，我们就可以做插入了。你就调message，service点ID就可以了。好，最终如果没有报错，我们就给页面返回一个状态0就可以了。

0就行了。

当然如果报错，我们将来统一处理异常，统一解决这个问题。好这个请求也处理完了，处理完以后，那么接下来我们就可以写这个页面的逻辑了，那么我们打开这个页面这个页面，我们看一下这个按钮怎么回事，搜一下这个页面。

叫light点html好，那么在当前的页面上我找到发送私信的按钮，从这儿你看不出来什么，因为什么点这个按钮，它所做的事情是由 GS来实现的，所以说我们得看看当前页面引入了什么GS， GS里怎么写的，其实主要看GS。好，往后看。 Global GS显然不是应该是light点GS好，我们就看一下 light点GS里有啥？你看light点GS里的它对这是发送按钮，单击事件做了定义，单击时调这个方法，这个方法里先把对话框隐藏掉，然后把提示框显示出来，两秒以后再把提示框关了，这个逻辑没有问题，就是你点这个我说错了，你点刚才的发私信按钮，其实它是弹出这个框，然后你在框里填完数据以后点发送时，然后才会调这个方法，这是对发送按钮做的一个事件的定义。

那么发送的时候它把弹出框先关掉，然后再把提示框显示，然后再自动关闭，是这样的，所以整个的逻辑我们应该在哪写？应该是在这个中间对吧？先把框关掉，然后我去向服务端发送数据，然后服务端给我反馈结果以后，我再去做提示，在这里面写。

好，这个写就很简单了，我们从页面上获取接受人以及内容，先把这俩数据获取到 Where to，name等于。

我看一下那个人怎么取，看这个框发给他，它的ID是它可以通过ID获取的ID选择器，然后文本框的值点Val同理在获取内容，看内容，框的ID是他也是 ID选择器，然后它的值点Val好，然后我们就异步的发一个post的请求，很简单三个参数，首先的话是访问路径康txt。pass框态的pass，然后后面的路径是light，然后是散的，接下来我们需要声明我们要传的数据的参数，一个是to name，它的值就是to name，再一个是content，它的值就叫content，最后是处理服务端返回的结果。

接受一个数据data，这个data是一个普通的字符串，当然它满足杰森的格式，我们需要把它转化为 GS对象，就用解卡瑞的 purse杰森。

来解决。

把它传入进去，转为监视对象就可以了。

好，那么有了这个对象以后，我们需要对返回的结果进行判断，如果 data点code等于0，比如说成功了对吧？

发送了，我们给个提示，提示到提示框里，这个是提示框其实就到这里了，提示框的ID是hint body，我就通过ID获取获取提示框里的内容，普通的元素不是表单元素，我们取内容点text，然后给个提示说发送成功，否则发送失败了，发送失败我们也是给一个提示，还是这句话，但这里面你要把具体失败的原因都写上，带他点卖c好，那么无论是成功了还是失败了，最终的话我都希望把页面刷新一下，刷新页面的逻辑就这了。

先把提示框显示出来，然后过两秒自动把它隐藏掉，隐藏掉以后当前页面刷新一下 location点，对漏的承载当前页面，好这就行了，然后还要注意一下注意什么？我们在私信详情页面上点给他私信的时候，这个地方会默认带上用户名，但现在我们没有处理过对吧？

我得处理一下，所以我们再打开私信详情页面，找到那个地方给它处理一下。弹出框里是发私信发给某某某，目前的话这是写死的，我们需要把它改成一个变量对吧？改成一个变量。好，我就写上th冒号，我们应该取谁？应该取我们对话的目标，对吧？我要把私信的发给对话的目标，对话的目标怎么取？你看之前我们不是取过吗？他get点you the name对吧？就这么取一模一样的。这个地方就th点value，然后等于也是 Target点you的name。

好了，到这儿我们发送c相关的逻辑就已经写完了，咱们测一下，我把这个服务启动一下。

好，启动完以后咱们试一下，我打开浏览器，然后访问一下，首页这已经登录了这已经登录了，登录的账号是AAA我就看一下AAA的点这个消息，然后我在这发私信，比如说我要发给CC，然后的话发的内容是你好 CC好，然后点发送提示发送成功了，然后这样我和CC之间就多了一条会话，但是这个是由CC来读的，我我是默认就是已读的，因为是我发的，对于CC来说他需要读，读完以后才能改这个状态，然后你进去看这个也没问题。

然后比如说我再发一个，比如我在这在这我再给他私信看这行不行，给他私信。 Cc有了。

然后说。

你在吗？

发送。

然后它刷新了当前页面，所以又多了一条数据，你在吗？没问题，然后是倒叙。可以的。好， Cc我先不看了，因为CC现在看的话一定是未读的状态，我们需要再把刚才所说的另外的一个环节补充一下。当CC看这个数据的时候，当他看到的时候把它改为已读这个站点处理，其实很好处理。

我再回到开发工具里，我们只需要在CTRL那里，在这儿你看 get later detail不就是处理访问私信详情页面的请求吗？对吧？在这次请求里你就给页面返回了几条数据，那么如果这个数据中包含未读的话，此时你就可以把它改为已读了，因为用户打开这个页面，他看到这个结果以后他就是读了，对吧？他就是了。

好，所以说我们需要做的事情是再补充一步，你要把私信列表里头的未读的消息提取出来，然后把它自动的设置为已读就行了。

好，如何从集合里提取出未读的消息，我们可以再单独补充一个方法，在一个方法里面把它实现了。好，我加一个方法 Private，当然我得到的未读的消息我要的是一个集合多个，然后要的是一个 ID整数就可以了。那方法名我叫get light。Ideas。那么需要你传入私信列表，later list，然后我从中去筛选。好，那么这样我首先先实例化一下集合，准备往里存数据， list爱丽丝等于new和released，最后我就return的是爱丽丝。

好，然后我需要看集合里有没有我想要的数据，我需要对它做判断，如果它不为空，我对它进行一个遍历。

好，每次遍历我看一看它里边没有我想要的数据，这里你注意，你不只是要看，不只是要看他的状态，你也要看一下我当前的用户他是不是接收者，因为只有当前的用户是接收者的身份的时候，他才有可能是他才是一个独的身份对吧？

他才是做一个独的操作，他才可能会把数据变为已读。如果你是发送者对吧？你本身就是读到你发的消息了。

好，我判断一下，如果 House的后者叫get user叫get ID，它等于 message点get to ID，我是一个接收者的身份，另外最好还要看一下当前的 message，我是接受者的身份，而且这个消息它确实处于未读的状态 and message点get standards等于0，这个时候我就需要对它做处理，我就需要把它加到集合里面去。

 Id是点艾特，message点get ID。

好这样就行了，反正经过方法的处理以后，我们就得到了集合当中未读的消息的ID，我们在这次请求当中把它自动的设置为已读就可以了，我们直接调那个方法就行了，在调之前先把 ID得到 IDs等于get letter IDs然后你需要把 let list传进来，把它传进来就可以了，不用聚合的集合这个数，这个没必要，我们只要用这个就可以了。

好得到ID以后去更改它的数据，当然更改之前判断一下，ID点is安排，如果说它非空，你要为空就没有必要去更改了，如果是非空的，我们就卖c就service，点read message，然后把爱丽丝传入就行了。好，那么处理完以后重新编译，已经重启了，我打开浏览器我先刷一下，我换个人刚才不是发信给CC了吗？Cc有两条未读的消息对吧？我登录一下CC的账号。

好，然后看一下有两条未读消息在一次会话里，两条，然后我点一下，好，这就读了，这就读了，读了以后返回。

再看未读的状态就没有了，就说明刚才我们设置已经ok了。

然后你看我清空一下控台，我再点一下会话，然后回到控制台，你可以看一下打印的circle，你看还有没有不对的，你仔细一看就只有查询，没有update说明，这次已经是已读状态了，所以说这句话没有被执行，所以我们这个逻辑还是ok的。好了，这次课我们就把发送私信开发完了，我们这次课就演示到这里，咱们下次课再见。