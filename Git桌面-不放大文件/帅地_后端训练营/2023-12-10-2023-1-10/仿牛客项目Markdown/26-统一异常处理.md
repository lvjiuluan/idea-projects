26-统一异常处理.mp4

这次课咱们来学习如何统一处理异常，那么要想统一处理异常，我们先来回顾一下我们服务端三层架构，咱们之前讲过服务端分为三层，表现层，业务层还有数据层，然后浏览器发送的请求一律发给表现层，然后表现层调用业务层调用数据层。

那么你可以想象一下，比如说数据层这儿出异常了会怎么办？对吧？

他会抛出去抛给谁，抛给他的调用者业务层，那业务层把这异常再往上抛，会抛给表现层，所以整个这三层架构其实表现层是冲在最前方的，它是一个顶层的层次，所以无论是数据层还是业务层，无论是哪个层次的异常，最终都会有汇集到这个表现层到这来。

因此只要我们抓住表现层，我们对表现层统一的捕获异常，处理异常，就能整个的处理系统中所有的异常，所以我们统一处理异常主要是针对表现层的，那么我们如何对表现层处理异常呢？其实spring boot也好，还是spring也好，它都给我们提供了一些现成的方案。

你比如说 spring boot他给我们提供的方案就很直接，你只要在我们项目的某一个特定的路径下，加上对应特定状态错误状态的页面，那么他在发现这种错误的时候，自动的就跳转到那个页面就很方便。

当然了，其实我们在浏览器我们的服务器在给浏览器响应的时候，错误的情况是有很多的，但我们项目中最常见的就是一个就是404找不到资源，一个是500服务端报错，这样我先不去说 spring的方案，我先把 spring boot简洁的方案先给大家演示一下，我们先看一下。

好，那么我们这个项目中其实已经有了自带了出页面它在哪儿在这儿？艾瑞里这两个页面就是错误页面，一个是404找不到资源，一个是500报错，那么我们需要把它放到特定的位置下，那么它才会自动的生效，放哪去？就是把 era、目录以及这样的页面的名字放到templates目录下就可以了，而且我就直接拖拽就把他拽到这个位置来， Ok拽过来就这样就行了，你注意这个错误页面所存放的路径一定要叫air，然后这个文件的名字一定是错误状态，作为文件的名字404 500这样的就这样就可以了。

然后如果说我们现在程序中有问题，它就能够起作用。这样404好说我们随便瞎写个路径，就404 500的话我造个错，这样我在 message control这里访问，会画列表的时候，我人为造个错，而且inter点y的二ABC，你试图把一个字符串ABC字符串转成整数，肯定会报错的。

好，我们看一下目前这两个能不能成功，我把这个项目启动一下，启动好以后，那么我打开浏览器访问一下，先访问首页，没有问题，然后我瞎写个路径，比如首页加个ABC，没有这个路径，咱们项目中对吧？

没法去响应你回车，其实它就跳到了促页面，但是为什么没有显示对，是因为咱们这个错误页面，我刚才没有对它做模板的配置，这个得配一下。

忘记了配一下好。

首先我先声明 time leave，好，然后静态资源要配一下，不然样式不对，然后 header复用。好再看这个错误页面非常简单，中间就有一个内容区域，里边就摆了一张图片而已，这个图片路径你要把它处理一下，其他的什么都没有，给一个错误提示而已，好，这个地方也要处理好了，404页面处理完了500也是类似的，我把它也快速的处理一下，这句话copy一下。

好，然后手写黑的，我copy然后也是一个图片，处理一下尾部没有任何处理的东西，这要处理一下好，处理完以后我重新编译一下，编译好之后打开浏览器，我再刷一下这个路径，刷新，你看因为这个资源不存在，所以它自动的就跳到了就404出一面，然后给了这样一个提示，避免说报一个一个非常乱的让人无法识别的错误消息，这样的话比较好看一点。

好，这样我再回到首页，我再去访问这个消息，我一方面消息肯定会报错对吧？看看会怎么样点。这个消息本来是应该报错报一大堆错误提示英文的，但现在它跳转到了500点html对吧？这样体验就好多了，即便是错误，那么也是要给用户一个清晰直观的友好的提示，而不是说一大堆像乱码一样的东西。

好，这是它 Spring boot它自动的给我们做的一个处理，但是这个处理还并不是百%符合我们的预期，你像404这个倒ok了，你找不到资源就是给你一个提示，也没有什么更好的办法。

500就不一样，500就意味着我服务端报错了对吧？我报错的时候我是不是得最好记个日志啥的，好以后好分析对吧？

所以你直接就跳转页面，这只是表面上的一个处理，我们内在需要记录日志还没有处理，那么要想我们做记录日志这样的行为怎么办？那么spring它有统一处理的方式，那么spring它给我们提供了这样一个注解叫controller，but west控制器的通知，注解用来干嘛？它用来修饰，主要是用来修饰controller，它是controller全局配置类，说白了注解是用来对control来做全局的配置的， Ctrl了我们全局统一的配置以后，那么无论是哪个CTRL了哪个方法报错，我们都能统一捕捉到，统一处理很方便。

好，那么我们在这样的配置类里需要可以对CTRL做如下三种全局配置，一个是可以处理这个异常，一个是可以绑定数据，一个是可以绑定参数，那么如果你想处理异常，需要用到注解，写一个方法，在方法上加这个主角。

如果你想绑定数据写一个方法加这个主角，如果你想绑定参数写个方法加这个主角，所以说你还要结合着另外三个主角去实现了这三个功能。

这个我一会演示，我先说这俩，简单说一下，什么叫绑定数据呢？比如说我肯抽了有很多请求，要请求当中要用到同一个数据，给这个模板，我需要往帽子里装同一个数据，那么我可以利用注解加一个方法，然后给这个猫的统一绑定这样的参数，所以说它的作用是给model绑定统一的参数给所有的CTRL用，那这个data band的作用是这样的，就是说咱们页面向服务器传参，那么会被自动的做转换，会被自动转换，你看我们传的配置里边的参数，它自动转为配置对象的属性，他凭什么做到这一点的？

其实是spring mvc它底层有很多内置了很多参数转换器，那么你传的参数它去判断这个参数应该转成什么，它自动做了判断，自动调了参数转换器，万一说我们程序当中默认的参数转换器不够用，你有一个全新的类型，特殊的类型需要特殊的处理，那你可以制定一个转换器，然后用data banner把它注册上，是这样的，当然那么这两个注解目前我们没有需求要用，所以我课上也就不掩饰了。

然后如果日后你工作时需要用到的话，你去查查手册，它们的使用也很简单，而且他们俩的使用其实和 exception handler大同小异。

好，我接下来重点是演示就是说我们利用它统一处理所有control的可能发生异常。好，我就打开我的开发工具，首先这样，首先我在home control的加上一个请求，为什么？因为你想我服务器我controller发生了异常以后，我统一处理，我记了日志，处理完以后我干嘛去，我得去到500那个页面，这个时候因为是我们人为处理的，我们需要手动的把它重定向过去，所以我需要提前把500那个页面访问请求的访问给它配一下，增加一下请求的处理，我在 Home control里加一下很简单了，我就写上一个request，买品声明一下，它的路径防路径，因为是错误的页面，所以我叫艾尔。

然后 master等于 request，第二get获取错误页面。这里边其实没啥，就是get air配置就完了，然后你直接返回页面的模板的路径就可以了，它就是l然后500就行了。那么除了在我们一会要写的配置类里要用到这个东西以后以外，将来其他的地方可能也会用到这个请求，所以我们提前写好是为了以后的复用。好，接下来我就要利用刚才所说的这个东西， Ctrl的y声明一个CTRL的全局配置类，然后所有control的异常做统一的处理。

那么我需要新建一个通知类，或者你理解为CTRL的配置类都可以。那么我这样我在CTRL的包下新建一个包就叫advice通知，然后我在包下新建一个类叫exception，but west那么这个类你需要利用刚才所说的注解加以声明，CTRL or the west。

好，这样的话 spring容器会组件会扫描所有的病范围太大了，我们通常需要进行一个限制，让它范围小一点，可以这样写，I do tensions就是注解等于可以等于多个注解，但你写一个也可以，等于其实我就一个 controller。点儿好像写错了。对他 Control了点class。

这样写的意思是组件注解他只去扫描带有CTRL的注解的那些病，说白就是CTRL的组件了那些组件了对吧？所有的带有CTRL的注解的组件都能被扫描到，都能统一处理。

好，然后我们在这个类当中需要加一个方法，然后要处理所有的错误的情况，这个方法这样写方法之前需要加一个加一个注解，加注解，比方说这个方法是处理所有异常的方法，那就写上exception，handler，然后你括号里要写啥，你要处理哪些异常，可以写大括号，里边写多个数据，你可以处理多个异常。

我这样写 exception、点、class， exception是所有异常的父类，比如说所有异常我都用它来处理就完了，这个方法必须是公有的，然后没有反馈值，方法名随便取，方法名无所谓，我叫憨豆，XP处理异常，这个方法上其实可以带很多参数，你可以去 spring手册上去查，太多了，咱们也没有必要挨个去看也记不住。但是通常比较常用的就三个，一般这三差不多就够了。

一个就是exception就是CTRL当中发生的异常，当发生异常时它会把异常传过来，我们可以处理这个异常。然后处理完以后，在处理过程中我们可能会用到request，response去处理请求和响应。所以我再把 request声明一下，再把 response声明一下，有了这三个参数基本上就能解决绝大部分的问题，当然我这里要干什么？我这里不是要记日志对吧？我还得把日志逐渐的实例化一下，突然位置期待 Final，然后 get log当前类点class。

好，那么当这个方法被调用的时候，就说明肯定control发生了异常了，我们没有什么好说的，就把这个异常记到日志里就可以了，我就log点air，然后 e点get message。然后这里面最好前面加一个前缀，说明一下这是怎么回事。说服务器发生异常，后面是异常的一个概括，这只是一个概括。

我希望把异常非常详细的站的信息都记录下来，这个也好办，我们需要便利站的信息。一点get stick trace。这是一个数组，每次我们得到的是一个stick trace element。Stick。Trace element。好，遍历这个数组每次得到这样一个对象，每一个im就是记录了一条异常的信息，而且它是有序的要把它记录下来，就是element点to stream就行了。

好，那么记完日志以后，我们需要给浏览器一个响应，我们要重定向到刚才的错误页面，但是你注意这个地方还要再额外再处理一下，因为什么页面访问浏览器访问这个服务器，它可能是普通的请求，希望你返回网页，你重新降到500没有问题，那么浏览器访问服务器也有可能是异步的请求，他希望你返回一个Jason对吧？

这个时候你重新上到这就没有意义了，他要的是Jason，不是html对吧？所以你要区分来处理。

因此我们这就要判断一下我们这个请求是普通请求还是异步请求，这个怎么判断？这里我介绍一下大家把作为一个固定的就是技巧或者经验记录下来就可以了，你可以通过request来判断，因为我们判断请求的方式 Request，第二hide，我们从请求的消息头里去尝试获取一个值， get hide k是这样的，是x杠，这个一定不能写错了。

Request ed requested with请求的方式是以什么方式来请求？

返回的是一个死病，这个死病我叫我就按照 k来取名 x request with，那么如果说返回值它等于这样一个值，xmxml HTTP request一定不能写错， xmlhttp request，如果是这样一个值就表示说这是一个异步请求，因为你看这个请求它是以 xml的形式来访问的，就是他希望你返回的是xml，我们知道只有Eva请求他希望你返回xml，当然你可以返回Jason其他的数据对吧？

否则普通请求期待的是你返回HTTP，不是html好，所以我就判断一下，如果说它等于变量，就说明这是一个异步，请求这个时候我就要响应一个这么差就response点， site，content，type，这里有写application嘎？

其实你可以写杰森，那么如果你写的是Jason，那么我们向浏览器返回一个字符串，浏览器会自动把它转成Jason对象，也可以这样写 play，比如说我们向浏览器返回的是一个普通的字符串，但是这个字符串可以是阶层格式，那么浏览器得到以后需要人为的将这个字符串转换为 GS对象就是用到了点plus Jason那个方法，这样我们所有的应用当中，我们所有的请求当中都返回一个普通的字符串，但是这个格式我们确认是Jason就可以了，我们这种方式，然后我们手动转，然后写上叉site，等于utf-8声明，字数集是有贴吧好支持中文。

好，然后我要获取输出流相关输出一个字符串，它就print writer，writer等于response点get right。好，当然了这句话我们需要处理异常，这个异常你可以好，直接抛出去，然后我就向外输出内容， right？点right？输出一个阶层字符串，这个我们可以调用community uq那工具得到这个字符串，因为报错了，返回的扣的是一，再给一个提示说服务器异常，好就行了。

好，这是一种情况，否则普通请求我就要重定向，到抽页面我就为sparks点send redirect，然后我通过request点get context pass，获取项目的访问路径，然后加上l这一级路径这个就可以了。

好完成以后咱们就可以做测试了，有人说这就可以做测试了吗？是的。我们用组件的好处是什么呢？我们不需要对任何一个controller去处理，不用在任何一个controller controller上加代码，就能够解决他们的问题，这就是spring的强大之处。

好了，下面我们测一下，但首先我这个程序中得有这个错误，刚才 Mac这里有一个错误，这是普通的请求，异步请求当中我也造一个错，这样我们好看一下它的一个效果，异步请求不是发私信是异步的对吧？

在这里我也造一个错，还是那么写 y62ABC，好，然后我重新把这个程序编译一下，它重启了，重启以后我打开浏览器，然后访问首页没问题，你访问比如说个人主页我们还没实现，所以他报错了，没有这个路径 html，比如说访问账号设置，这也没问题对吧？

就是访问正常的，没有报错的都没问题，下面我报个错，我点这个消息点消息，报错，然后他有没有记日志，你可以看一下控制台，你看控制台l级别日志有了，然后对应的配置文件里日志文件里也有，我就不细看了。

好，下面我再测试一下发私信，不过消息这个页面我打不开了，这样我把这个消息页面那个错误去掉。好能打开它去掉，然后再重新编译。

好，回到这个页面上点首页，点消息这回可以了，然后这里我要发私信了，比如说我要发给AA内容随便写，然后点发送服务器上报了个错，那服务器有没有记日志也有， Lg的日志没有问题。好，那么经过测试发现这种方式非常的简单好用，这就是spring它的强大之处。当然你最终别忘了把这个错误去掉，恢复成正常的状态。好了，那么这次课我们统一处理异常就搞定了，咱们下次课再见。