41-Spring整合Elasticsearch.mp4

这。

次课我们来学习如何利用spring整合elastic，那么整合的方式也并不麻烦，大致分为三个步骤，第一步你需要先把这个包导进来，那么这个包是斯文布的提供的叫spring boots大特带特。

Last打完包以后，我们需要在 spring布的配置文件里对 es加以配置，那么有必要配的是两方面，一个是集群的名字，cluster name，一个是集群的节点 not那么配完以后就可以调用 spring给我们提供的关于一s的API去访问一s的服务器了，那么它给我们提供的API主要是两个方面是一个类叫 elastic search template，那么我们可以调 template去访问es它里面提供了各种增删改查的方法。

然后第二个我们也可以等使用这个接口叫analytic search repository。那么我们使用这个接口的时候，需要定义一个子接口来继承于它指定我们要访问什么样的数据，然后简单的声明以后， spring会自动的实现这个接口，而这个接口当中又包含了各种仿es的常见的方法，所以说也很方便。

那么怎么说就这两个API的关系是其实接口的实现，其实它底层依赖于 template，但是我们使用接口的方式会更方便，所以我们一开始尽量去用这个接口，那么但是在某些情况下还不得不用 template，所以这两个API都会用到我课上，都会给大家做一个演示。

好，下面我们就来实现这几步，我们把配置好以后，我们写主要是写测试类，然后的话在测试类当中演示如何去访问es如何去对这个帖子进行搜索，我们把我们数据库当中的帖子存到一s服务器里，然后去搜帖子。

好，那么我首先要打包，我先搜一下，我已经打开了 maven，reporter到com这里你要输入spring elastic search搜一下。好，那么在这个结果中我们能在这能找到我们所依赖的包点进去，好，我选一个最新的版本，然后把它掏一下，粘贴到这个泡沫点xml里，稍等一下，它在下载。

好，那么因为这个包是spring布的提供的，那么在spring布的负泡沫当中，它对技术工具的版本做了一个声明，所以说我一般情况下像这样的包我习惯于把 word去掉，然后就直接依赖于它附泡沫中所声明的版本，因为那个版本是他经过详详细的测试，没有问题的。

好，这个包打完以后，接下来我们需要做一些配置，我们打开 practice配置文件，那么在后面追加一项配置， es的配置我们主要是针对叫依赖txt类进行配置。好，然后刚才也说了主要是要配两项，一个是集群的名字，这样写我就直接写出来了，spring。

第二data，第二 elastic shirt。 Cluster。Name。

然后。

集群的名字，我们上次课在装 es的时候，我们不是改了它的配置文件里，我改了一下那个名字叫脑壳的还记得写上正确的名字，然后接下来我还要去配这个节点，因为一s它是集群式分布式部署有很多节点，当然我们这是单节点，只有一个，我们需要声明节点，spring date这copy一下，上面写错了，一来是txt，然后

 cluster knows等于。

这里我只有一个节点，你要写的是这个节点的IP地址，冒号和端口，我们本机的IP就是12700点儿1，当然也可以写local cost，127写错了，它和local house的等价，冒号，注意我们上次的访问 es的服务器用的是9200端口，那么你注意 es它有两个端口，9200是HTTP访问的端口，它还有一个9300的端口也是默认启用的，那么9300是TCP端口，我们服务我们应用服务通常会用9300 TCP去访问它。

好，那么配完以后，接下来我们还要做一个小的事情，做什么事情我需要解决一个冲突，就是一来是txt，它的底层是基于native，然后我们之前所安装并使用的rise，它的底层也基于 net，那么这两者在使用native在启动native的时候有冲突，所以冲突主要是体现在 es它的底层的代码上，有个地方有点小问题，我们需要稍微做一个变通，具体哪有问题我给大家看一下，有一个类叫做night run time，90 run time。

好，那么我登录了一下SARS，下载一下源码，方便看好。

然后这一类当中有一个静态的类类当中有这样一段代码，你看set available processors就设置可用的处理器，然后你看这块他抛了一个异常，当 available process是不等于0的时候，它抛异常，然后有这样一个提示，如果说我们就现在配到这种程度，我们直接去启动的时候就会报这样的错误。

他认为 processor net的处理器已经被设置好了，被谁设置好了，其实 reds启动的时候就已经做过设置，他认为重复了，它就不启动了，就会有问题，那么报这个错那就得看这段代码是谁调的，这段代码其实这部分程序其实是由es Diao导致的错误， es哪调我们再看一下。

还有个类叫94。You tell us下载一些源码，这个类是es底层它封装的一个类，然后它这里边有一个方法在这个方法之内它就掉了。你看掉了90run time set，一旦这句话被调，基本上它里边就报错，因为它传的数据不等于0，因为 reds已经启动了 net，已经初始化了net，所以这个数不为0它就报错了。

我们希望它的别报错，因为你怎么说 red is它依赖于net，你依赖于net，这个都可以依赖，你不要因为人家依赖了，你就不能依赖，所以它底层的处理它没有考虑这种大家都依赖的情况，有点这块他处理有点狭隘了，好怎么解决这个问题？

他也留了一个口，你看这个地方有个开关，那么如果赛的条件不满足，比如说它返回force，这就是return下面就不会被执行，就不会被报错，这报这也报错。但有个开关，这个开关如果force就不值钱。好，这个开关是什么？它会读取系统的一个属性，属性的k是它你只要把它值设置为force，就不会执行下面的程序，就不会执行这个检查了。

好了，所以我们需要做一件事，就是在我们的服务启动的时候，在比较早的时候把它设置为force，好，我在哪做？我在这里做 Application。你要知道这是我们整个应用的核心的入口的配置类，配置类是最先被加载的对吧？

那么我在这里写上这样一段程序叫post construct，大家应该还对注解有一点印象吧，就是说注解是用来管理这个病的生命周期的，主要是用来管理病人的初始化的方法，那么它由注解所修饰的方法会在构造器调研完以后被执行，所以通常是初始化方法，我在 bin的初始化方法里去设置参数足够早，因为这个病人是最先被加载的，这里我写个注释写清楚，是解决 net。

启动冲突的问题。

那么。

设置一个系统的属性， system点set12天，key刚才我call了把它设置为 force就行。

注意这个force它需要的是一个字符串类型参数，我就字符串force它底层的会转，他用的时候会转型我们就不管了。

再一个解释一下我们这个处理方案是从哪找到的，从刚才这个 You tubes里边找到的，所以说你可以去看94you twos，然后它里边有个方法，这个方法。

好，那么你课后可以自己去看一看它的这一个逻辑，这是我我一开始使用 es的时候也是这样，没有注意到这1.1启动就报错，后来的话跟踪代码跟踪到这，发现这个问题好，在他留这么一个开关了。

好，现在你看我已经把包也倒进来了，配置也配置好了，那么隐藏的坑咱们也做了一个解决。

那么接下来我就要开始写我们与需求相关的代码，我之前我也说了我们要做什么，我要把我们现在数据库里存的那些帖子想办法再存到 es服务器里，然后我们去 es服务器搜索帖子，那么有两种方式能够做这样的事情，一个是使用 template，一个是使用 repository。

那么我说了这种方案简单，我们优先用这种方案，当有些需求它不好解决的时候，我们再尝试用template，好，那么用reporter这个方案，它所有的代码实现类都是自动生成的，但是生成之前我们需要做一些配置，需要告诉他那我们就怎么说帖子这个表和es里要存的索引，它的索引不是和表相对，它俩之间是一个什么样的对应关系，然后这个表存到es里变成索引的时候，那么每个字段对应是什么样的类型，用什么方式去搜索，这些你都要去做配做配置。

那么这个配置它不需要我们写像麦迪斯那样的x面文件，我们通过注解就可以。

好注解写到哪上去，要写到实体类上去，因为我们是针对帖子的操作，所以我打开 discourse post在这上通过注解进行一些配置，首先我需要在类上加一个注解，叫document， document里需要声明，index，name等于什么？需要声明，type等于什么？然后通常还要声明，shock等于什么？ Shock等于什么？还要声明的。 Replicas等于什么？

这俩是数字，不是字符串，就是说 spring整合的 Es它所提供的这项技术，它的底层在访问es服务器的时候，它会自动的将我们的实体数据和es服务器里边的索引进行映射，你实体映射到哪个索引上去，映射到哪个类型上去，映射的时候你需要创建几个分片，几个副本你在这里指定，那么我们将来调 API的时候，如果它检测到没有索引，它会自动传你索引，然后没有分片没有副本，它会自动根据你的配置去创建，然后的话再往索引里插入数据，所以说我们需要做这样一个配置，这个配置就很好配，你首先给索引取个名字，实体类叫disc，post，那么索引的名字我希望这样取叫disc cast post全消息就可以了。 Discourse post，然后 tap，因为现在的 es版本 tap被弱化，将来会完全被废弃，所以我们当前的版本就把它写为一个固定的dog，就完了，就不用太管它，然后分片你随便这里我写6片分6个区域，副本你备份几份三份，当然你随便配，其实我们往往是根据这个服务器的处理能力来配，这里我就随便写几个，不要写太多就行了。

另外你这样配死人就知道了实体和索引有一个对应关系，那么实体当中有什么的属性？它和索引中的那些个字段是怎么样一个对应关系，所以说你在属性上也需要加以配置。

好，那么第一个是ID整个是组件，这个ID的话我们通常会加一个ID，主角写错了，加一个ID注解，那死不愿意看，这是ID，那么在建索引的时候它也会把这个数据存到 ID的字段上去。

好第二个是user ID，优质ID是一个普通的字段，我们加一个feel，然后里边要声明它的类型type，然后是防废物的态度，接口的常量，最后的tap点怎么不自动弹出来了？ Feel的tap点儿，inter整数。好，然后其实其他的都好说，重点是 Title和content。你想一想我们搜帖子搜什么？我们主要就是搜这个标题和内容对吧？从这里边搜索我们想要搜的匹配的关键字，关于 Title和content它的配置就尤为重要，当然它也是feel的，它也是普通的属性，但是我们声明的类型要等于 feel the type点，text，文本，文本。

好，除此以外还要说明另外两个属性，一个叫analyzer等于什么？还有一个叫奢侈。来者等于什么？这是解析器怎么说？存储的时候的解析器，还有搜索的时候的解析器，什么意思？解释一下。举个例子，比如说我们要往 Es服务器里存的抬头，要存的抬头是这样一句话叫互联网校招。那么他存的存完以后，他需要给这句话建立索引，其实就是把这句话提炼出关键词，用这个关键词来关联这句话，将来我们通过这个关键词去搜的时候，因为有关联就能搜到这句话，就能搜到这个内容。

你想他在存的时候是不是应该尽可能的把这句话拆分出更多的关键词，创建出更多的词条，这样的话这句话能够就增加它搜索的范围是吧？

应该是这个意思，所以在保存的时候，应该是把这一句话把内容尽可能地拆分成多个词条与之匹与之匹配，增加搜索的范围，这个时候我们需要用一个范围非常大的一个分词器，那么我们所安装的中文的分词器，它里边有这样一个功能的分词器叫ak。

杠 max down word。

你看这个单词也很容易理解它的意思，最多的单词，他会把这句话拆分出最多的单词，然后与这句话建立一个索引，与这句话去匹配，增大它的搜索范围。

好，好比如说你这句话存起来了，将来我要去搜内容的时候，比如说我搜的时候，我恰好输入的搜索条件就是互联网校招，你想我搜的时候互联网销售他有必要说拆分出那么多词吗？当然有人说你 max word拆分这句话能拆分出多少个词，我给你举个例子，比如说他可以这样拆互联网一个词，互联一个词，联网一个词，网校一个词，校招一个词，大概五六个，其实这都是指互联联网网校校招互联网对吧？

这都是可以成独立的词的，它给它拆分成五六个词，然后与这句话相匹配，但是我们搜索的时候有必要这么猜吗？你搜索的时候肯定是我们这句话反映出来的，我想搜的是和互联网有关的内容和校招有关的内容。如果这两项都匹配最好对吧？匹配一项也凑合，是这个意思。

所以说我们搜索的时候不应该采用这样的分词器，你没必要把它拆得那么细，而是我们用聪明的方式能够猜出你意图的方式去做拆分的稍微粗一点就可以了，拆分的符合你的预期一点就可以了，所以说这个时候我们采用另外一个分子器叫ak smart，一个聪明的分子器它会洞察你的意图，拆分出尽可能少的，但是满足你需要的这样的词汇。

好，总之我这里写的这两个字符串是什么？是两个分词器的名字。总之我们在存储数据的时候采用的是分词器，能拆分出更多的词来增加搜索范围。我们在搜索的时候采用的是聪明的分词器，那么拆分出较少的词汇，然后满足你的需求就可以了。

好，这是 Title，你title这么处理，再举个例子，刚才比如说 smart，我搜的时候，他可能只拆出互联网校招两个词就够了，别的他就不会拆这样的。

好，那么同理这个content也可以这样去处理，一模一样，它也是feel的，然后的话也是text也是存储是用分词器，然后搜索是如果有其他的可以被搜索的字段，我们一律这样写就可以了，都是这样写就可以了。

好了，然后再往后看，下面是 tap的话是个整数，整数其实和 uzid显然是一样的，对吧？好再来，然后下面是status，那也是这样的，对吧？好，然后下面是date稍微有点特别得单独写feel的，然后 tap等于feel the type点。这里不有date，恰好是满足日期的这么一个需要。好，再来，下面这个是整数还是它？然后这个是小数double，你就feel the type的double，然后这样就行了。

好了，到现在我就把实体类就配好了，实体类，我们加上这些注解以后，它和es之间就建立了联系，它和es它整个对象和es中的索引有关联，每一个字段，每一个属性和es中索引的字段类型之间是这样一个转换关系。

就很清楚了，那么有了配置以后，spring底层才能够帮我们生成对应的时间内好很关键，那么配置好以后，下面我们就可以去定义刚才我们所说的 Reporter接口。

好，那么我在dao这里边定义，但是我不在这直接定义我再建一个子包，因为毕竟访问一s和访问关于数据库还是有区别的。

它的实现方式也不一样，所以我单独建个子包，把它归纳到子包里，子包我就叫it社区。

然后在这里边我创建一个接口，选择接口，因为我们这个接口仿的是帖子，所以我取名叫discus post reporter。

这样的接口一般都叫什么repository，那么这个接口因为是数据访问层的代码，一s可以被看成是一个特殊的数据库，所以我们需要在组件上加上 reporter这个注解，不是map，那个map是my business专有的注解，而reporter它是spring提供的，针对数据访问中的注解，然后我们这个接口不用声明任何方法，我们只需要继承于一s它就是只不过给我们提供的默认的接口就可以了，继承于us take search。然后的话repost继承给他就行。

我们继承的时候需要加上范型声明，好，你这个接口我们要处理的实体类是谁？是discourse post，另外还要声明实体类当中的组件是什么类型整形，这样就可以了。

那么负接口当中它已经事先定义好了，对es服务器访问的增删改查，各种方法我们这样声明完以后，加了注解以后， spring会自动给它做一个实现，我们直接去调就可以了。

好，那么到这我们就可以用了，那么我们用的话那要做一个测试，看看好不好用，我创建一个好，那么我在这儿新建一个测试类，这测试类我叫Eli stake设施test，那么它上面需要加上几个注解，我从其他的内容去copy，那么因为我们访问一来是社区，我们的数据来源其实是来源买circle，我们从my circle中把数据取到，然后再准存到 es里，而不是凭空捏造这个数据。

好，所以为了从数据库里取帖子，我把迪斯卡斯普斯的麦克注入进来，这样我还要充满c口里取这个数据 discus boss的麦克这个变量，然后取得简短一点，对卡迪斯卡斯麦克。另外我们往 es服务器中存查数据，我们需要用到刚才的 report，所以也要把它注入进来，不可能 discounts poste repository，变量名儿我取得简短一点儿叫discus repository。

然后有些特殊情况，这个repost都是解决不了，我们还需要调用 template，所以我再把 template注入进来，elastic shirts，template，然后变量名不叫一来CK谈PK，简短一点。

好，那么在访问 es服务器之前，我想先打开 post曼，我们先看一下我那个服务器里它有没有帖子，相关的数据有没有索引？好，我打开 Post麦。

好，那么我要查一下9200，然后的话杠cat，然后这有一个现成的 index，我要看一下我现在这个服务器里有多少个索引，你看它目前只有一个索引test，就是上一个我所创建的目前并没有discourse post对吧？

那一会我们执行这个方法以后，看一看 disc pose的索引是不是被自动创建了，好知道此部分帮我们做了什么。好，我就回到刚才的程序里，我就开始写代码，首先我们要写的是什么？怎么去往一s服务器里加数据，添加数据，先把数据加进去。好，我写一个测试方法，别写错了。

叫test。音色插入数据，然后就调 Discard repository，那么调它的sale方法就可以插入数据，而这个数据这是插入一条，这个数据我从map里取到查到 disk us map点谁来把ID好，我得指定是用哪个ID呢？咱们看一下这个表， discard post ID。

我 order by iddesc倒叙一下，这数据还挺多的，随便找几个数据，比如说我就找这三条，241242243，我把这这三条数据插进去，好，我这就写241，这是一条数据插进去，然后再来第二条，第三条这就行了，反正就这样就能插入一条数据。好我就执行一下，然后的话看一看这个数据能不能被插进去。当然我们在执行插入数据的，它底层会换成这个命令，在执行这样的命令的时候，它发现索引没有，它会自动创建，我们上次跟他用post曼去访 Es服务器，也发现了这样一个现象，对吧？它会自动的，所以你不用去特意创建首页。

好，我就运行一下。好，那么运行完以后，你看它解忧那张没有报错表示成功了。

然后的话。

当然了你运行的前提是你要注意一件事儿就是说你你来CK设置服务的启动，我这之前启动好了。

好，下面我们再看一下普斯特曼，我再执行一下命令，你看this time is post索引就存在就有了，然后比如说我想再详细查一下 discourse post，我新建一个页签就页签，就把改一下this pass，post search我要查所有的，然后包的设置为那不传包的数据了。

好，然后执行你看它命中三条数据，分别是242243241没问题，好，这是每次执行 CEO方法是插入一条数据，然后还有一个方法是能够插入多条数据，我们再演示一下，插入多条数据的方式，我叫test insert list。

好，那么还是调用 repository，然后点CF二 CF二里你要给它传入多点数据，传一个集合进来，我们也可以通过 map来查， discuss member，然后 select，discuss posts，然后我们查的时候，这里是需要根据优质ID来查，然后还分页了。

好这样我们就着方法多插入一些数据，把我们表里的大部分数据都插进去，相当于一个数据的初始化，这样一会我们好去怎么说一会我们好去做。

搜索得有这样的数据，我要插入哪些数据，它是根据user来插入，你看 uzid尤其是前面这个数据，101102103，然后的话。

12。

然后131132133134等等我们就插入，其实到这儿了，往下大部分数据就进去了，我就又在ID处理到134差不多了，其他的我就不挨个处理了。

好首先是101数据比较多，然后从0开始100结束，其实他没有100行，就这个人没有100行数据，所以说这个人的数据就都有了，101。然后再来就是102的103的，然后是111的112的，然后是131132133134。好了，我这样的话一执行，咱们表里大部分数据就都过去了，执行一下。好，执行完以后没报错，我们再通过 Post慢再看一下，我再搜一下。

好，那么搜完以后你看他一共命中了141条数据，然后这里他没有全列出来，其实他只列了第一页10条数据，但你看这个数据确实有了变化是吧？有了变化我们不用挨个细看，确实多了很多了，但是他没有列举全，他只列举了第一页10条数据就行了。

好，刚才我们所演示的是添加数据，可以添加一个可以添加多个，那么如果你想对数据修改也是可以的，再演示一下修改test update。

好，那么我想修改哪个数据，咱们一先找一条数据，比如说就找231数据，然后我们先看一下post吗里面231这个数据，这样我把 delete关掉。

兔子关掉先不用了，然后我要去看一下231的那条数据， local house9200，然后当前是discuss post。然后 DOC，然后是231执行，你看它这个数据是叫灌水，新人灌水，比如说我就要把这个内容稍微改一下，我们看一下它能不能变好。

那么首先我先把这怎么改，其实改我们还是调 seo方法，把之前的新增的数据再覆盖一遍，就是改这样我把231这个数据再重查一遍。

discourse post。

等于迪斯卡斯麦克点谁来？克白d231，我把它查出来它是什么新人灌水，然后我要改一下它的内容，post点、site，content改成叫我是新人，然后使劲灌水。

好稍微改了一下，改完以后我再通过discourse，repository、点、sale， C5一个去保存它，那么它就会把原来的数据覆盖掉，这就是修改还是C5方法。好，执行一下，看看执行完了没报错，我们再通过post曼查一下，数据变了，表示修改成功了，对吧？好，这是修改，删除的话也很简单，只要调 delete就行了。

再来一个方法。

test，delete，

那么如果是3亿条数据，就是discourse、repository、点，delete，白底它自带一个方法叫得力的白底，比如说我要三231执行一下看看，好执行完以后看boss的慢搜一下，数据没了被删了，然后也有方法能查删掉所有的数据，但这个一般我们用的少，因为这太危险了，一下删掉所有的数据风险比较高，对吧？

但是也介绍一下，也演示一下 discus repository点，delete，就直接把所有里的数据就都给删了，好来执行一下，执行完以后我们再去post曼搜一下，设置一下，啥都没有。

好了，那么你看我们争三改啥就都演示完了，演示完以后接下来就应该演示搜索了，但是现在数据没了，没关系，我再执行一遍 insert，重新把这些数据插进去，然后这些数据就够我们去演示了。好，执行完这个数据就有了，咱们再确认一下，对吧？已经有了141条数据没问题。

好，下面我们再演示 es的最核心的功能就是搜索，这些只是说把数据存进去而已，搬运过去而已，最重要的是搜索的功能。

那么我再新加一个方法，方法名我叫test社区。利用什么搜索，利用 reporter进行搜索，就用接口进行搜索，那么搜索的时候，我们首先要构造搜索的条件，它有一个组件专门是构造搜索条件的，其实不只是条件，你搜完以后你要不要排序，你要不要分页？

并且搜索结果你要不要高亮显示，什么叫高亮显示？

比如说我要搜，我搜的时候我搜索条件是互联网，而你返回的一句话当中，你返回的这句话当中，比如说是这样一句话，这还是因特网，比如说你反馈是这句话，互联网求职暖春计划，那么你是不是应该把匹配的这个词给我变红是吧？得把它变红，那怎么变红？

其实不是说es能够把它变红，但是es能够把匹配到这个词前后加上一个标签，比如说这样的，他把互联网这三个字匹配到以后，它前后加一个标签，这个标签由你指定的，你想加什么标签都行，a b等等都行，比如说我加个em标签，互联网我写错了，有人说这就变红了吗？

可以的，因为你返回的结果当中这个关键词词条前后有这样一个特殊的标签，我们最终是要把文字放到网页上去显示，而我们网页上不是有css，样式文件里边我们可以写em它是红色的，它不就红了对吧？

所以说你来c测试还有能力把返回的结果当中匹配到的那些关键词给你点亮，做高亮显示，它实现的机制就是在这个词前后加上标签，那么你需要做的是文本显示到网页上的时候，你要给这个标签加一个样式就可以了，你注意好，所以说我们构造搜索条件要构造一系列的内容，一个是我们搜索这个关键词要存进去，要构造进去，然后排序的方式要构造进去，然后分页的方式也要构造进去，还有高亮显示怎么做，也要构造进去，把所有的搜索的要求构造进去以后，你调一下它的方法，他就给你返回你要的结果，这样的。

好，所以我们花的很多精力是构造查询的条件，那么我们利用的是这样一个接口。

叫社区科瑞。

这是spring给我们提供的一个组件。

设置carry等于那么它有一个实现类叫native native search carry，其实它的实现类是native search carry，但是它还给我们提供一个工具类叫native search cover builder，这个builder能够构建一个native search cover实现类，用它比较方便，所以我们用 build构造一个接口的实现类。

好，我new的 build怎么去构造也很简单，首先就调这个方法叫 with carry，然后这个方法还是返回对象build你在with carry。

好，可以无限的位置下去，好，这个位置块是构建搜索条件的，搜索条件我们另外一个对象去构造，整个搜索条件还需要另外一个对象去构造对象叫 carry builder。

然后我们比如说我想搜什么，假如说我输入了搜索条件叫互联网寒冬，我希望能够既从开头里搜，又从content里搜，就是我是一个多字段的搜索，是一个全文的搜索，这个时候得这样写， quiet builder点没有引入是吧？

稍等 carry写错了是carry builders，我说怎么没有 carry builders点点儿叫Martin max carry，你看 Martin max carry我们上课写利用 post曼执行，搜索的时候不是用过 Martin max carry就是多个字段同时匹配对吧？

然后 carry你需要传入几个参数，一个是你的搜索的词条关键字，我是互联网寒冬，很显然他拆的时候会拆两次，一个是互联网，一个是寒冬。

好，然后我要搜的是哪些字段，一个是开头。

一个是content，就这样，好，搜索条件就这样，就构造好，好像是不是少了半边括号，我确认一下写错地方了。

好，当然你也可以写更多的字段，我们只需要写两个 title和content，然后写完以后你可以继续构造完搜索条件以后再去构造排序的条件，搜索完结果以后我按照什么来排序，那就位置 sort排序的条件我们用什么来构造是 sort builders，查询条件是块儿多的，这个是salt的，然后点儿feel。然后 feel的是out，我希望按照什么字段来排序呢？

我们看一下这个表，这样我希望按照tap status以及死杠来排序，因为我们最终按照这三者来排序的， type意味着它是否置顶，这个status意味着它是不是加精，死杠意味着这个帖子它的价值，我们优先按照这个置顶来排序，如果你置顶的话，它肯定是排到最前面对吧？其次是按加精，如果你没有置顶，但加精它比一般的帖子要排前面去，最后如果说你既没置顶也没加精，我们或者说你都置顶都加精了，我们再看 score，这样的是按照这三个字段依次来排序。

好，我们每个sat只能指定一个字段，首先我是优先按tap来排的，然后 tap。

点你。

是按tap是正序还是反序，我得order。

然后。

 sort order点disc，我是倒叙，这样的话置顶的会被排到前面去，写法是固定的，把它记住，同理再来，我就再来一个copy一下，我刚才这个排序说错了，我是要按照tap10-，然后和时间来排， tap置顶肯定是优先把它排到前面去，然后这个状态其实状态加精会被核算成一个分数，它在分数里体现，所以其次按分数来排，你加精的话这个分是比较高的。

如果万一是两个帖子分分一样，我就再按这个时间来排，是这个意思，刚才我说错了。所以第二个是 scar，好，scar的话，我也是按照倒叙把分高的排前面去。

好再来。第三个如果说你你这两个帖子它分都一样，我就按照创建时间 create。

time来排，

然后也是倒序把最新的排到前面去。好，这是排序的规则，然后我们查这个数据不可能说一下，把所有的数据都查到，万一匹配个几万条你都查出来也太乱了，对吧？

我们就查按分页来查询，虽然你还得构造分页的条件，那就是这点位置，然后分页 k宝，然后构造分页的条件，用配置request，点of，然后我们需要传两个条件，一个是你当前要显示你要查的是第几页，我写的0是第零页，其实就是第一页，它从0开始，注意第一个条件指的是第几页，第二个是这一页，你要显示最多几条数据，10条，然后再来点儿位置 high light，其实feels就可以了。

就是说你要指定哪些属性，哪些字段你要做高亮的显示，你要对哪些这个词进行高亮显示，你怎么高亮显示是反馈结果变红的处理方式。

 Highlight feels其实因为你搜索的关键字可以拆分成多个词，你希望反馈结果里哪些个字段，哪些个词它是高亮的，这里可以指定多个字段，那么每一个字段我们是用这样的方式来指定 new还赖的 builder，我们利用 builder里面有一个叫field的对象，我们利用它来构造高亮显示的字段，首先是对抬头字段我需要做这样的处理。

抬头字段当中我匹配的那个词，我这高亮显示我不是说了前后加标签，标签你来指定 pre Tex前置标签，我希望是一m然后再点。

post。

后置标签，后面的标签，我希望是em结尾。好，这是一个。

再来一个，因为我们还有一个字段也可以匹配CTRL对吧？字段中如果有这个关键词被匹配到了，也是这样的，前置是em后置是em结尾one。好，那么当我把高亮显示字段也配好以后，最后别的就不用了，这些就够了，然后的话我们就调用 Build对象的一个点build的方法，点build的方法一执行，那么整个它就会返回 search carry对象的接口的时间内，那么就可以了。

好，我终于要把这个查询条件构造完了，虽然说第一次比较麻烦，以后就方便了，因为这个格式基本上就你可以复用，可以copy，在基础上改就快了好。有了以后我就查了，查的话就是分页查询怎么查呢？ Kiss reporter。

点。

search你。

把这个search carry传进去，它就能帮你做分析查询，返回的是分页的数据，它的分页的数据利用一个配置对象进行封装，这个配置不是我们自己写的配置，是人家给我们提供的配置。

这个好，然后配置里面它直接存了，实体是多个实体 this cost，你可以把配置看成是一个集合，它里边封装了多个实体类是这样的，当前这一页的实体类都放到这里来。

好，那么通过这个配置对象我们得到很多数据，我把它显示出来给你看一下，首先配置点get total elements就是一共我们查到了多少条数据，一共有多少条数据匹配，好，再来 page点get total配置。按照我们当前的分页条件一共有多少页？

好，再来配置点get number。当前我们处在第几页再来配置点get Set，每一页最多显示几条数据。

好，最后再来最后就是我们要看配置里的数据了，因为它里面封装了多条数据，我们到循环遍历。

 discus post post配置这个配置是可以直接遍历的，它应该是实现了某个接口看一下，它继承了你看它其实继承了艾特瑞宝接口，所以它是可以被便利的关掉回来。

所以我就便利了它便利的时候，每次遍历我把这个post打印出来，你注意这个post是我们从一s服务器里搜出来的，好了，我就来执行一下这个方法。

好，那么我们看一下这个结果，首先你看他返回说一共有111行数据是匹配的，然后一共是12页，对不对？对的，因为我们一共111条数据，每页显示10条，那可不就是12页，然后当前处于第零页，每页显示10条数据这都没问题，后面它是显示10行数据是10行吗？12这是第二行。3456789 10没问题，每一行都包含相关的关键字吗？你看互联网，互联网互联网这都开头有互联网可能就匹配。

这个的话开头里面它没有互联网，但是它的内容里有互联网，对吧？当然我们还有一个词是寒冬，它会拆分出寒冬这个词，是不是有一些帖子里有寒冬呢？

你看还真的有寒冬，所以说有很多是这两次都匹配的，所以这两次都匹配，它会放到前面去，第一页你看都是尽可能都是两个词都匹配的，再往后可能有的内容只匹配一个词， es很聪明，他把两个字都匹配的优先排到前面去好了，但是对再看一下这个结果。

还差点事儿，但是有人说我刚才看寒冬也好，对吧？还是一个互联网也好，你不是说它会前后加一个em这种没加。这里我要说的这个问题就是怎么说 Reporter它的底层的默认实现类，他在查询结果的时候，他确实把es返回到带有标签的，高亮显示的内容已经返回了，但是他没有把这个内容合到这个结果里来。

就是es给我们反馈的结果里是包含一个原始的结果，就是你匹配到的结果。

还有是高单独它会把高亮显示的部分再给你，它是两份数据，你需要把这高亮数据整合到原始的数据里做一个替换才可以，但是它默认实现了底层没有做这样的事情，那么你跟踪源码的话能够看到这一点，具体来说源码是怎么回事，它的底层 reporter的底层，你跟你跟踪设置方法，它的底层是调用了us take，我先这样 us take time play的。

点carry for。

配置它底层是调了这个方法，然后一共是要三个参数这个方法，一个是search carry，然后还有一个是class，就是说你要查询的是哪个类型的数据，class要传进去。

第三个它要传这样一个类型的东西叫。

 search。

 without a map。当然我这是一个事例，我的助调我是想告诉你，一 repos它的底层是调了他们的方法去查询数据查到的数据，由这个map进行一个处理。

如果你要把这两两份数据组装在一起的话，你要用 map进行处理，但是他没处理，他们利用 map去处理。

这没办法。

所以有这么一个小问题。但我先解释一下它的底层获取到了高亮显示的值。

它。

的底层获取到了高亮显示的值，但是没有返回，他没有做进一步的处理好。

那么鉴于这种情况怎么办？你要么你去重写他的某些方法，那就很麻烦，要么我们干脆就不用设置方法了，我们就用report用 Template的方法，我们直接用这个方法就完了，对吧？我们直接利用这个方法就可以了，反正它底层也是调这个方法。

好，那么有人说你干脆就一开始就用，我想让你看一下还怎么说，这也是一种方案，只不过这种方案不完善，但它的这种方案我们能够通过它看到它底层的一个实现机制和缺陷，然后我们自己去解决它，这不挺好的是吧？

好，接下来我再写一个测试方法，然后我们利用time类的去做搜索，看一下效果怎么样。

 test search by template。

那么我们利用template来查询它，也需要我们传入 search carry，这个search carry我们可以还是利用刚才的智能代码都不用动，一模一样，

好。

有了它以后，我要用他们做查询，怎么查其实也不难，当然它返回的也是，它返回结果也是配置也是它那就是配置等于analytic template。

然后第二发瑞所配置，这个方法需要我们传三个参，第一个设置carry，第二个是实体类型 discuss post点class。第三个是社区伪造的map，这是一个接口，我们可以自己实现这个接口，然后的话在接口里去处理这两部分结果的这么一个合并的问题。

我在这里做一个匿名的实现 new然后的话。

社区。

伪造的迈克尔好，他把方法的自动把我加上来了，总之这段代码执行完，就这段代码跨日方配置它会得到结果，它得到的结果它会自动的交给迈克去处理，迈克是得到这个参数，它可以利用这个参数去处理这个结果，就通过它能得到所有的结果，这样的，然后把结果做一个封装返回就可以了。好，我们得到配置以后后面怎么用，其实和刚才的用法是一样的，你智能代码也可以拷过来，这个去掉就怎么用是一样的，就中间的这段处理稍微它稍微麻烦了一点，好，这里怎么处理我们来写一下。

首先我们先通过response去获取变量名太长了，我把它改短点，首先我们通过瑞斯帕斯先取到他这次搜索命中的数据，那就是get配置得到了多个命中的数据，得到的是这样一个类型search。

His。

好，设置his它里面封装的是多条数据，我们得判断一下你到底有没有值。那就his第二get total his，这是返回命中的数据量，总数如果小于等于0，那就意味着你没查到数据，如果没查到数据我就直接结束了， Return now完了。

好，那么如果不小于等于0，如果是大于0的，就说明你命中的数据我就需要做处理，我怎么处理呢？

我最终要把这个数据怎么说封装到一个集合里，然后返回这里我声明一个集合，技术里装的是discourse，好，然后我需要遍历命中的数据，然后把数据找到自己做处理完以后放到集合里就可以了，我要遍历命中的数据，每次遍历我们会得到一个search hit。得到一个命中的数据。

好。

那么每得到一个命中的数据，我要把这个数据包装到实体类当中去返回。

好。

所以我实例化了，实体类我们就从命中的数据里，它命中的数据的形式，我们上着课通过post曼也看到了，它返回的不是 Jason格式的数据，那么在这个对象里它是把Jason格式的数据增长为了map，所以我们从 hit里能调用map得到每一个字段的值，我就取一下 hit点get SARS as map。

就是返回map形式的数据，然后再点get ID，我要得到组件，然后把它测试确认一下，我先把它透视卷一下，得到这个字符串，我先得到字符串ID，当然了我们POS的存的是整数，你存的时候再转一下就好了，点site ID，然后的话inter value of ID这就可以了。

那么其他的任何类型的数据你都可以这样先to string一下，把它转成字符串，然后存的时候需要什么类型再转一下，这样就比较方便了。

好，我就不废话了，我下面把所有的都这样处理一下。User ID。 get south as MAC。然后 get然后 user ID透视卷，因为他get得到的是一个object，透视镜一下，然后再转 post sad，优质ID好，这是优质ID，然后开头这是原始的开头，并不是抬头高亮显示我们需要单独获取，用单独的方式获取，有人说你直接获取高亮显示的抬头不就完了吗？这还不行，因为什么？有可能当前返回的title里，它没有匹配的关键字，那个关键字在content里，这title没有匹配，content的匹配了，有这种可能对吧？

所以我们这样处理，我先把原始的title渠道设置到实体类当中去，原始的高端的渠道设到 Pos里头去，然后我们再去看高亮显示的字段，有我们就覆盖，没有就算了，这样是比较科学的，好然后再来 get抬头吐死病，然后 post sat开头，这个就不用转了。

同理，空乘。

好，除了抗震的以外，还有斯特尔斯，然后是create time，我们需要利用一个date，然后我们需要这是一个这个字符串，注意这个字符串是它其实是浪类型的一个字符串，它不是年月日的形式，它是一个浪类型的，我们可以把它转成浪，然后的话再设置给 date。

就是说一s在纯日期类型的时候，它是把它转成了一个浪整数类型的字符串来存的，注意。

好，然后还有评论的数量。好到这儿我们这些字段就都设置完了，接下来就处理高亮显示了，处理高亮显示。

的结果，那就是说我们看一下它有没有返回高亮显示的内容，如果有的话是抬头还是content还是两者都有，我们把这个title和content相应给它覆盖成高亮显示的内容就可以了。

好，怎么获得高亮显示的内容也很简单， hit。点get，highlight feels。然后点get。

抬头我。

想获取与抬头有关的高亮显示的内容，我们得到的是什么呢？得到的是一个还来的feel，得到的是这样一个类型，这是一个字段，它是对一个字段的封装，我取名叫抬头feel的。

好，然后。

判断一下他到底是真有值还是说假有值，如果它不等于闹，假如说它确实是存在的没有问题，这个时候我就要抬头给它覆盖掉，我要从这个字段里把高亮显示的值取到抬头，feel的点get fragments。

 Fragment返回的是一个数组，有人说为什么是个树种？你想一下，我们抬头中匹配的词条有可能是多个，你比如说我们搜的是互联网寒冬，有可能 Title里既包含互联网又包含寒冬，甚至有可能包含了它两个互联网这个词，所以说对吧，所以匹配的可能是多个。

好，他如果匹配多段的话，我们这里设置这个title，我们要第几段，我们就要第一段就可以了，咱们不用每一段都都给它设置上去，只要第一段就可以了，所以我就get然后下标0取第一段，然后 to spin。

好，这样就行了。

同理，那么content也是做一样的处理，我把这个拷贝一下，只不过这个叫。

 contant。

这个叫compt feild。

费用的判断，

如果它不为空，那么我们就site content。然后从counting的field里取第零个值，然后 to，string这样就可以了。

好，到这儿我们实体类这些数据就处理好了，处理好以后别忘了把它放到集合里，类似的要艾特poss。

好。

这还没完，最终我们需要返回一个结果，当然这个结果里面应该包含集合中的数据，返回的它不是直接 list，它返回的结果里你看我们使用的时候既包含什么，一共有多少条数据，有多少页，当前页是几什么包含的数据比较复杂，是个聚合的数据，不只是一个集合，但是它包含这个集合，它返回的类型是什么？

是这个类型。

所以我们需要构造这个类型的，它是一个接口，我们要构造它的一个实现类，好了，那就构造我就在后面return这个类型，它的时效链是类型。

Apple我这里写了return。

你有 Angel。

然后当然这个时间内我们需要传好多个参数，这个参数的顺序你可以去看 repost的底层的源码去做一个参考，这里我就直接写了第一个传集合，第二个传方法的参数配置，apple把传进去，返回结果里。

好，然后再来我再换一行，下面的是his点get total his就一共多少条数据要传进去。然后是response点get要返回这个对象，具体说他到底要这个干什么我也不太清楚，反正他是这么写的，我也照着写了，具体没有细看。

然后是get scar ID，然后是get max4杠，总之它底层需要这些东西，我就把它把这些东西给他就完了，其他的就不用了。好了，终于我自己把这个数据处理好了，处理完以后咱们来试一下，好，我来执行一下这个方法。

好，你看这个结果还是111条数据，12页当前第零页每页10条没问题，然后后面是10条数据，然后每一条数据你看互联网前后是不是有这个标签的是吧？内容韩东强是不是有个标签的对吧？当然有人会发现说你这个内容不是完整的内容，完整的内容是很长的，你这怎么变短了？

因为就是说你的内容其实是一篇小的文章，可能有1000个字，而我与关键字匹配的可能有几部分，一部分两部分甚至多段，那么它返回的只会返回匹配的那一段前后有关的内容，它不会匹配所有的内容，你想你去百度搜东西不也是吗？你搜到的结果是一小段一个局部对吧？

你不是一整个一篇文章没必要，所以这一点 Bs也帮我们做了处理，它返回的结果里是匹配到的有关的那一段内容，而不是整个完整的数据，这是非常合理的。好了，那么这次课我们使用spring整合一s怎么去用？这些就演示完了，这些就够了。最主要的是最后的搜索，你要把它搞明白，尤其是如何构造搜索条件，如何去处理高亮的显示，至于说正常改数据就比较简单。好，那么这次课我们就演示到这里，咱们下次课再见。